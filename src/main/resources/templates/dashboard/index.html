<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie & Instagram Dashboard - Cine Mitr</title>
    
    <!-- Bootstrap CSS -->
    <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/webjars/font-awesome/6.4.0/css/all.min.css}" rel="stylesheet">
    <link th:href="@{/css/dark-theme.css}" rel="stylesheet">
    <link th:href="@{/css/form-fixes.css}" rel="stylesheet">
</head>
<body class="dark-theme">
    <!-- Main Dashboard Container -->
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="container-fluid">
                <div class="d-flex align-items-center justify-content-between py-3">
                    <div class="header-title">
                        <i class="fas fa-bars me-3"></i>
                        <h1 class="mb-0">Movie & Instagram Dashboard</h1>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="bulk-actions" style="display: none;" id="bulkActionsContainer">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="showBulkDeleteConfirmation()" id="bulkDeleteBtn" disabled>
                                <i class="fas fa-trash-alt me-2"></i>Delete Selected (<span id="selectedCount">0</span>)
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSelections()">
                                <i class="fas fa-times me-2"></i>Clear Selection
                            </button>
                        </div>
                        <div class="header-stats">
                            <span class="total-count" th:text="${totalLinksCount ?: 0}">0</span>
                            <small>Total Links</small>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Tab Navigation -->
                <div class="tab-navigation mb-4">
                    <button class="tab-btn active" data-tab="movies">
                        <i class="fas fa-database me-2"></i>Media Catalog
                    </button>
                    <button class="tab-btn" data-tab="content-status">
                        <i class="fas fa-list-alt me-2"></i>Content Catalog
                    </button>
                    <button class="tab-btn" data-tab="add-entry">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Upload Catalog
                    </button>
                    <button class="tab-btn" data-tab="states-catalog">
                        <i class="fas fa-chart-line me-2"></i>States Catalog
                    </button>
                    <button class="tab-btn" data-tab="dashboard">
                        <i class="fas fa-chart-bar me-2"></i>Dashboard
                    </button>
                </div>

                <!-- Flash Messages -->
                <div th:if="${success}" class="alert alert-success mb-4">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${success}"></span>
                </div>
                <div th:if="${error}" class="alert alert-danger mb-4">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}"></span>
                </div>

                <!-- Media Catalog Tab -->
                <div class="tab-content active" id="movies">
                    <div class="form-container">
                        <!-- Action Bar -->
                        <div class="action-bar mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="section-title mb-0">Media Catalog Management</h2>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary me-2" onclick="showAddMediaForm()">
                                        <i class="fas fa-plus me-2"></i>Add New Media
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="showUpdateMediaForm()">
                                        <i class="fas fa-edit me-2"></i>Update Existing
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="showBulkUploadModal('media')">
                                        <i class="fas fa-file-upload me-2"></i>Bulk Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleMediaSearch()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="refreshMediaTable()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar (Initially Hidden) -->
                        <div id="mediaSearchBar" class="search-bar mb-4" style="display: none;">
                            <div class="row mb-2">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="mediaSearchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="mediaSearchType">
                                        <option value="">All Types</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="mediaSearchStatus">
                                        <option value="">All Status</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="not-downloaded">Not Downloaded</option>
                                        <option value="partially-downloaded">Partially Downloaded</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="mediaSearchLanguage">
                                        <option value="">All Languages</option>
                                        <option value="English">English</option>
                                        <option value="Hindi">Hindi</option>
                                        <option value="Tamil">Tamil</option>
                                        <option value="Telugu">Telugu</option>
                                        <option value="Malayalam">Malayalam</option>
                                        <option value="Kannada">Kannada</option>
                                        <option value="Bengali">Bengali</option>
                                        <option value="Marathi">Marathi</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="mediaSearchMainGenre">
                                        <option value="">All Genres</option>
                                        <option value="Action">Action</option>
                                        <option value="Adventure">Adventure</option>
                                        <option value="Comedy">Comedy</option>
                                        <option value="Drama">Drama</option>
                                        <option value="Horror">Horror</option>
                                        <option value="Romance">Romance</option>
                                        <option value="Sci-Fi">Sci-Fi</option>
                                        <option value="Thriller">Thriller</option>
                                        <option value="Fantasy">Fantasy</option>
                                        <option value="Crime">Crime</option>
                                        <option value="Documentary">Documentary</option>
                                        <option value="Pop">Pop</option>
                                        <option value="Rock">Rock</option>
                                        <option value="Hip-Hop">Hip-Hop</option>
                                        <option value="Electronic">Electronic</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchMedia()" title="Search">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="mediaSearchSubGenres" placeholder="Search sub-genres (e.g., Superhero, Adventure)">
                                </div>
                                <div class="col-md-7">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Use the fields above to filter media by type, status, language, genre, and sub-genres. Leave blank to search all.
                                    </small>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearMediaFilters()" title="Clear All Filters">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add/Edit Form (Initially Hidden) -->
                        <div id="mediaFormContainer" style="display: none;">
                            <form th:action="@{/dashboard/media-catalog}" method="post" class="entry-form" id="mediaForm">
                                <input type="hidden" id="mediaCurrentTab" name="currentTab" value="">
                            <div class="form-group">
                                <label for="mediaName" class="form-label">Name</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="mediaName" 
                                       name="name"
                                       placeholder="Enter media name" 
                                       required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mediaType" class="form-label">Type</label>
                                    <select class="form-control" 
                                            id="mediaType" 
                                            name="type"
                                            required>
                                        <option value="">Select Type</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="platform" class="form-label">Platform</label>
                                    <select class="form-control" 
                                            id="platform"
                                            name="platform">
                                        <option value="">Select Platform</option>
                                        <option value="netflix">Netflix</option>
                                        <option value="amazon">Amazon Prime</option>
                                        <option value="zee5">ZEE5</option>
                                        <option value="youtube">YouTube</option>
                                        <option value="hotstar">Disney+ Hotstar</option>
                                        <option value="sony-liv">Sony LIV</option>
                                        <option value="voot">Voot</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="isDownloaded" class="form-label">Downloaded Status</label>
                                    <select class="form-control" 
                                            id="isDownloaded"
                                            name="downloadStatus">
                                        <option value="not-downloaded">Not Downloaded</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="partially-downloaded">Partially Downloaded</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="location" 
                                           name="location"
                                           placeholder="Storage location or file path">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="mediaDescription" class="form-label">Description</label>
                                <textarea class="form-control" 
                                          id="mediaDescription" 
                                          name="description"
                                          placeholder="Brief description of the media..."
                                          rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="funFacts" class="form-label">Fun Facts</label>
                                <textarea class="form-control" 
                                          id="funFacts" 
                                          name="funFacts"
                                          placeholder="Interesting facts or trivia about this media..."
                                          rows="3"></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="language" class="form-label">Language</label>
                                    <select class="form-control" 
                                            id="language" 
                                            name="language">
                                        <option value="">Select Language</option>
                                        <option value="english">English</option>
                                        <option value="hindi">Hindi</option>
                                        <option value="tamil">Tamil</option>
                                        <option value="telugu">Telugu</option>
                                        <option value="malayalam">Malayalam</option>
                                        <option value="kannada">Kannada</option>
                                        <option value="bengali">Bengali</option>
                                        <option value="marathi">Marathi</option>
                                        <option value="gujarati">Gujarati</option>
                                        <option value="punjabi">Punjabi</option>
                                        <option value="spanish">Spanish</option>
                                        <option value="french">French</option>
                                        <option value="german">German</option>
                                        <option value="italian">Italian</option>
                                        <option value="portuguese">Portuguese</option>
                                        <option value="russian">Russian</option>
                                        <option value="japanese">Japanese</option>
                                        <option value="korean">Korean</option>
                                        <option value="chinese">Chinese</option>
                                        <option value="arabic">Arabic</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="mainGenre" class="form-label">Main Genre</label>
                                    <select class="form-control" 
                                            id="mainGenre" 
                                            name="mainGenre">
                                        <option value="">Select Main Genre</option>
                                        <option value="action">Action</option>
                                        <option value="adventure">Adventure</option>
                                        <option value="comedy">Comedy</option>
                                        <option value="drama">Drama</option>
                                        <option value="horror">Horror</option>
                                        <option value="romance">Romance</option>
                                        <option value="sci-fi">Sci-Fi</option>
                                        <option value="thriller">Thriller</option>
                                        <option value="fantasy">Fantasy</option>
                                        <option value="crime">Crime</option>
                                        <option value="documentary">Documentary</option>
                                        <option value="biography">Biography</option>
                                        <option value="animation">Animation</option>
                                        <option value="musical">Musical</option>
                                        <option value="western">Western</option>
                                        <option value="pop">Pop</option>
                                        <option value="rock">Rock</option>
                                        <option value="hip-hop">Hip-Hop</option>
                                        <option value="electronic">Electronic</option>
                                        <option value="classical">Classical</option>
                                        <option value="jazz">Jazz</option>
                                        <option value="country">Country</option>
                                        <option value="r&b">R&B</option>
                                        <option value="folk">Folk</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="subGenres" class="form-label">Sub Genres</label>
                                <input type="text" class="form-control" 
                                       id="subGenres" 
                                       name="subGenres"
                                       placeholder="Enter sub-genres separated by commas...">
                            </div>

                            <div class="form-actions mt-3">
                                <button type="submit" class="btn-save me-2">
                                    <i class="fas fa-save me-2"></i>Save Media Entry
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="cancelMediaForm()">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </form>
                        </div>

                        <!-- Recent Records Section (Default View) -->
                        <div id="mediaRecordsContainer" class="recent-records-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="section-subtitle">Media Catalog Records</h4>
                                <a href="#" class="btn btn-sm btn-outline-primary" onclick="refreshRecentMedia()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </a>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm recent-records-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllMedia" class="form-check-input" onchange="toggleAllSelections('media')">
                                            </th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Platform</th>
                                            <th>Language</th>
                                            <th>Main Genre</th>
                                            <th>Status</th>
                                            <th>Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentMediaRecords">
                                        <tr th:each="media : ${recentMediaRecords}" th:if="${mediaStat.index < 10}">
                                            <td>
                                                <input type="checkbox" class="form-check-input media-checkbox" th:data-id="${media.id}" onchange="updateBulkActions()">
                                            </td>
                                            <td th:text="${media.name}">Sample Movie</td>
                                            <td><span class="badge bg-secondary" th:text="${media.type}">MOVIE</span></td>
                                            <td th:text="${media.platform}">Netflix</td>
                                            <td th:text="${media.language ?: 'N/A'}">English</td>
                                            <td>
                                                <span class="badge bg-primary" th:text="${media.mainGenre ?: 'N/A'}" 
                                                      th:title="${media.subGenres}">Action</span>
                                            </td>
                                            <td>
                                                <span class="badge" th:classappend="${media.downloadStatus == 'DOWNLOADED'} ? 'bg-success' : (${media.downloadStatus == 'NOT_DOWNLOADED'} ? 'bg-warning' : 'bg-info')"
                                                      th:text="${media.downloadStatus}">DOWNLOADED</span>
                                            </td>
                                            <td th:text="${#temporals.format(media.updatedOn, 'dd-MM HH:mm')}">24-08 14:30</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editMediaRecord(this)" 
                                                        th:data-id="${media.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMediaRecord(${media.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Content Catalog Tab -->
                <div class="tab-content" id="content-status">
                    <div class="form-container">
                        <!-- Action Bar -->
                        <div class="action-bar mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="section-title mb-0">Content Catalog Management</h2>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary me-2" onclick="showAddContentForm()">
                                        <i class="fas fa-plus me-2"></i>Add New Content
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="showUpdateContentForm()">
                                        <i class="fas fa-edit me-2"></i>Update Existing
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="showBulkUploadModal('content')">
                                        <i class="fas fa-file-upload me-2"></i>Bulk Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleContentSearch()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar (Initially Hidden) -->
                        <div id="contentSearchBar" class="search-bar mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="contentSearchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="contentSearchType">
                                        <option value="">All Types</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="contentSearchStatus">
                                        <option value="">All Status</option>
                                        <option value="new">New</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="error">Error</option>
                                        <option value="in-progress">In Progress</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="contentSearchPriority">
                                        <option value="">All Priority</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchContent()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearContentFilters()" title="Clear All Filters">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <form class="entry-form" action="/dashboard/content-catalog" method="post" id="contentCatalogForm" style="display: none;">
                            <input type="hidden" id="contentCurrentTab" name="currentTab" value="">
                            <div class="form-group">
                                <label for="contentLink" class="form-label">Link</label>
                                <input type="url" 
                                       class="form-control" 
                                       id="contentLink" 
                                       name="link"
                                       placeholder="Enter content URL or link" 
                                       required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mediaCatalogType" class="form-label">Media Catalog Type</label>
                                    <select class="form-control" 
                                            id="mediaCatalogType" 
                                            name="mediaCatalogType"
                                            required>
                                        <option value="">Select Type</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="mediaCatalogName" class="form-label">Media Catalog Names</label>
                                    <div class="multi-media-container">
                                        <!-- Selected Media Names Display -->
                                        <div id="selectedMediaNames" class="selected-media-names mb-2" style="display: none;">
                                            <small class="text-muted mb-1 d-block">Selected Media:</small>
                                            <div id="mediaNameTags" class="media-name-tags"></div>
                                        </div>
                                        
                                        <!-- Input for adding new media names -->
                                        <div class="position-relative">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="mediaCatalogNameInput" 
                                                   placeholder="Type to search or enter media name, then press Enter" 
                                                   autocomplete="off">
                                            <div id="mediaCatalogNameDropdown" class="dropdown-menu" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                                        </div>
                                        
                                        <!-- Hidden input to store the actual values -->
                                        <input type="hidden" 
                                               id="mediaCatalogName" 
                                               name="mediaCatalogName">
                                    </div>
                                    
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Type media names and press Enter to add multiple. You can search existing names or add new ones.
                                        <span id="multiMediaLoadingStatus" style="display: none;">
                                            <br><i class="fas fa-spinner fa-spin me-1"></i>Loading media catalog suggestions...
                                        </span>
                                    </small>
                                    
                                    <div id="mediaCatalogNameStatus" class="mt-1" style="display: none;">
                                        <small class="text-info">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <span id="statusMessage"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contentStatus" class="form-label">Status</label>
                                    <select class="form-control" 
                                            id="contentStatus" 
                                            name="status"
                                            required>
                                        <option value="">Select Status</option>
                                        <option value="new">New</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="error">Error</option>
                                        <option value="in-progress">In Progress</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="contentPriority" class="form-label">Priority</label>
                                    <select class="form-control" 
                                            id="contentPriority"
                                            name="priority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="contentLocation" class="form-label">Location</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="contentLocation" 
                                       name="location"
                                       placeholder="Storage location or file path">
                            </div>

                            <div class="form-group">
                                <label for="metadata" class="form-label">Metadata</label>
                                <textarea class="form-control" 
                                          id="metadata" 
                                          name="metadata"
                                          placeholder="Additional metadata information..."
                                          rows="3"></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="likeStates" class="form-label">Like States</label>
                                    <select class="form-control" 
                                            id="likeStates"
                                            name="likeStates">
                                        <option value="">Select Like State</option>
                                        <option value="liked">Liked</option>
                                        <option value="disliked">Disliked</option>
                                        <option value="neutral">Neutral</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="uploadContentStatus" class="form-label">Upload Content Status</label>
                                    <select class="form-control" 
                                            id="uploadContentStatus"
                                            name="uploadContentStatus">
                                        <option value="" selected>Default (null)</option>
                                        <option value="pending">Pending Upload</option>
                                        <option value="uploading">Uploading</option>
                                        <option value="uploaded">Uploaded</option>
                                        <option value="upload-failed">Upload Failed</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="commentStates" class="form-label">Comment States</label>
                                <textarea class="form-control" 
                                          id="commentStates" 
                                          name="commentStates"
                                          placeholder="Default (null) - Enter comments if needed..."
                                          rows="3"></textarea>
                            </div>
                            
                            <!-- New Enhanced Fields -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="localStatus" class="form-label">Local Status <i class="fas fa-hdd ms-1 text-info" title="Local availability status"></i></label>
                                    <select class="form-control" 
                                            id="localStatus"
                                            name="localStatus">
                                        <option value="" selected>Select Local Status...</option>
                                        <option value="available">Available</option>
                                        <option value="not-available">Not Available</option>
                                        <option value="partially-available">Partially Available</option>
                                        <option value="downloading">Downloading</option>
                                        <option value="processing">Processing</option>
                                        <option value="corrupted">Corrupted</option>
                                    </select>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Indicates whether the content is locally stored and accessible
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label for="locationPath" class="form-label">Location Path <i class="fas fa-folder-open ms-1 text-warning" title="Physical storage path"></i></label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="locationPath"
                                           name="locationPath"
                                           placeholder="e.g., /storage/media/movies/title-name/ or C:\Media\Movies\Title\"
                                           autocomplete="off">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Full file system path where the content is stored locally
                                    </small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="enhancedMetadata" class="form-label">Enhanced Metadata <i class="fas fa-tags ms-1 text-success" title="Detailed content information"></i></label>
                                <textarea class="form-control" 
                                          id="enhancedMetadata" 
                                          name="metadata"
                                          placeholder='{"quality": "1080p", "size": "2.5GB", "codec": "H.264", "audio": "AAC", "subtitles": ["en", "es"], "genre": "Action", "year": "2024", "duration": "120min", "rating": "8.5"}'
                                          rows="4"></textarea>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Detailed content metadata in JSON format (quality, size, codecs, subtitles, etc.)
                                </small>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary me-2" onclick="hideContentForm()">Cancel</button>
                                <button type="submit" class="btn-save">Save Content Catalog Entry</button>
                            </div>
                        </form>

                        <!-- Recent Records Section -->
                        <div class="recent-records-section mt-5">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="section-subtitle">Recent Content Records</h4>
                                <a href="#" class="btn btn-sm btn-outline-primary" onclick="refreshRecentContent()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </a>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm recent-records-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllContent" class="form-check-input" onchange="toggleAllSelections('content')">
                                            </th>
                                            <th>Media Name</th>
                                            <th>Link/Description</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Priority</th>
                                            <th>Local Status</th>
                                            <th>Location Path</th>
                                            <th>Metadata</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentContentRecords">
                                        <tr th:each="content : ${recentContentRecords}" th:if="${contentStat.index < 10}">
                                            <td>
                                                <input type="checkbox" class="form-check-input content-checkbox" th:data-id="${content.id}" onchange="updateBulkActions()">
                                            </td>
                                            <td th:text="${content.mediaCatalogName}">Sample Content</td>
                                            <td>
                                                <div class="content-link-cell">
                                                    <a th:if="${content.link != null and !#strings.isEmpty(content.link)}" 
                                                       th:href="${content.link}" 
                                                       th:text="${#strings.abbreviate(content.link, 40)}"
                                                       target="_blank"
                                                       class="text-decoration-none content-link"
                                                       th:title="${content.link}">
                                                        Sample Link
                                                    </a>
                                                    <span th:if="${content.link == null or #strings.isEmpty(content.link)}" 
                                                          class="text-muted">No link provided</span>
                                                </div>
                                            </td>
                                            <td><span class="badge bg-secondary" th:text="${content.mediaCatalogType}">MOVIE</span></td>
                                            <td>
                                                <span class="badge" 
                                                      th:class="${'badge ' + (content.status == 'DOWNLOADED' ? 'bg-success' : content.status == 'NEW' ? 'bg-info' : content.status == 'ERROR' ? 'bg-danger' : 'bg-warning')}"
                                                      th:text="${content.status}">NEW</span>
                                            </td>
                                            <td>
                                                <span class="badge" 
                                                      th:class="${'badge ' + (content.priority == 'HIGH' ? 'bg-danger' : content.priority == 'MEDIUM' ? 'bg-warning' : 'bg-secondary')}"
                                                      th:text="${content.priority}">MEDIUM</span>
                                            </td>
                                            <td th:text="${#temporals.format(content.createdOn, 'dd-MM HH:mm')}">24-08 14:30</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editContentRecord(this)" 
                                                        th:data-id="${content.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteContentRecord(${content.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Catalog Tab -->
                <div class="tab-content" id="add-entry">
                    <div class="form-container">
                        <!-- Action Bar -->
                        <div class="action-bar mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="section-title mb-0">Upload Catalog Management</h2>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary me-2" onclick="showAddUploadForm()">
                                        <i class="fas fa-plus me-2"></i>Add New Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="showUpdateUploadForm()">
                                        <i class="fas fa-edit me-2"></i>Update Existing
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="showBulkUploadModal('upload')">
                                        <i class="fas fa-file-upload me-2"></i>Bulk Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleUploadSearch()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="refreshUploadTable()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar (Initially Hidden) -->
                        <div id="uploadSearchBar" class="search-bar mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="uploadSearchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="uploadSearchType">
                                        <option value="">All Types</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="uploadSearchStatus">
                                        <option value="">All Status</option>
                                        <option value="new">New</option>
                                        <option value="ready-to-upload">Ready to Upload</option>
                                        <option value="completed">Completed</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="uploaded">Uploaded</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="uploadSearchLink" placeholder="Search by link...">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchUpload()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearUploadFilters()" title="Clear All Filters">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add/Edit Form (Initially Hidden) -->
                        <div id="uploadFormContainer" style="display: none;">
                        <form th:action="@{/dashboard/upload-catalog}" method="post" class="entry-form" id="uploadForm">
                            <input type="hidden" id="uploadCurrentTab" name="currentTab" value="">
                            <div class="form-group">
                                <label for="contentCatalogLink" class="form-label">Content Catalog Link / Description</label>
                                <textarea class="form-control" 
                                          id="contentCatalogLink" 
                                          name="contentCatalogLink"
                                          placeholder="Enter content catalog link or text description..." 
                                          rows="3"
                                          required></textarea>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        You can enter a URL link or any text description for the content catalog
                                    </small>
                                </div>
                            </div>

                            <!-- Media Catalog Fields (Moved Above Content ID) -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="uploadMediaCatalogType" class="form-label">Media Catalog Type</label>
                                    <select class="form-control" 
                                            id="uploadMediaCatalogType" 
                                            name="mediaCatalogType"
                                            required>
                                        <option value="">Select Type</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="uploadMediaCatalogName" class="form-label">Media Catalog Name</label>
                                    <div class="position-relative">
                                        <input type="text" 
                                               class="form-control" 
                                               id="uploadMediaCatalogName" 
                                               name="mediaCatalogName"
                                               placeholder="Type name or initials to search..." 
                                               autocomplete="off"
                                               required>
                                        <div id="uploadMediaCatalogNameDropdown" class="dropdown-menu"></div>
                                    </div>
                                    <div id="uploadMediaCatalogNameStatus" class="mt-1" style="display: none;">
                                        <small class="text-info"><span id="uploadStatusMessage"></span></small>
                                    </div>
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Search by full name or initials (e.g., "AB" for "Avengers Endgame")
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Linked Content Display (New Feature) -->
                            <div id="linkedContentSection" class="form-group" style="display: none;">
                                <label class="form-label">
                                    <i class="fas fa-link me-2"></i>Linked Content for Selected Media
                                </label>
                                
                                <!-- Add New Link Option -->
                                <div class="linked-content-add-section mb-3" style="display: none;" id="addLinkedContentSection">
                                    <div class="card card-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-plus me-2"></i>Add New Content Link
                                            </h6>
                                            <div class="form-group mb-3">
                                                <label for="newLinkedContentLink" class="form-label">Content Link (URL)</label>
                                                <input type="url" 
                                                       class="form-control" 
                                                       id="newLinkedContentLink"
                                                       placeholder="Enter content URL (e.g., https://example.com/content)"
                                                       autocomplete="off">
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="newLinkedContentDescription" class="form-label">Description (Optional)</label>
                                                <textarea class="form-control" 
                                                          id="newLinkedContentDescription"
                                                          rows="2"
                                                          placeholder="Brief description of this content..."></textarea>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button type="button" class="btn btn-success btn-sm" onclick="addNewLinkedContent()">
                                                    <i class="fas fa-plus me-1"></i>Add Content
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="hideAddLinkedContentForm()">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Existing Linked Content -->
                                <div id="linkedContentList" class="linked-content-container">
                                    <!-- Linked content will be populated here -->
                                </div>
                                
                                <!-- Controls -->
                                <div class="linked-content-controls mt-2" id="linkedContentControls" style="display: none;">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="showAddLinkedContentForm()">
                                        <i class="fas fa-plus me-1"></i>Add New Link
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshLinkedContent()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Content records matching the selected media catalog name and type. Click to select or add new links.
                                    </small>
                                </div>
                            </div>

                            <!-- Content ID Field (Moved Below Media Catalog) -->
                            <div class="form-group">
                                <label for="contentBlock" class="form-label">
                                    Content ID / Content Block 
                                    <span class="text-muted">(Optional)</span>
                                </label>
                                <div class="position-relative">
                                    <input type="text" 
                                           class="form-control" 
                                           id="contentBlock" 
                                           name="contentBlock"
                                           placeholder="Search by name or link from Content Catalog, or leave empty..." 
                                           autocomplete="off">
                                    <div id="contentBlockDropdown" class="dropdown-menu"></div>
                                </div>
                                <div id="contentBlockStatus" class="mt-1" style="display: none;">
                                    <small class="text-info"><span id="contentBlockMessage"></span></small>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Search by media name or content link. Creates new content entry if link not found. Leave empty to upload without linking.
                                    </small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contentCatalogLocation" class="form-label">Content Catalog Location</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="contentCatalogLocation" 
                                           name="contentCatalogLocation"
                                           placeholder="Content storage location">
                                </div>

                                <div class="form-group">
                                    <label for="uploadCatalogLocation" class="form-label">Upload Catalog Location</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="uploadCatalogLocation" 
                                           name="uploadCatalogLocation"
                                           placeholder="Upload destination location">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="uploadStatus" class="form-label">Upload Status</label>
                                <select class="form-control" 
                                        id="uploadStatus" 
                                        name="uploadStatus"
                                        required>
                                    <option value="">Select Status</option>
                                    <option value="new">New</option>
                                    <option value="ready-to-upload">Ready to Upload</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="uploaded">Uploaded</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="uploadCatalogCaption" class="form-label">Upload Catalog Caption</label>
                                <textarea class="form-control" 
                                          id="uploadCatalogCaption" 
                                          name="uploadCatalogCaption"
                                          placeholder="Enter caption for the upload catalog..."
                                          rows="4"></textarea>
                            </div>

                            <button type="submit" class="btn-save">
                                Save Upload Catalog Entry
                            </button>
                        </form>
                        </div>

                        <!-- Recent Records -->
                        <div id="uploadRecordsContainer" class="records-container">
                            <h3 class="records-title">Recent Upload Records</h3>
                            <div class="table-container">
                                <table class="records-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllUpload" class="form-check-input" onchange="toggleAllSelections('upload')">
                                            </th>
                                            <th>Content Block ID</th>
                                            <th>Content Link/Description</th>
                                            <th>Media Type</th>
                                            <th>Media Name</th>
                                            <th>Content Location</th>
                                            <th>Upload Location</th>
                                            <th>Upload Status</th>
                                            <th>Caption</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentUploadRecords">
                                        <!-- Upload records will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- States Catalog Tab -->
                <div class="tab-content" id="states-catalog">
                    <div class="form-container">
                        <!-- Action Bar -->
                        <div class="action-bar mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="section-title mb-0">States Catalog - User Analytics</h2>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary me-2" onclick="showAddStatesForm()">
                                        <i class="fas fa-plus me-2"></i>Add New Entry
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="showBulkUploadModal('states')">
                                        <i class="fas fa-file-upload me-2"></i>Bulk Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="showUpdateStatesForm()">
                                        <i class="fas fa-edit me-2"></i>Update Existing
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="refreshStatesTable()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- States Table Container -->
                        <div class="table-container mb-4" id="statesTableContainer">
                            <div class="table-header">
                                <h3 class="table-title">Analytics Records</h3>
                                <div class="table-controls">
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="showBulkDeleteConfirmation('states')" id="statesBulkDeleteBtn" disabled>
                                        <i class="fas fa-trash-alt me-2"></i>Delete Selected (<span id="statesSelectedCount">0</span>)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="data-table" id="statesTable">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="statesSelectAll" onchange="toggleAllStatesSelection()"></th>
                                            <th>ID</th>
                                            <th>Views</th>
                                            <th>Subscribers</th>
                                            <th>Interactions</th>
                                            <th>Reach</th>
                                            <th>Engagement Rate</th>
                                            <th>Followers Gained</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="statesTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Add/Edit Form (Initially Hidden) -->
                        <div id="statesFormContainer" style="display: none;">
                        <form th:action="@{/dashboard/states-catalog}" method="post" class="entry-form" id="statesForm">
                            <!-- Date Selection -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reportDate" class="form-label">Report Date</label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="reportDate" 
                                           name="reportDate">
                                    <small class="form-text text-muted">Select the date for this metrics report (allows backdate entries)</small>
                                </div>
                            </div>
                            
                            <!-- Basic Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="views" class="form-label">Views</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="views"
                                           name="views"
                                           placeholder="Total views count" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="subscribers" class="form-label">Subscribers</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="subscribers"
                                           name="subscribers"
                                           placeholder="Total subscribers" 
                                           min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="interactions" class="form-label">Interactions</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="interactions"
                                           name="interactions"
                                           placeholder="Total interactions" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="totalContent" class="form-label">Total Content</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="totalContent"
                                           name="totalContent"
                                           placeholder="Total content pieces" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Reach & Engagement Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reach" class="form-label">Reach</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="reach" 
                                           placeholder="Unique accounts reached" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="impressions" class="form-label">Impressions</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="impressions" 
                                           placeholder="Total views (including repeats)" 
                                           min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="profileVisits" class="form-label">Profile Visits</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="profileVisits" 
                                           placeholder="Profile visits count" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="websiteClicks" class="form-label">Website Clicks</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="websiteClicks" 
                                           placeholder="Website clicks count" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Contact Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emailClicks" class="form-label">Email Clicks</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="emailClicks" 
                                           placeholder="Email clicks count" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="callClicks" class="form-label">Call Clicks</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="callClicks" 
                                           placeholder="Call clicks count" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Growth Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="followersGained" class="form-label">Followers Gained</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="followersGained" 
                                           placeholder="New followers gained" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="followersLost" class="form-label">Followers Lost</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="followersLost" 
                                           placeholder="Followers lost" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Content-Specific Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reelsCount" class="form-label">Reels Count</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="reelsCount" 
                                           placeholder="Number of reels posted till date" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="storiesCount" class="form-label">Stories Count</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="storiesCount" 
                                           placeholder="Number of stories till date" 
                                           min="0">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="avgEngagementRate" class="form-label">Average Engagement Rate (%)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="avgEngagementRate" 
                                       placeholder="Average engagement rate (e.g., 5.25)" 
                                       step="0.01" 
                                       min="0" 
                                       max="100">
                            </div>

                            <div class="form-buttons">
                                <button type="submit" class="btn btn-success me-2" id="statesSaveBtn">
                                    <i class="fas fa-save me-2"></i>Save States Catalog Entry
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideStatesForm()">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div class="tab-content" id="dashboard">
                    <div class="dashboard-section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="section-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Comprehensive Analytics Dashboard
                            </h2>
                            <div class="dashboard-actions">
                                <button type="button" class="btn btn-outline-info btn-sm me-2" onclick="refreshDashboard()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="exportDashboardData()">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                                <span class="badge bg-secondary" id="lastUpdated">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Quick Stats Overview Cards -->
                        <div class="row mb-4" id="quickStatsCards">
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="dashboard-card stat-card">
                                    <div class="card-icon bg-primary">
                                        <i class="fas fa-database"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3 class="stat-number" id="totalRecordsCount">-</h3>
                                        <p class="stat-label">Total Records</p>
                                        <small class="stat-change" id="todaysActivity">+0 today</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="dashboard-card stat-card">
                                    <div class="card-icon bg-info">
                                        <i class="fas fa-film"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3 class="stat-number" id="mediaCatalogCount">-</h3>
                                        <p class="stat-label">Media Catalog</p>
                                        <small class="stat-change text-info">Movies, Albums, etc.</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="dashboard-card stat-card">
                                    <div class="card-icon bg-success">
                                        <i class="fas fa-folder-open"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3 class="stat-number" id="contentCatalogCount">-</h3>
                                        <p class="stat-label">Content Catalog</p>
                                        <small class="stat-change text-success">Download status</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="dashboard-card stat-card">
                                    <div class="card-icon bg-warning">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3 class="stat-number" id="uploadCatalogCount">-</h3>
                                        <p class="stat-label">Upload Catalog</p>
                                        <small class="stat-change text-warning">Upload status</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="dashboard-card stat-card">
                                    <div class="card-icon bg-secondary">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3 class="stat-number" id="statesCatalogCount">-</h3>
                                        <p class="stat-label">States Catalog</p>
                                        <small class="stat-change text-secondary">Analytics data</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="dashboard-card stat-card">
                                    <div class="card-icon bg-danger">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                    <div class="card-content">
                                        <h3 class="stat-number" id="completionRate">-%</h3>
                                        <p class="stat-label">Completion Rate</p>
                                        <small class="stat-change text-danger">Overall progress</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Distribution Charts Row -->
                        <div class="row mb-4">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="dashboard-card chart-card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-film me-2"></i>Media Types</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mini-chart-container">
                                            <div class="chart-item">
                                                <span class="chart-label">Movies</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-primary" id="moviesProgress"></div>
                                                </div>
                                                <span class="chart-value" id="moviesCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">Albums</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-success" id="albumsProgress"></div>
                                                </div>
                                                <span class="chart-value" id="albumsCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">Web Series</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-info" id="webSeriesProgress"></div>
                                                </div>
                                                <span class="chart-value" id="webSeriesCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">Documentaries</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-warning" id="documentariesProgress"></div>
                                                </div>
                                                <span class="chart-value" id="documentariesCount">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="dashboard-card chart-card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-download me-2"></i>Download Status</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mini-chart-container">
                                            <div class="chart-item">
                                                <span class="chart-label">Downloaded</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-success" id="downloadedProgress"></div>
                                                </div>
                                                <span class="chart-value" id="downloadedCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">New</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-info" id="newContentProgress"></div>
                                                </div>
                                                <span class="chart-value" id="newContentCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">In Progress</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-warning" id="inProgressContentProgress"></div>
                                                </div>
                                                <span class="chart-value" id="inProgressContentCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">Error</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-danger" id="errorContentProgress"></div>
                                                </div>
                                                <span class="chart-value" id="errorContentCount">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="dashboard-card chart-card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Status</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mini-chart-container">
                                            <div class="chart-item">
                                                <span class="chart-label">Uploaded</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-success" id="uploadedProgress"></div>
                                                </div>
                                                <span class="chart-value" id="uploadedCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">Ready to Upload</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-primary" id="readyToUploadProgress"></div>
                                                </div>
                                                <span class="chart-value" id="readyToUploadCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">In Progress</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-warning" id="inProgressUploadProgress"></div>
                                                </div>
                                                <span class="chart-value" id="inProgressUploadCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">New</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-info" id="newUploadProgress"></div>
                                                </div>
                                                <span class="chart-value" id="newUploadCount">0</span>
                                            </div>
                                            <div class="chart-item">
                                                <span class="chart-label">Completed</span>
                                                <div class="progress-mini">
                                                    <div class="progress-bar bg-secondary" id="completedUploadProgress"></div>
                                                </div>
                                                <span class="chart-value" id="completedUploadCount">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="dashboard-card chart-card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>System Health</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="health-indicators">
                                            <div class="health-item">
                                                <span class="health-indicator bg-success"></span>
                                                <span class="health-label">Database</span>
                                                <span class="health-status" id="dbStatus">Online</span>
                                            </div>
                                            <div class="health-item">
                                                <span class="health-indicator bg-info"></span>
                                                <span class="health-label">Storage</span>
                                                <span class="health-status" id="storageStatus">Available</span>
                                            </div>
                                            <div class="health-item">
                                                <span class="health-indicator bg-warning"></span>
                                                <span class="health-label">API</span>
                                                <span class="health-status" id="apiStatus">< 100ms</span>
                                            </div>
                                            <div class="health-item">
                                                <span class="health-indicator bg-primary"></span>
                                                <span class="health-label">Uptime</span>
                                                <span class="health-status" id="uptimeStatus">99.9%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Data Overview Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="dashboard-card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-search me-2"></i>Global Data Search & Filter</h5>
                                        <div class="search-controls">
                                            <select class="form-select form-select-sm me-2" id="globalSearchCategory" style="width: auto; display: inline-block;">
                                                <option value="">All Categories</option>
                                                <option value="media">Media Catalog</option>
                                                <option value="content">Content Catalog</option>
                                                <option value="upload">Upload Catalog</option>
                                                <option value="states">States Catalog</option>
                                            </select>
                                            <select class="form-select form-select-sm me-2" id="globalSearchStatus" style="width: auto; display: inline-block;">
                                                <option value="">All Status</option>
                                                <option value="new">New</option>
                                                <option value="downloaded">Downloaded</option>
                                                <option value="uploaded">Uploaded</option>
                                                <option value="ready-to-upload">Ready to Upload</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                                <option value="error">Error</option>
                                            </select>
                                            <input type="text" class="form-control form-control-sm me-2" id="globalSearchInput" placeholder="Search across all data..." style="width: 300px; display: inline-block;">
                                            <button class="btn btn-primary btn-sm" onclick="performGlobalSearch()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="clearGlobalSearch()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="globalSearchResults">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-search fa-3x mb-3"></i>
                                                <p>Use the search controls above to find data across all catalogs</p>
                                                <p class="small">Search supports: Media names, content links, upload status, file paths, descriptions, and more</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity Summary -->
                        <div class="row mb-4">
                            <div class="col-lg-6 col-12 mb-3">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity (Last 24h)</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="activity-list" id="recentActivityList">
                                            <div class="activity-item">
                                                <div class="activity-icon bg-primary">
                                                    <i class="fas fa-plus"></i>
                                                </div>
                                                <div class="activity-content">
                                                    <span class="activity-title">Loading recent activity...</span>
                                                    <span class="activity-time">-</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <button class="btn btn-outline-primary btn-sm" onclick="loadRecentActivity()">
                                                <i class="fas fa-refresh me-1"></i>Refresh Activity
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6 col-12 mb-3">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>System Alerts & Issues</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="alerts-list" id="systemAlertsList">
                                            <div class="alert-item">
                                                <div class="alert-icon bg-success">
                                                    <i class="fas fa-check"></i>
                                                </div>
                                                <div class="alert-content">
                                                    <span class="alert-title">All systems operational</span>
                                                    <span class="alert-desc">No critical issues detected</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions Dashboard -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions & Insights</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-lg-3 col-md-6 mb-3">
                                                <div class="quick-action-card" onclick="switchTab('movies')">
                                                    <div class="qa-icon bg-info">
                                                        <i class="fas fa-film"></i>
                                                    </div>
                                                    <div class="qa-content">
                                                        <h6>Manage Media</h6>
                                                        <p>Add/Edit media catalog entries</p>
                                                        <span class="qa-count" id="qaMediaCount">- items</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6 mb-3">
                                                <div class="quick-action-card" onclick="switchTab('content-status')">
                                                    <div class="qa-icon bg-success">
                                                        <i class="fas fa-download"></i>
                                                    </div>
                                                    <div class="qa-content">
                                                        <h6>Content Status</h6>
                                                        <p>Track download progress</p>
                                                        <span class="qa-count" id="qaContentCount">- items</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6 mb-3">
                                                <div class="quick-action-card" onclick="switchTab('add-entry')">
                                                    <div class="qa-icon bg-warning">
                                                        <i class="fas fa-cloud-upload-alt"></i>
                                                    </div>
                                                    <div class="qa-content">
                                                        <h6>Upload Queue</h6>
                                                        <p>Manage upload catalog</p>
                                                        <span class="qa-count" id="qaUploadCount">- items</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6 mb-3">
                                                <div class="quick-action-card" onclick="switchTab('states-catalog')">
                                                    <div class="qa-icon bg-secondary">
                                                        <i class="fas fa-chart-line"></i>
                                                    </div>
                                                    <div class="qa-content">
                                                        <h6>Analytics</h6>
                                                        <p>View user engagement data</p>
                                                        <span class="qa-count" id="qaStatesCount">- items</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                            </table>

                            <!-- Empty State -->
                            <div th:unless="${activeLinks}" class="empty-state">
                                <i class="fab fa-instagram"></i>
                                <h3>No Instagram links added yet</h3>
                                <p>Start by adding your first movie Instagram link!</p>
                                <button class="btn-add-first" onclick="showAddEntry()">
                                    <i class="fas fa-plus me-2"></i>Add Your First Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Instagram Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm" method="post">
                        <div class="form-group">
                            <label for="editInstagramLink" class="form-label">Instagram Link</label>
                            <input type="url" class="form-control" id="editInstagramLink" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMovieName" class="form-label">Movie Name</label>
                                <input type="text" class="form-control" id="editMovieName" required>
                            </div>
                            <div class="form-group">
                                <label for="editCategory" class="form-label">Category</label>
                                <select class="form-control" id="editCategory" required>
                                    <option th:each="cat : ${predefinedCategories}" 
                                            th:value="${cat}" 
                                            th:text="${cat}">Category</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="editForm" class="btn-save">Update Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Upload Modal -->
    <div class="modal fade" id="editUploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Upload Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUploadForm" method="post">
                        <div class="form-group">
                            <label for="editContentCatalogLink" class="form-label">Content Catalog Link / Description</label>
                            <textarea class="form-control" 
                                      id="editContentCatalogLink" 
                                      name="contentCatalogLink"
                                      placeholder="Enter content catalog link or text description..." 
                                      rows="3"
                                      required></textarea>
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    You can enter a URL link or any text description for the content catalog
                                </small>
                            </div>
                        </div>

                        <!-- Media Catalog Fields -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMediaCatalogType" class="form-label">Media Catalog Type</label>
                                <select class="form-control" 
                                        id="editMediaCatalogType" 
                                        name="mediaCatalogType"
                                        required>
                                    <option value="">Select Type</option>
                                    <option value="movie">Movie</option>
                                    <option value="album">Album</option>
                                    <option value="web-series">Web Series</option>
                                    <option value="documentary">Documentary</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="editMediaCatalogName" class="form-label">Media Catalog Name</label>
                                <div class="position-relative">
                                    <input type="text" 
                                           class="form-control" 
                                           id="editMediaCatalogName" 
                                           name="mediaCatalogName"
                                           placeholder="Type name or initials to search..." 
                                           autocomplete="off"
                                           required>
                                    <div id="editMediaCatalogDropdown" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Search by full name or initials (e.g., "AB" for "Avengers Endgame")
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Content ID Field -->
                        <div class="form-group">
                            <label for="editContentBlock" class="form-label">
                                Content ID / Content Block 
                                <span class="text-muted">(Optional)</span>
                            </label>
                            <div class="position-relative">
                                <input type="text" 
                                       class="form-control" 
                                       id="editContentBlock" 
                                       name="contentBlock"
                                       placeholder="Type to search from Content Catalog or leave empty..." 
                                       autocomplete="off">
                                <div id="editContentBlockDropdown" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    You can leave this empty to upload without linking to specific content
                                </small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editContentCatalogLocation" class="form-label">Content Catalog Location</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="editContentCatalogLocation" 
                                       name="contentCatalogLocation"
                                       placeholder="Content storage location">
                            </div>

                            <div class="form-group">
                                <label for="editUploadCatalogLocation" class="form-label">Upload Catalog Location</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="editUploadCatalogLocation" 
                                       name="uploadCatalogLocation"
                                       placeholder="Upload destination location">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editUploadStatus" class="form-label">Upload Status</label>
                            <select class="form-control" 
                                    id="editUploadStatus" 
                                    name="uploadStatus"
                                    required>
                                <option value="">Select Status</option>
                                <option value="new">New</option>
                                <option value="ready-to-upload">Ready to Upload</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="uploaded">Uploaded</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editUploadCatalogCaption" class="form-label">Upload Catalog Caption</label>
                            <textarea class="form-control" 
                                      id="editUploadCatalogCaption" 
                                      name="uploadCatalogCaption"
                                      placeholder="Enter caption for the upload catalog..."
                                      rows="4"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="editUploadForm" class="btn-save">Update Upload Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div class="modal fade" id="bulkUploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkUploadModalTitle">Bulk Upload</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-file-download me-2 text-primary"></i>Download Templates
                            </h6>
                            <div class="template-downloads mb-4">
                                <p class="text-muted mb-3">Download template files to see the required format:</p>
                                <div class="btn-group-vertical w-100" id="templateDownloadButtons">
                                    <!-- Template download buttons will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-file-upload me-2 text-success"></i>Upload File
                            </h6>
                            <form id="bulkUploadForm" method="post" enctype="multipart/form-data">
                                <div class="form-group mb-3">
                                    <label for="bulkUploadFile" class="form-label">Select File</label>
                                    <input type="file" 
                                           class="form-control" 
                                           id="bulkUploadFile" 
                                           name="file" 
                                           accept=".csv,.xlsx,.xls,.json" 
                                           required>
                                    <div class="form-text">
                                        Supported formats: CSV, Excel (.xlsx/.xls), JSON
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Important:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Make sure your file follows the template format exactly</li>
                                            <li>For Content Catalog uploads, linked Upload records will be created automatically</li>
                                            <li>Invalid rows will be skipped and reported in the results</li>
                                            <li>Large files may take a few moments to process</li>
                                        </ul>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%">
                                Processing...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="bulkUploadForm" class="btn-save">
                        <i class="fas fa-upload me-2"></i>Upload & Process
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Cleanup Confirmation Modal -->
    <div class="modal fade" id="cleanupConfirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirm Database Cleanup
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-warning me-2"></i>
                        <strong>Warning:</strong> This action is irreversible!
                    </div>
                    <p><strong>This will permanently delete ALL data from:</strong></p>
                    <ul>
                        <li>📄 All Content Catalog entries</li>
                        <li>📤 All Upload Catalog entries</li>
                        <li>🎬 All Media Catalog entries</li>
                        <li>🔗 All linked relationships between records</li>
                    </ul>
                    <p class="mt-3"><strong>Are you sure you want to proceed?</strong></p>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="confirmCleanup">
                        <label class="form-check-label" for="confirmCleanup">
                            I understand this will delete all data and cannot be undone
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <form id="cleanupForm" method="post" action="/dashboard/cleanup-database" style="display: inline;">
                        <button type="submit" class="btn btn-danger" id="confirmCleanupBtn" disabled>
                            <i class="fas fa-trash-alt me-2"></i>Yes, Clean Database
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/dashboard.js}"></script>

    <script>
        // Tab switching functionality
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Update active button
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Track click function
        function trackClick(linkId) {
            fetch('/dashboard/link/' + linkId + '/click', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
            }).then(response => response.text())
              .then(data => console.log('Click tracked:', data))
              .catch(error => console.error('Error tracking click:', error));
        }

        // Show add entry tab
        function showAddEntry() {
            document.querySelector('[data-tab="add-entry"]').click();
        }

        // Edit link functionality
        function editLink(button) {
            const id = button.getAttribute('data-id');
            const movie = button.getAttribute('data-movie');
            const category = button.getAttribute('data-category');
            const link = button.getAttribute('data-link');
            const description = button.getAttribute('data-description');

            document.getElementById('editMovieName').value = movie;
            document.getElementById('editCategory').value = category;
            document.getElementById('editInstagramLink').value = link;
            document.getElementById('editDescription').value = description || '';
            
            document.getElementById('editForm').action = '/dashboard/link/' + id + '/edit';
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // Helper function to get current active tab
        function getCurrentActiveTab() {
            // First check URL parameters (most reliable)
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam) return tabParam;
            
            // Check active tab element
            const activeTab = document.querySelector('.nav-pills .nav-link.active');
            if (activeTab) {
                // Extract tab name from the href or data attribute
                const href = activeTab.getAttribute('href') || activeTab.getAttribute('data-bs-target');
                if (href) {
                    if (href.includes('movies')) return 'movies';
                    if (href.includes('content-status')) return 'content-status';
                    if (href.includes('add-entry')) return 'add-entry';
                    if (href.includes('states')) return 'states-catalog';
                }
                
                // Check aria-controls attribute (Bootstrap 5 specific)
                const ariaControls = activeTab.getAttribute('aria-controls');
                if (ariaControls) {
                    return ariaControls;
                }
            }
            
            // Check which tab pane is currently active/visible
            const activePane = document.querySelector('.tab-content .tab-pane.active') || 
                               document.querySelector('.tab-content .active') ||
                               document.querySelector('.tab-content [style*="display: block"]');
            if (activePane) {
                return activePane.id;
            }
            
            // Default fallback
            return 'movies';
        }

        // Media Catalog Functions
        function showAddMediaForm() {
            // Hide records container and show form
            document.getElementById('mediaRecordsContainer').style.display = 'none';
            document.getElementById('mediaFormContainer').style.display = 'block';
            
            // Set current tab
            const currentTab = getCurrentActiveTab();
            document.getElementById('mediaCurrentTab').value = currentTab;
            
            // Clear form for new entry
            document.getElementById('mediaForm').reset();
            
            // Update form title and button
            document.querySelector('#mediaFormContainer h3')?.remove();
            const title = document.createElement('h3');
            title.className = 'section-subtitle mb-3';
            title.innerHTML = '<i class="fas fa-plus me-2"></i>Add New Media';
            document.getElementById('mediaFormContainer').insertBefore(title, document.getElementById('mediaForm'));
            
            // Scroll to form
            document.getElementById('mediaFormContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function showUpdateMediaForm() {
            alert('Click the edit button (✏️) next to any record in the table below to update it.');
        }

        function cancelMediaForm() {
            // Hide form and show records
            document.getElementById('mediaFormContainer').style.display = 'none';
            document.getElementById('mediaRecordsContainer').style.display = 'block';
        }

        function toggleMediaSearch() {
            const searchBar = document.getElementById('mediaSearchBar');
            if (searchBar.style.display === 'none') {
                searchBar.style.display = 'block';
            } else {
                searchBar.style.display = 'none';
            }
        }

        function searchMedia() {
            const name = document.getElementById('mediaSearchName').value;
            const type = document.getElementById('mediaSearchType').value;
            const status = document.getElementById('mediaSearchStatus').value;
            const language = document.getElementById('mediaSearchLanguage')?.value || '';
            const mainGenre = document.getElementById('mediaSearchMainGenre')?.value || '';
            const subGenres = document.getElementById('mediaSearchSubGenres')?.value || '';
            
            console.log('Media search params:', { name, type, status, language, mainGenre, subGenres });
            
            // Call API or refresh page with search parameters
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (type) params.append('type', type);
            if (status) params.append('status', status);
            if (language) params.append('language', language);
            if (mainGenre) params.append('mainGenre', mainGenre);
            if (subGenres) params.append('subGenres', subGenres);
            
            const url = `/api/media-catalog/search?${params.toString()}`;
            console.log('Media search URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Media search response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Media search results:', data);
                    // Update the recent records table with search results
                    updateMediaRecordsTable(data);
                })
                .catch(error => {
                    console.error('Media search error:', error);
                    updateMediaRecordsTable([]);
                });
        }

        function clearMediaFilters() {
            // Clear all input fields
            document.getElementById('mediaSearchName').value = '';
            document.getElementById('mediaSearchType').value = '';
            document.getElementById('mediaSearchStatus').value = '';
            if (document.getElementById('mediaSearchLanguage')) document.getElementById('mediaSearchLanguage').value = '';
            if (document.getElementById('mediaSearchMainGenre')) document.getElementById('mediaSearchMainGenre').value = '';
            if (document.getElementById('mediaSearchSubGenres')) document.getElementById('mediaSearchSubGenres').value = '';
            
            // Refresh to show all results
            refreshRecentMedia();
            
            console.log('Media filters cleared - showing all results');
        }

        function refreshRecentMedia() {
            fetch('/api/media-catalog?limit=10&sort=updatedOn:desc')
                .then(response => response.json())
                .then(data => updateMediaRecordsTable(data))
                .catch(error => console.error('Error:', error));
        }

        function editMediaRecord(button) {
            const id = button.getAttribute('data-id');
            
            // Hide records container and show form
            document.getElementById('mediaRecordsContainer').style.display = 'none';
            document.getElementById('mediaFormContainer').style.display = 'block';
            
            // Update form title for editing
            document.querySelector('#mediaFormContainer h3')?.remove();
            const title = document.createElement('h3');
            title.className = 'section-subtitle mb-3';
            title.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Media Record';
            document.getElementById('mediaFormContainer').insertBefore(title, document.getElementById('mediaForm'));
            
            // Add hidden field for ID (for update)
            let idField = document.getElementById('mediaId');
            if (!idField) {
                idField = document.createElement('input');
                idField.type = 'hidden';
                idField.id = 'mediaId';
                idField.name = 'id';
                document.getElementById('mediaForm').appendChild(idField);
            }
            idField.value = id;
            
            // Fetch media details and populate form
            fetch(`/api/media-catalog/${id}`)
                .then(response => response.json())
                .then(data => {
                    // Populate form fields with data
                    document.getElementById('mediaName').value = data.name || '';
                    document.getElementById('mediaType').value = data.type ? data.type.toLowerCase().replace('_', '-') : '';
                    document.getElementById('platform').value = data.platform || '';
                    document.getElementById('isDownloaded').value = data.downloadStatus ? data.downloadStatus.toLowerCase().replace('_', '-') : '';
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('mediaDescription').value = data.description || '';
                    document.getElementById('funFacts').value = data.funFacts || '';
                    document.getElementById('language').value = data.language || '';
                    document.getElementById('mainGenre').value = data.mainGenre || '';
                    document.getElementById('subGenres').value = data.subGenres || '';
                    
                    // Update form action for update
                    document.getElementById('mediaForm').action = `/dashboard/media-catalog/${id}/edit`;
                    
                    // Scroll to form
                    document.getElementById('mediaFormContainer').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error loading media record', 'error');
                });
        }

        function deleteMediaRecord(id) {
            if (confirm('Are you sure you want to delete this media record?')) {
                fetch(`/api/media-catalog/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            refreshRecentMedia();
                            showNotification('Media record deleted successfully', 'success');
                        } else {
                            showNotification('Error deleting media record', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error deleting media record', 'error');
                    });
            }
        }

        // Content Catalog Functions
        function showAddContentForm() {
            hideRecentRecordsSections();
            const form = document.getElementById('contentCatalogForm');
            if (!form) {
                console.error('Content catalog form not found');
                return;
            }
            
            // Set current tab
            const currentTab = getCurrentActiveTab();
            document.getElementById('contentCurrentTab').value = currentTab;
            
            form.style.display = 'block';
            form.reset();
            
            // Reset multi-media functionality for add mode
            resetMultiMediaForm();
            
            // Initialize after form is visible and DOM is ready
            setTimeout(() => {
                const input = document.getElementById('mediaCatalogNameInput');
                if (input) {
                    initializeMediaCatalogNameAutocomplete();
                    console.log('Multi-media functionality initialized');
                } else {
                    console.error('Media catalog input not found, form may not be properly structured');
                }
            }, 150);
            
            form.scrollIntoView({ behavior: 'smooth' });
        }

        function hideContentForm() {
            const form = document.getElementById('contentCatalogForm');
            form.style.display = 'none';
            
            // Reset form to add mode
            form.action = '/dashboard/content-catalog';
            form.reset();
            
            // Reset multi-media functionality
            resetMultiMediaForm();
            
            // Reset button text
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Save Content Catalog Entry';
            }
            
            // Clear status message
            clearStatusMessage();
            
            showRecentRecordsSections();
        }

        function showUpdateContentForm() {
            alert('Select a content record from Recent Records below to update');
        }

        function toggleContentSearch() {
            const searchBar = document.getElementById('contentSearchBar');
            searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
        }

        function searchContent() {
            const name = document.getElementById('contentSearchName').value;
            const type = document.getElementById('contentSearchType').value;
            const status = document.getElementById('contentSearchStatus').value;
            const priority = document.getElementById('contentSearchPriority').value;
            
            console.log('Content search params:', { name, type, status, priority });
            
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (type) params.append('type', type);
            if (status) params.append('status', status);
            if (priority) params.append('priority', priority);
            
            const url = `/api/content-catalog/search?${params.toString()}`;
            console.log('Content search URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Content search response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Content search results:', data);
                    updateContentRecordsTable(data);
                })
                .catch(error => {
                    console.error('Content search error:', error);
                    updateContentRecordsTable([]);
                });
        }

        function clearContentFilters() {
            // Clear all input fields
            document.getElementById('contentSearchName').value = '';
            document.getElementById('contentSearchType').value = '';
            document.getElementById('contentSearchStatus').value = '';
            document.getElementById('contentSearchPriority').value = '';
            
            // Refresh to show all results
            refreshRecentContent();
            
            console.log('Content filters cleared - showing all results');
        }

        function refreshRecentContent() {
            fetch('/api/content-catalog')
                .then(response => response.json())
                .then(data => {
                    // Sort by createdOn descending and take first 10
                    const sortedData = data.sort((a, b) => new Date(b.createdOn) - new Date(a.createdOn)).slice(0, 10);
                    updateContentRecordsTable(sortedData);
                })
                .catch(error => console.error('Error loading content records:', error));
        }

        function editContentRecord(button) {
            const id = button.getAttribute('data-id');
            
            // Fetch the content record data
            fetch(`/api/content-catalog/${id}`)
                .then(response => response.json())
                .then(content => {
                    // Show the form
                    showAddContentForm();
                    
                    // Populate form fields with existing data
                    document.getElementById('contentLink').value = content.link || '';
                    document.getElementById('mediaCatalogType').value = content.mediaCatalogType?.toLowerCase().replace('_', '-') || '';
                    
                    // Handle multiple media catalog names
                    if (content.mediaCatalogName) {
                        const mediaNames = content.mediaCatalogName.split(',');
                        selectedMediaNames = mediaNames.map(name => name.trim()).filter(name => name !== '');
                        updateMediaNameTags();
                        updateHiddenInput();
                        
                        // Show selected names container if there are names
                        if (selectedMediaNames.length > 0) {
                            const container = document.getElementById('selectedMediaNames');
                            if (container) {
                                container.style.display = 'block';
                            }
                        }
                    }
                    
                    document.getElementById('contentStatus').value = content.status?.toLowerCase().replace('_', '-') || '';
                    document.getElementById('contentPriority').value = content.priority?.toLowerCase() || 'medium';
                    document.getElementById('contentLocation').value = content.location || '';
                    document.getElementById('metadata').value = content.metadata || '';
                    document.getElementById('likeStates').value = content.likeStates?.toLowerCase() || '';
                    document.getElementById('commentStates').value = content.commentStates || '';
                    document.getElementById('uploadContentStatus').value = content.uploadContentStatus?.toLowerCase().replace('_', '-') || '';
                    
                    // New enhanced fields
                    document.getElementById('localStatus').value = content.localStatus?.toLowerCase().replace('_', '-') || '';
                    document.getElementById('locationPath').value = content.locationPath || '';
                    document.getElementById('enhancedMetadata').value = content.metadata || '';
                    
                    // Update form to edit mode
                    const form = document.getElementById('contentCatalogForm');
                    form.action = `/dashboard/content-catalog/${id}/edit`;
                    
                    // Update button text
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.textContent = 'Update Content Catalog Entry';
                    }
                    
                    // Update status message
                    updateStatusMessage(`Editing: "${content.mediaCatalogName}"`, 'info');
                    
                    showNotification(`Loaded content record for editing: ${content.mediaCatalogName}`, 'info');
                })
                .catch(error => {
                    console.error('Error loading content record:', error);
                    showNotification('Error loading content record for editing', 'danger');
                });
        }

        function deleteContentRecord(id) {
            if (confirm('Are you sure you want to delete this content record?')) {
                fetch(`/api/content-catalog/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            refreshRecentContent();
                            showNotification('Content record deleted successfully', 'success');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // Upload Catalog Functions
        function showAddUploadForm() {
            // Hide records container and show form
            document.getElementById('uploadRecordsContainer').style.display = 'none';
            document.getElementById('uploadFormContainer').style.display = 'block';
            
            // Set current tab
            const currentTab = getCurrentActiveTab();
            console.log('Upload form - detected current tab:', currentTab);
            document.getElementById('uploadCurrentTab').value = currentTab;
            
            // Reset form
            const form = document.getElementById('uploadForm');
            if (form) {
                const tabValue = document.getElementById('uploadCurrentTab').value; // Save tab value
                form.reset();
                document.getElementById('uploadCurrentTab').value = tabValue; // Restore tab value
                form.action = '/dashboard/upload-catalog'; // Reset to create mode
                
                // Update button text
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = 'Save Upload Catalog Entry';
                }
                
                // Clear status message
                const statusDiv = document.getElementById('uploadMediaCatalogNameStatus');
                if (statusDiv) statusDiv.style.display = 'none';
                
                form.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Initialize media catalog name autocomplete for upload form
            setupUploadMediaCatalogAutocomplete();
            
            // Initialize content block autocomplete
            setupContentBlockAutocomplete();
            
            // Setup auto-resize for content catalog link textarea
            setupTextareaAutoResize();
        }

        function hideUploadForm() {
            document.getElementById('uploadFormContainer').style.display = 'none';
            document.getElementById('uploadRecordsContainer').style.display = 'block';
        }

        function showUpdateUploadForm() {
            alert('Select an upload record from Recent Records below to update');
        }

        function toggleUploadSearch() {
            const searchBar = document.getElementById('uploadSearchBar');
            if (searchBar) {
                searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
            }
        }

        function searchUpload() {
            const name = document.getElementById('uploadSearchName')?.value || '';
            const type = document.getElementById('uploadSearchType')?.value || '';
            const status = document.getElementById('uploadSearchStatus')?.value || '';
            const link = document.getElementById('uploadSearchLink')?.value || '';
            
            console.log('Upload search params:', { name, type, status, link });
            
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (type) params.append('type', type);
            if (status) params.append('status', status);
            if (link) params.append('link', link);
            
            const url = `/api/upload-catalog/search?${params.toString()}`;
            console.log('Upload search URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('Upload search response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Upload search results:', data);
                    updateUploadRecordsTable(data);
                })
                .catch(error => {
                    console.error('Upload search error:', error);
                    updateUploadRecordsTable([]);
                });
        }

        function clearUploadFilters() {
            // Clear all input fields
            document.getElementById('uploadSearchName').value = '';
            document.getElementById('uploadSearchType').value = '';
            document.getElementById('uploadSearchStatus').value = '';
            document.getElementById('uploadSearchLink').value = '';
            
            // Refresh to show all results
            refreshRecentUpload();
            
            console.log('Upload filters cleared - showing all results');
        }

        function refreshRecentUpload() {
            showUploadRecordsLoading();
            fetch('/api/upload-catalog')
                .then(response => response.json())
                .then(data => {
                    // Sort by createdOn descending and take first 10
                    const sortedData = data.sort((a, b) => new Date(b.createdOn) - new Date(a.createdOn)).slice(0, 10);
                    updateUploadRecordsTable(sortedData);
                })
                .catch(error => {
                    console.error('Error loading upload records:', error);
                    const tbody = document.getElementById('recentUploadRecords');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr class="empty-state">
                                <td colspan="7">
                                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                    Error loading upload records. Please try again.
                                </td>
                            </tr>
                        `;
                    }
                });
        }

        function editUploadRecord(button) {
            const id = button.getAttribute('data-id');
            
            // Get upload record data from API
            fetch(`/api/upload-catalog/${id}`)
                .then(response => response.json())
                .then(upload => {
                    // Populate modal form with current data
                    const fields = {
                        'editContentCatalogLink': upload.contentCatalogLink || '',
                        'editContentBlock': upload.contentBlock || '',
                        'editMediaCatalogName': upload.mediaCatalogName || '',
                        'editMediaCatalogType': upload.mediaCatalogType ? upload.mediaCatalogType.toLowerCase().replace('_', '-') : '',
                        'editContentCatalogLocation': upload.contentCatalogLocation || '',
                        'editUploadCatalogLocation': upload.uploadCatalogLocation || '',
                        'editUploadStatus': upload.uploadStatus ? upload.uploadStatus.toLowerCase().replace('_', '-') : '',
                        'editUploadCatalogCaption': upload.uploadCatalogCaption || ''
                    };
                    
                    // Set values and apply styling fixes
                    Object.keys(fields).forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = fields[fieldId];
                            // Force visibility and styling
                            field.style.color = '#ffffff';
                            field.style.backgroundColor = '#2d3139';
                            field.style.borderColor = '#3a3f4b';
                            field.style.opacity = '1';
                            field.style.visibility = 'visible';
                            field.style.pointerEvents = 'auto';
                        }
                    });
                    
                    // Set form action for the specific record
                    document.getElementById('editUploadForm').action = `/dashboard/upload-catalog/${id}/edit`;
                    
                    // Show modal
                    const editUploadModal = new bootstrap.Modal(document.getElementById('editUploadModal'));
                    editUploadModal.show();
                    
                    // Apply additional styling fixes after modal is shown
                    setTimeout(() => {
                        document.querySelectorAll('#editUploadModal input, #editUploadModal select, #editUploadModal textarea').forEach(field => {
                            field.style.color = '#ffffff';
                            field.style.backgroundColor = '#2d3139';
                            field.style.borderColor = '#3a3f4b';
                            field.style.opacity = '1';
                            field.style.visibility = 'visible';
                            field.style.pointerEvents = 'auto';
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error fetching upload record:', error);
                    alert('Error loading upload record data');
                });
        }

        function deleteUploadRecord(id) {
            if (confirm('Are you sure you want to delete this upload record?')) {
                fetch(`/api/upload-catalog/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            refreshRecentUpload();
                            showNotification('Upload record deleted successfully', 'success');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        function updateUploadRecordsTable(data) {
            const tbody = document.getElementById('recentUploadRecords');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-state';
                emptyRow.innerHTML = `
                    <td colspan="11">
                        <i class="fas fa-inbox me-2"></i>
                        No upload records found. Create your first upload entry above.
                    </td>
                `;
                tbody.appendChild(emptyRow);
                return;
            }
            
            data.slice(0, 10).forEach(upload => {
                const row = document.createElement('tr');
                
                // Format content link cell with icon
                let linkCell = '';
                if (upload.contentCatalogLink && upload.contentCatalogLink.trim() !== '') {
                    const truncatedLink = upload.contentCatalogLink.length > 50 ? upload.contentCatalogLink.substring(0, 50) + '...' : upload.contentCatalogLink;
                    linkCell = `<div class="content-link-cell">
                        <a href="${upload.contentCatalogLink}" target="_blank" class="content-link" title="${upload.contentCatalogLink}">
                            <i class="fas fa-external-link-alt me-1"></i>${truncatedLink}
                        </a>
                    </div>`;
                } else {
                    linkCell = '<div class="content-link-cell"><span class="text-muted"><i class="fas fa-file-text me-1"></i>No link provided</span></div>';
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input upload-checkbox" data-id="${upload.id}" onchange="updateBulkActions()"></td>
                    <td title="Content Block ID">${formatContentBlock(upload.contentBlock)}</td>
                    <td title="${upload.contentCatalogLink || 'No description available'}">${linkCell}</td>
                    <td><span class="badge bg-info" title="Media Type">${formatMediaType(upload.mediaCatalogType)}</span></td>
                    <td title="${upload.mediaCatalogName}" class="media-name-cell">${truncateText(upload.mediaCatalogName, 20)}</td>
                    <td title="Content Location" class="location-cell">${formatLocation(upload.contentCatalogLocation)}</td>
                    <td title="Upload Location" class="location-cell">${formatLocation(upload.uploadCatalogLocation)}</td>
                    <td><span class="badge ${getUploadStatusBadgeClass(upload.uploadStatus)}" title="Upload Status">${formatUploadStatus(upload.uploadStatus)}</span></td>
                    <td title="${upload.uploadCatalogCaption || 'No caption'}" class="caption-cell">${formatCaption(upload.uploadCatalogCaption)}</td>
                    <td title="Created Date" class="date-cell">${formatDate(upload.createdOn)}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editUploadRecord(this)" 
                                    data-id="${upload.id}" title="Edit Record">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUploadRecord(${upload.id})" 
                                    title="Delete Record">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatContentBlock(contentBlock) {
            if (!contentBlock) return '<span class="text-muted">—</span>';
            return `<code class="text-primary">${contentBlock}</code>`;
        }

        function formatContentLink(contentLink) {
            if (!contentLink) return '<span class="text-muted">No content specified</span>';
            
            if (isValidUrl(contentLink)) {
                return `<a href="${contentLink}" target="_blank" class="text-decoration-none">
                    <i class="fas fa-external-link-alt me-1"></i>View Link
                </a>`;
            } else {
                return `<span class="text-muted">${truncateText(contentLink, 40)}</span>`;
            }
        }

        function formatMediaType(mediaType) {
            if (!mediaType) return 'Unknown';
            return mediaType.replace('_', ' ').toLowerCase()
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatUploadStatus(status) {
            if (!status) return 'Unknown';
            return status.replace('_', ' ').toLowerCase()
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatLocation(location) {
            if (!location || location.trim() === '') {
                return '<span class="text-muted"><i class="fas fa-folder-open me-1"></i>Not specified</span>';
            }
            return `<span class="location-text" title="${location}">
                <i class="fas fa-folder me-1"></i>${truncateText(location, 25)}
            </span>`;
        }

        function formatCaption(caption) {
            if (!caption || caption.trim() === '') {
                return '<span class="text-muted">No caption</span>';
            }
            return `<span class="caption-text" title="${caption}">
                <i class="fas fa-quote-left me-1"></i>${truncateText(caption, 30)}
            </span>`;
        }

        function showUploadRecordsLoading() {
            const tbody = document.getElementById('recentUploadRecords');
            if (!tbody) return;
            
            tbody.innerHTML = `
                <tr class="loading-state">
                    <td colspan="7">
                        <div class="loading-spinner"></div>
                        Loading upload records...
                    </td>
                </tr>
            `;
        }

        function getUploadStatusBadgeClass(status) {
            switch(status) {
                case 'NEW': return 'bg-info';
                case 'READY_TO_UPLOAD': return 'bg-primary';
                case 'UPLOADED': return 'bg-success';
                case 'COMPLETED': return 'bg-success';
                case 'IN_PROGRESS': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        // Utility Functions
        function updateMediaRecordsTable(data) {
            const tbody = document.getElementById('recentMediaRecords');
            tbody.innerHTML = '';
            
            data.slice(0, 10).forEach(media => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input media-checkbox" data-id="${media.id}" onchange="updateBulkActions()">
                    </td>
                    <td>${media.name}</td>
                    <td><span class="badge bg-secondary">${media.type}</span></td>
                    <td>${media.platform || 'N/A'}</td>
                    <td>${media.language || 'N/A'}</td>
                    <td>
                        <span class="badge bg-primary" title="${media.subGenres || ''}">${media.mainGenre || 'N/A'}</span>
                    </td>
                    <td><span class="badge ${getStatusBadgeClass(media.downloadStatus)}">${media.downloadStatus}</span></td>
                    <td>${formatDate(media.updatedOn)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editMediaRecord(this)" data-id="${media.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMediaRecord(${media.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateContentRecordsTable(data) {
            const tbody = document.getElementById('recentContentRecords');
            tbody.innerHTML = '';
            
            data.slice(0, 10).forEach(content => {
                const row = document.createElement('tr');
                
                // Format link cell
                let linkCell = '';
                if (content.link && content.link.trim() !== '') {
                    const truncatedLink = content.link.length > 40 ? content.link.substring(0, 40) + '...' : content.link;
                    linkCell = `<a href="${content.link}" target="_blank" class="content-link" title="${content.link}">
                        <i class="fas fa-external-link-alt me-1"></i>${truncatedLink}
                    </a>`;
                } else {
                    linkCell = '<span class="text-muted"><i class="fas fa-file-text me-1"></i>No link provided</span>';
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input content-checkbox" data-id="${content.id}" onchange="updateBulkActions()"></td>
                    <td>${content.mediaCatalogName}</td>
                    <td><div class="content-link-cell">${linkCell}</div></td>
                    <td><span class="badge bg-secondary">${content.mediaCatalogType}</span></td>
                    <td><span class="badge ${getContentStatusBadgeClass(content.status)}">${content.status}</span></td>
                    <td><span class="badge ${getPriorityBadgeClass(content.priority)}">${content.priority}</span></td>
                    <td><span class="badge ${getLocalStatusBadgeClass(content.localStatus)}" title="${content.localStatus || 'Not Set'}">${content.localStatus || '-'}</span></td>
                    <td><div class="location-path-cell" title="${content.locationPath || 'No path specified'}">${content.locationPath ? (content.locationPath.length > 30 ? content.locationPath.substring(0, 30) + '...' : content.locationPath) : '-'}</div></td>
                    <td><div class="metadata-cell" title="${content.metadata ? (content.metadata.length > 100 ? content.metadata.substring(0, 100) + '...' : content.metadata) : 'No metadata'}">${content.metadata ? (content.metadata.length > 50 ? content.metadata.substring(0, 50) + '...' : content.metadata) : '-'}</div></td>
                    <td>${formatDate(content.createdOn)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editContentRecord(this)" data-id="${content.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteContentRecord(${content.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'DOWNLOADED': return 'bg-success';
                case 'NOT_DOWNLOADED': return 'bg-warning';
                case 'PARTIALLY_DOWNLOADED': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        function getContentStatusBadgeClass(status) {
            switch(status) {
                case 'DOWNLOADED': return 'bg-success';
                case 'NEW': return 'bg-info';
                case 'ERROR': return 'bg-danger';
                case 'IN_PROGRESS': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'HIGH': return 'bg-danger';
                case 'MEDIUM': return 'bg-warning';
                case 'LOW': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function getLocalStatusBadgeClass(localStatus) {
            switch(localStatus?.toUpperCase()) {
                case 'AVAILABLE': return 'bg-success';
                case 'NOT_AVAILABLE': return 'bg-danger';
                case 'PARTIALLY_AVAILABLE': return 'bg-warning';
                case 'DOWNLOADING': return 'bg-info';
                case 'PROCESSING': return 'bg-primary';
                case 'CORRUPTED': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '<span class="text-muted">—</span>';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // If today, show time only
            if (date.toDateString() === now.toDateString()) {
                return `<span class="text-success" title="${date.toLocaleString()}">Today ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}</span>`;
            }
            
            // If yesterday, show "Yesterday"
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return `<span class="text-info" title="${date.toLocaleString()}">Yesterday</span>`;
            }
            
            // If within a week, show day name
            if (diffDays <= 7) {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return `<span class="text-muted" title="${date.toLocaleString()}">${dayNames[date.getDay()]}</span>`;
            }
            
            // Otherwise show date
            return `<span class="text-muted" title="${date.toLocaleString()}">${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}</span>`;
        }

        function showNotification(message, type = 'info') {
            // Create a toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }
        
        // Multi-Media Catalog Name Functionality
        let mediaCatalogNames = [];
        let selectedMediaNames = [];
        let isNewMediaCatalog = false;

        function initializeMediaCatalogNameAutocomplete() {
            // Show loading status
            const loadingStatus = document.getElementById('multiMediaLoadingStatus');
            if (loadingStatus) {
                loadingStatus.style.display = 'inline';
            }
            
            // Fetch existing media catalog names
            fetch('/api/media-catalog/names')
                .then(response => response.json())
                .then(names => {
                    mediaCatalogNames = names;
                    setupMultiMediaAutocomplete();
                    setupContentFormValidation();
                    
                    // Hide loading status
                    if (loadingStatus) {
                        loadingStatus.style.display = 'none';
                    }
                    
                    console.log('Loaded', names.length, 'media catalog names');
                })
                .catch(error => {
                    console.error('Error fetching media catalog names:', error);
                    // Hide loading status on error
                    if (loadingStatus) {
                        loadingStatus.style.display = 'none';
                    }
                    updateStatusMessage('Failed to load existing media names. You can still add new ones.', 'warning');
                });
        }

        let contentFormValidationSetup = false;
        
        function setupContentFormValidation() {
            const form = document.getElementById('contentCatalogForm');
            if (!form || contentFormValidationSetup) return;

            form.addEventListener('submit', function(e) {
                if (selectedMediaNames.length === 0) {
                    e.preventDefault();
                    updateStatusMessage('Please select at least one media catalog name.', 'warning');
                    
                    // Focus on the input field
                    const input = document.getElementById('mediaCatalogNameInput');
                    if (input) {
                        input.focus();
                    }
                    
                    return false;
                }
                return true;
            });
            
            contentFormValidationSetup = true;
        }

        function setupMultiMediaAutocomplete() {
            const input = document.getElementById('mediaCatalogNameInput');
            const dropdown = document.getElementById('mediaCatalogNameDropdown');
            
            if (!input || !dropdown) {
                console.warn('Multi-media input elements not found, retrying...');
                return;
            }
            
            // Remove existing event listeners to prevent duplicates
            input.replaceWith(input.cloneNode(true));
            const newInput = document.getElementById('mediaCatalogNameInput');
            
            // Handle input for autocomplete
            newInput.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                
                if (value.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                // Filter matching names that haven't been selected yet
                const matches = mediaCatalogNames.filter(name => 
                    name.toLowerCase().includes(value) && 
                    !selectedMediaNames.includes(name)
                );
                
                dropdown.innerHTML = '';
                
                if (matches.length > 0) {
                    matches.forEach(name => {
                        const item = document.createElement('button');
                        item.className = 'dropdown-item';
                        item.type = 'button';
                        item.textContent = name;
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            selectMediaFromDropdown(name);
                        });
                        dropdown.appendChild(item);
                    });
                    dropdown.classList.add('show');
                } else {
                    dropdown.classList.remove('show');
                }
            });
            
            // Handle Enter key and comma separation
            newInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const value = this.value.trim();
                    if (value && !selectedMediaNames.includes(value)) {
                        addMediaName(value);
                        this.value = '';
                        dropdown.classList.remove('show');
                    }
                }
                
                // Handle backspace when input is empty to remove last tag
                if (e.key === 'Backspace' && this.value === '' && selectedMediaNames.length > 0) {
                    removeMediaName(selectedMediaNames[selectedMediaNames.length - 1]);
                }
                
                // Hide dropdown on escape key
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
            
            // Hide dropdown when clicking outside (use event delegation to avoid duplicates)
            if (!document.hasAttribute('data-multimedia-click-handler')) {
                document.addEventListener('click', function(e) {
                    const activeDropdown = document.getElementById('mediaCatalogNameDropdown');
                    const activeInput = document.getElementById('mediaCatalogNameInput');
                    
                    if (activeDropdown && activeInput && 
                        !activeInput.contains(e.target) && 
                        !activeDropdown.contains(e.target)) {
                        activeDropdown.classList.remove('show');
                    }
                });
                document.setAttribute('data-multimedia-click-handler', 'true');
            }
        }

        function selectMediaFromDropdown(name) {
            addMediaName(name);
            const input = document.getElementById('mediaCatalogNameInput');
            if (input) {
                input.value = '';
            }
            const dropdown = document.getElementById('mediaCatalogNameDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        function addMediaName(name) {
            const cleanName = name.trim();
            if (!cleanName || selectedMediaNames.includes(cleanName)) {
                return;
            }
            
            selectedMediaNames.push(cleanName);
            updateMediaNameTags();
            updateHiddenInput();
            
            // Show selected names container if it's the first item
            if (selectedMediaNames.length === 1) {
                const container = document.getElementById('selectedMediaNames');
                if (container) {
                    container.style.display = 'block';
                }
            }
            
            updateStatusMessage(`Added: "${cleanName}"`, 'success');
        }

        function removeMediaName(name) {
            const index = selectedMediaNames.indexOf(name);
            if (index > -1) {
                selectedMediaNames.splice(index, 1);
                updateMediaNameTags();
                updateHiddenInput();
                
                // Hide selected names container if empty
                if (selectedMediaNames.length === 0) {
                    const container = document.getElementById('selectedMediaNames');
                    if (container) {
                        container.style.display = 'none';
                    }
                }
                
                updateStatusMessage(`Removed: "${name}"`, 'info');
            }
        }

        function updateMediaNameTags() {
            const tagsContainer = document.getElementById('mediaNameTags');
            if (!tagsContainer) return;
            
            tagsContainer.innerHTML = selectedMediaNames.map(name => {
                const isExisting = mediaCatalogNames.includes(name);
                const tagClass = isExisting ? 'existing-media' : 'new-media';
                const tagTitle = isExisting ? 'Existing media' : 'New media (will be created)';
                
                return `
                    <div class="media-name-tag ${tagClass}" title="${tagTitle}">
                        ${name}
                        <button type="button" class="remove-tag" onclick="removeMediaName('${name}')" title="Remove">×</button>
                    </div>
                `;
            }).join('');
        }

        function updateHiddenInput() {
            const hiddenInput = document.getElementById('mediaCatalogName');
            if (hiddenInput) {
                hiddenInput.value = selectedMediaNames.join(',');
            }
        }

        function updateStatusMessage(message, type) {
            const statusDiv = document.getElementById('mediaCatalogNameStatus');
            
            if (statusDiv) {
                statusDiv.style.display = 'block';
                
                if (type === 'success') {
                    statusDiv.innerHTML = `<small class="text-success"><i class="fas fa-check-circle me-1"></i><span>${message}</span></small>`;
                } else if (type === 'warning') {
                    statusDiv.innerHTML = `<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i><span>${message}</span></small>`;
                } else if (type === 'info') {
                    statusDiv.innerHTML = `<small class="text-info"><i class="fas fa-info-circle me-1"></i><span>${message}</span></small>`;
                }
                
                // Auto-hide success/info messages after 3 seconds
                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        if (statusDiv) {
                            statusDiv.style.display = 'none';
                        }
                    }, 3000);
                }
            }
        }

        function clearStatusMessage() {
            const statusDiv = document.getElementById('mediaCatalogNameStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Reset multi-media form
        function resetMultiMediaForm() {
            selectedMediaNames = [];
            updateMediaNameTags();
            updateHiddenInput();
            
            const container = document.getElementById('selectedMediaNames');
            if (container) {
                container.style.display = 'none';
            }
            
            const input = document.getElementById('mediaCatalogNameInput');
            if (input) {
                input.value = '';
            }
            
            clearStatusMessage();
        }

        function updateMediaTypeFromExisting(mediaName) {
            if (!mediaName) return;
            
            // Fetch media catalog details to auto-fill media type
            fetch(`/api/media-catalog/search?name=${encodeURIComponent(mediaName)}`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        const media = results[0];
                        const typeSelect = document.getElementById('mediaCatalogType');
                        if (typeSelect && media.type) {
                            typeSelect.value = media.type.toLowerCase().replace('_', '-');
                        }
                    }
                })
                .catch(error => console.error('Error fetching media details:', error));
        }

        // Upload Catalog Media Name Autocomplete
        let uploadMediaCatalogNames = [];
        let isNewUploadMediaCatalog = false;

        function setupUploadMediaCatalogAutocomplete() {
            // Fetch existing media catalog names
            fetch('/api/media-catalog/names')
                .then(response => response.json())
                .then(names => {
                    uploadMediaCatalogNames = names;
                    setupUploadAutocomplete();
                })
                .catch(error => console.error('Error fetching media catalog names:', error));
        }

        function setupUploadAutocomplete() {
            const input = document.getElementById('uploadMediaCatalogName');
            const dropdown = document.getElementById('uploadMediaCatalogNameDropdown');
            
            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();
                dropdown.innerHTML = '';
                
                if (value.length < 1) {
                    dropdown.classList.remove('show');
                    clearUploadStatusMessage();
                    return;
                }

                // Enhanced search: support both full name and initials matching
                const filteredNames = uploadMediaCatalogNames.filter(name => {
                    const lowerName = name.toLowerCase();
                    const lowerValue = value.toLowerCase();
                    
                    // Direct substring match
                    if (lowerName.includes(lowerValue)) {
                        return true;
                    }
                    
                    // Initials matching: extract first letters of each word
                    const initials = name.split(' ')
                        .map(word => word.charAt(0).toLowerCase())
                        .join('');
                    
                    return initials.includes(lowerValue);
                });

                if (filteredNames.length > 0) {
                    filteredNames.forEach(name => {
                        const item = document.createElement('button');
                        item.className = 'dropdown-item';
                        item.type = 'button';
                        item.textContent = name;
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            input.value = name;
                            dropdown.classList.remove('show');
                            isNewUploadMediaCatalog = false;
                            updateUploadStatusMessage(`Using existing: "${name}"`, 'success');
                            updateUploadMediaTypeFromExisting(name);
                            // Load linked content when media is selected
                            loadLinkedContentForMedia(name);
                        });
                        dropdown.appendChild(item);
                    });
                    
                    // Check if current value exactly matches any existing name
                    const exactMatch = uploadMediaCatalogNames.find(name => 
                        name.toLowerCase() === value
                    );
                    isNewUploadMediaCatalog = !exactMatch;
                    
                    if (exactMatch) {
                        updateUploadStatusMessage(`Using existing: "${exactMatch}"`, 'success');
                        // Load linked content for exact match
                        loadLinkedContentForMedia(exactMatch);
                    } else {
                        updateUploadStatusMessage(`Will create new: "${input.value}"`, 'warning');
                        // Hide linked content for new entries
                        hideLinkedContent();
                    }
                    
                    dropdown.classList.add('show');
                } else {
                    // No matches found - this will be a new entry
                    isNewUploadMediaCatalog = true;
                    const newItem = document.createElement('button');
                    newItem.className = 'dropdown-item text-success';
                    newItem.type = 'button';
                    newItem.innerHTML = `<small><i class="fas fa-plus me-2"></i>Create new: "${input.value}"</small>`;
                    newItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        // Keep the current value in the input (it's already there)
                        dropdown.classList.remove('show');
                        isNewUploadMediaCatalog = true;
                        updateUploadStatusMessage(`Will create new: "${input.value}"`, 'warning');
                    });
                    dropdown.appendChild(newItem);
                    dropdown.classList.add('show');
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Hide dropdown on escape key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        function updateUploadMediaTypeFromExisting(mediaName) {
            // Fetch media catalog details to auto-fill media type
            fetch(`/api/media-catalog/search?name=${encodeURIComponent(mediaName)}`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        const media = results[0];
                        const typeSelect = document.getElementById('uploadMediaCatalogType');
                        if (typeSelect && media.type) {
                            typeSelect.value = media.type.toLowerCase().replace('_', '-');
                        }
                        // Load linked content for this media
                        loadLinkedContentForMedia(mediaName);
                    }
                })
                .catch(error => console.error('Error fetching media details:', error));
        }

        // New function to load linked content when media catalog is selected
        function loadLinkedContentForMedia(mediaName) {
            if (!mediaName || mediaName.trim() === '') {
                hideLinkedContent();
                return;
            }

            // Show loading state
            showLinkedContentLoading();

            // Get selected media type for filtering
            const mediaTypeSelect = document.getElementById('uploadMediaCatalogType');
            const selectedMediaType = mediaTypeSelect ? mediaTypeSelect.value : null;
            
            // Build API URL with type filtering for comprehensive search
            let apiUrl = `/api/content-catalog/all-linked-content?mediaCatalogName=${encodeURIComponent(mediaName)}`;
            if (selectedMediaType && selectedMediaType !== '') {
                apiUrl += `&mediaType=${encodeURIComponent(selectedMediaType)}`;
            }
            
            // Fetch linked content from both Content and Upload Catalogs with type filtering
            fetch(apiUrl)
                .then(response => response.json())
                .then(allLinkedData => {
                    displayAllLinkedContent(allLinkedData, mediaName, selectedMediaType);
                })
                .catch(error => {
                    console.error('Error fetching linked content:', error);
                    showLinkedContentError();
                });
        }

        function showLinkedContentLoading() {
            const section = document.getElementById('linkedContentSection');
            const container = document.getElementById('linkedContentList');
            
            if (section && container) {
                section.style.display = 'block';
                container.innerHTML = `
                    <div class="linked-content-loading">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading linked content...
                    </div>
                `;
            }
        }

        function displayLinkedContent(contentList, mediaName, mediaType) {
            const section = document.getElementById('linkedContentSection');
            const container = document.getElementById('linkedContentList');
            const controls = document.getElementById('linkedContentControls');
            
            if (!section || !container) return;

            section.style.display = 'block';

            if (!contentList || contentList.length === 0) {
                container.innerHTML = `
                    <div class="linked-content-empty">
                        <i class="fas fa-info-circle me-2"></i>
                        No content records found for "${mediaName}"
                    </div>
                `;
                return;
            }

            let contentHtml = '';
            contentList.forEach(content => {
                const statusClass = getContentStatusClass(content.status);
                const truncatedLink = content.link ? 
                    (content.link.length > 50 ? content.link.substring(0, 50) + '...' : content.link) : 
                    'No link provided';

                contentHtml += `
                    <div class="linked-content-item" onclick="selectLinkedContent(${content.id}, '${content.link || ''}')">
                        <div class="linked-content-info">
                            <div class="linked-content-id">ID: ${content.id}</div>
                            <div class="linked-content-link" title="${content.link || 'No link provided'}">
                                ${content.link ? 
                                    `<i class="fas fa-link me-1"></i>${truncatedLink}` : 
                                    `<i class="fas fa-file-text me-1"></i>Text content`
                                }
                            </div>
                        </div>
                        <div class="linked-content-status">
                            <span class="badge ${statusClass}">${content.status || 'Unknown'}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = contentHtml;
        }

        function selectLinkedContent(id, link, type) {
            type = type || 'content'; // Default to content for backward compatibility
            
            // Update the Content ID field
            const contentBlockInput = document.getElementById('contentBlock');
            if (contentBlockInput) {
                contentBlockInput.value = id;
                const typeName = type === 'upload' ? 'Upload' : 'Content';
                updateContentBlockStatusMessage(`Selected: ${typeName} ID ${id}`, 'success');
            }

            // Auto-fill the content catalog link if it's empty
            const linkTextarea = document.getElementById('contentCatalogLink');
            if (linkTextarea && link && !linkTextarea.value.trim()) {
                linkTextarea.value = link;
            }

            // Update visual selection
            document.querySelectorAll('.linked-content-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.linked-content-item').classList.add('selected');

            // Show feedback
            const typeName = type === 'upload' ? 'Upload' : 'Content';
            showNotification(`${typeName} ID ${id} selected and auto-filled`, 'success');
        }

        function hideLinkedContent() {
            const section = document.getElementById('linkedContentSection');
            if (section) {
                section.style.display = 'none';
            }
        }

        function showLinkedContentError() {
            const container = document.getElementById('linkedContentList');
            if (container) {
                container.innerHTML = `
                    <div class="linked-content-empty text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading linked content. Please try again.
                    </div>
                `;
            }
        }
        
        // New functions for adding linked content
        function showAddLinkedContentForm() {
            const addSection = document.getElementById('addLinkedContentSection');
            if (addSection) {
                addSection.style.display = 'block';
                // Clear previous input
                document.getElementById('newLinkedContentLink').value = '';
                document.getElementById('newLinkedContentDescription').value = '';
                document.getElementById('newLinkedContentLink').focus();
            }
        }
        
        function hideAddLinkedContentForm() {
            const addSection = document.getElementById('addLinkedContentSection');
            if (addSection) {
                addSection.style.display = 'none';
            }
        }
        
        function addNewLinkedContent() {
            const linkInput = document.getElementById('newLinkedContentLink');
            const descriptionInput = document.getElementById('newLinkedContentDescription');
            
            const link = linkInput.value.trim();
            const description = descriptionInput.value.trim();
            
            if (!link) {
                alert('Please enter a content link.');
                linkInput.focus();
                return;
            }
            
            if (!window.currentLinkedMediaName) {
                alert('No media catalog selected. Please select a media catalog first.');
                return;
            }
            
            // Create new content catalog entry
            const newContentData = {
                link: link,
                mediaCatalogName: window.currentLinkedMediaName,
                mediaCatalogType: window.currentLinkedMediaType || 'MOVIE',
                status: 'NEW',
                priority: 'MEDIUM',
                metadata: description || null
            };
            
            // Show loading state
            const addButton = document.querySelector('button[onclick="addNewLinkedContent()"]');
            const originalText = addButton.innerHTML;
            addButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
            addButton.disabled = true;
            
            // Send to backend
            fetch('/api/content-catalog', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newContentData)
            })
            .then(response => response.json())
            .then(data => {
                // Reset button
                addButton.innerHTML = originalText;
                addButton.disabled = false;
                
                // Hide form
                hideAddLinkedContentForm();
                
                // Show success message
                showNotification(`New content link added successfully (ID: ${data.id})`, 'success');
                
                // Refresh linked content list
                refreshLinkedContent();
            })
            .catch(error => {
                console.error('Error adding new content:', error);
                // Reset button
                addButton.innerHTML = originalText;
                addButton.disabled = false;
                
                alert('Error adding new content link. Please try again.');
            });
        }
        
        function refreshLinkedContent() {
            if (window.currentLinkedMediaName) {
                loadLinkedContentForMedia(window.currentLinkedMediaName);
            }
        }
        
        // Enhanced function to show controls when content is displayed
        function enhanceDisplayLinkedContent(originalContentList) {
            const controls = document.getElementById('linkedContentControls');
            if (controls && originalContentList && originalContentList.length > 0) {
                controls.style.display = 'block';
            }
        }
        
        // New function to display both content catalog and upload catalog results
        function displayAllLinkedContent(allLinkedData, mediaName, mediaType) {
            const section = document.getElementById('linkedContentSection');
            const container = document.getElementById('linkedContentList');
            const controls = document.getElementById('linkedContentControls');
            
            if (!section || !container) return;
            section.style.display = 'block';
            
            // Store current media info for adding new content
            window.currentLinkedMediaName = mediaName;
            window.currentLinkedMediaType = mediaType;
            
            const contentCatalog = allLinkedData.contentCatalog || [];
            const uploadCatalog = allLinkedData.uploadCatalog || [];
            const totalResults = contentCatalog.length + uploadCatalog.length;
            
            if (totalResults === 0) {
                const typeText = mediaType ? ` and type "${mediaType}"` : '';
                container.innerHTML = `
                    <div class="linked-content-empty">
                        <i class="fas fa-info-circle me-2"></i>
                        No content or upload records found for "${mediaName}"${typeText}
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showAddLinkedContentForm()">
                                <i class="fas fa-plus me-1"></i>Add First Content Link
                            </button>
                        </div>
                    </div>
                `;
                if (controls) controls.style.display = 'none';
                return;
            }
            
            let contentHtml = '';
            
            // Display Content Catalog results
            if (contentCatalog.length > 0) {
                contentHtml += `
                    <div class="linked-content-section mb-3">
                        <h6 class="linked-content-section-title">
                            <i class="fas fa-video me-2 text-primary"></i>Content Catalog (${contentCatalog.length})
                        </h6>
                `;
                
                contentCatalog.forEach(content => {
                    const statusClass = getContentStatusClass(content.status);
                    const truncatedLink = content.link ? 
                        (content.link.length > 50 ? content.link.substring(0, 50) + '...' : content.link) : 
                        'No link provided';
                    const locationPath = content.locationPath ? 
                        (content.locationPath.length > 40 ? content.locationPath.substring(0, 40) + '...' : content.locationPath) : 
                        null;
                    contentHtml += `
                        <div class="linked-content-item" onclick="selectLinkedContent(${content.id}, '${content.link || ''}', 'content')">
                            <div class="linked-content-info">
                                <div class="linked-content-id">
                                    <i class="fas fa-video me-1"></i>Content ID: ${content.id}
                                </div>
                                <div class="linked-content-link" title="${content.link || 'No link provided'}">
                                    ${content.link ? 
                                        `<i class="fas fa-link me-1"></i>${truncatedLink}` : 
                                        `<i class="fas fa-file-text me-1"></i>Text content`
                                    }
                                </div>
                                ${locationPath ? 
                                    `<div class="linked-content-path" title="${content.locationPath}">
                                        <i class="fas fa-folder me-1 text-muted"></i><small class="text-muted">${locationPath}</small>
                                    </div>` : 
                                    ''
                                }
                            </div>
                            <div class="linked-content-status">
                                <span class="badge ${statusClass}">${content.status || 'Unknown'}</span>
                            </div>
                        </div>
                    `;
                });
                
                contentHtml += '</div>';
            }
            
            // Display Upload Catalog results
            if (uploadCatalog.length > 0) {
                contentHtml += `
                    <div class="linked-content-section mb-3">
                        <h6 class="linked-content-section-title">
                            <i class="fas fa-upload me-2 text-success"></i>Upload Catalog (${uploadCatalog.length})
                        </h6>
                `;
                
                uploadCatalog.forEach(upload => {
                    const statusClass = getUploadStatusClass(upload.uploadStatus);
                    const truncatedLink = upload.contentCatalogLink ? 
                        (upload.contentCatalogLink.length > 50 ? upload.contentCatalogLink.substring(0, 50) + '...' : upload.contentCatalogLink) : 
                        'No link provided';
                    contentHtml += `
                        <div class="linked-content-item" onclick="selectLinkedContent(${upload.id}, '${upload.contentCatalogLink || ''}', 'upload')">
                            <div class="linked-content-info">
                                <div class="linked-content-id">
                                    <i class="fas fa-upload me-1"></i>Upload ID: ${upload.id}
                                </div>
                                <div class="linked-content-link" title="${upload.contentCatalogLink || 'No link provided'}">
                                    ${upload.contentCatalogLink ? 
                                        `<i class="fas fa-link me-1"></i>${truncatedLink}` : 
                                        `<i class="fas fa-file-text me-1"></i>Text content`
                                    }
                                </div>
                                ${upload.uploadCatalogCaption ? 
                                    `<div class="linked-content-caption"><small class="text-muted">${upload.uploadCatalogCaption}</small></div>` : 
                                    ''
                                }
                            </div>
                            <div class="linked-content-status">
                                <span class="badge ${statusClass}">${upload.uploadStatus || 'Unknown'}</span>
                            </div>
                        </div>
                    `;
                });
                
                contentHtml += '</div>';
            }
            
            container.innerHTML = contentHtml;
            
            // Show controls when we have content
            if (controls) {
                controls.style.display = 'block';
            }
            
            // Hide add form if it was open
            const addSection = document.getElementById('addLinkedContentSection');
            if (addSection) addSection.style.display = 'none';
        }
        
        // Override original displayLinkedContent to add controls support
        const originalDisplayLinkedContent = window.displayLinkedContent;
        window.displayLinkedContent = function(contentList, mediaName, mediaType) {
            // Call original function
            if (originalDisplayLinkedContent) {
                originalDisplayLinkedContent.call(this, contentList, mediaName);
            }
            
            // Store current media info and show controls
            window.currentLinkedMediaName = mediaName;
            window.currentLinkedMediaType = mediaType;
            
            const controls = document.getElementById('linkedContentControls');
            const addSection = document.getElementById('addLinkedContentSection');
            
            if (contentList && contentList.length > 0) {
                if (controls) controls.style.display = 'block';
            } else {
                if (controls) controls.style.display = 'none';
            }
            
            // Hide add form if it was open
            if (addSection) addSection.style.display = 'none';
        };

        function getUploadStatusClass(status) {
            switch(status?.toUpperCase()) {
                case 'UPLOADED': return 'bg-success';
                case 'IN_PROGRESS': return 'bg-warning';
                case 'NEW': return 'bg-info';
                case 'ERROR': return 'bg-danger';
                case 'FAILED': return 'bg-danger';
                case 'COMPLETED': return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        function getContentStatusClass(status) {
            switch(status?.toUpperCase()) {
                case 'DOWNLOADED': return 'bg-success';
                case 'NEW': return 'bg-info';
                case 'IN_PROGRESS': return 'bg-warning';
                case 'ERROR': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function updateUploadStatusMessage(message, type) {
            const statusDiv = document.getElementById('uploadMediaCatalogNameStatus');
            const messageSpan = document.getElementById('uploadStatusMessage');
            
            if (statusDiv && messageSpan) {
                messageSpan.textContent = message;
                statusDiv.className = `mt-1 text-${type}`;
                statusDiv.style.display = 'block';
            }
        }

        function clearUploadStatusMessage() {
            const statusDiv = document.getElementById('uploadMediaCatalogNameStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Content Block Autocomplete
        let contentBlocks = [];

        function setupContentBlockAutocomplete() {
            const input = document.getElementById('contentBlock');
            const dropdown = document.getElementById('contentBlockDropdown');
            
            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const value = this.value.trim();
                dropdown.innerHTML = '';
                
                if (value.length < 2) {
                    dropdown.classList.remove('show');
                    clearContentBlockStatusMessage();
                    return;
                }

                // Fetch content blocks with search
                fetch(`/api/content-catalog/content-blocks?search=${encodeURIComponent(value)}`)
                    .then(response => response.json())
                    .then(data => {
                        contentBlocks = data;
                        displayContentBlockOptions(data, value, dropdown);
                    })
                    .catch(error => {
                        console.error('Error fetching content blocks:', error);
                        updateContentBlockStatusMessage('Error loading content data', 'danger');
                    });
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Hide dropdown on escape key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        function displayContentBlockOptions(data, searchValue, dropdown) {
            if (data.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item text-muted">No content found</div>';
                dropdown.classList.add('show');
                return;
            }

            data.slice(0, 10).forEach(content => {
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.type = 'button';
                
                // Create display text with ID and name
                const statusBadge = getContentStatusBadge(content.status);
                const isLinkMatch = content.link && content.link.toLowerCase().includes(searchValue.toLowerCase());
                const isNameMatch = content.mediaCatalogName && content.mediaCatalogName.toLowerCase().includes(searchValue.toLowerCase());
                
                let matchIndicator = '';
                if (isLinkMatch && isNameMatch) {
                    matchIndicator = '<i class="fas fa-link text-primary me-1" title="Link match"></i><i class="fas fa-tag text-success me-1" title="Name match"></i>';
                } else if (isLinkMatch) {
                    matchIndicator = '<i class="fas fa-link text-primary me-1" title="Link match"></i>';
                } else if (isNameMatch) {
                    matchIndicator = '<i class="fas fa-tag text-success me-1" title="Name match"></i>';
                }
                
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>ID: ${content.id}</strong> ${matchIndicator}<br>
                            <small class="text-muted">${content.mediaCatalogName}</small>
                            ${isLinkMatch ? `<br><small class="text-info"><i class="fas fa-link me-1"></i>${content.link.substring(0, 50)}${content.link.length > 50 ? '...' : ''}</small>` : ''}
                        </div>
                        <span class="badge ${statusBadge}">${content.status}</span>
                    </div>
                `;
                
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const input = document.getElementById('contentBlock');
                    input.value = `${content.id}`;
                    dropdown.classList.remove('show');
                    
                    let statusMessage = `Selected: "${content.mediaCatalogName}" (ID: ${content.id})`;
                    if (isLinkMatch) {
                        statusMessage += ` - Link matched`;
                    }
                    updateContentBlockStatusMessage(statusMessage, 'success');
                    
                    // Auto-fill content catalog link/description if available
                    if (content.link) {
                        const linkTextarea = document.getElementById('contentCatalogLink');
                        if (linkTextarea && !linkTextarea.value.trim()) {
                            linkTextarea.value = content.link;
                        }
                    }
                });
                
                dropdown.appendChild(item);
            });
            
            dropdown.classList.add('show');
        }

        function getContentStatusBadge(status) {
            switch(status?.toUpperCase()) {
                case 'COMPLETED': return 'bg-success';
                case 'IN_PROGRESS': return 'bg-warning';
                case 'PENDING': return 'bg-info';
                case 'ON_HOLD': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function updateContentBlockStatusMessage(message, type) {
            const statusDiv = document.getElementById('contentBlockStatus');
            const messageSpan = document.getElementById('contentBlockMessage');
            
            if (statusDiv && messageSpan) {
                messageSpan.textContent = message;
                statusDiv.className = `mt-1 text-${type}`;
                statusDiv.style.display = 'block';
            }
        }

        function clearContentBlockStatusMessage() {
            const statusDiv = document.getElementById('contentBlockStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Utility functions for Content Catalog Link/Description handling
        function isValidUrl(string) {
            if (!string) return false;
            try {
                new URL(string);
                return true;
            } catch (_) {
                // Check if it starts with http/https but might not be perfectly formatted
                return string.trim().toLowerCase().startsWith('http');
            }
        }

        function truncateText(text, maxLength) {
            if (!text) return 'N/A';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function setupTextareaAutoResize() {
            const textarea = document.getElementById('contentCatalogLink');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px'; // Max height 150px
                });
                
                // Initial resize
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            }
        }

        function updateStatusMessage(message, type) {
            const statusDiv = document.getElementById('mediaCatalogNameStatus');
            const messageSpan = document.getElementById('statusMessage');
            
            if (statusDiv && messageSpan) {
                messageSpan.textContent = message;
                statusDiv.style.display = 'block';
                
                // Update color based on type
                const smallElement = statusDiv.querySelector('small');
                smallElement.className = type === 'success' ? 'text-success' : 
                                       type === 'warning' ? 'text-warning' : 
                                       'text-info';
            }
        }

        function clearStatusMessage() {
            const statusDiv = document.getElementById('mediaCatalogNameStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Global utility functions
        function hideRecentRecordsSections() {
            const sections = document.querySelectorAll('.recent-records-section');
            sections.forEach(section => section.style.display = 'none');
        }

        function showRecentRecordsSections() {
            const sections = document.querySelectorAll('.recent-records-section');
            sections.forEach(section => section.style.display = 'block');
        }

        // Auto-activate tab based on server-side activeTab parameter
        document.addEventListener('DOMContentLoaded', function() {
            const activeTab = /*[[${activeTab}]]*/ 'dashboard';
            console.log('Page loaded with activeTab:', activeTab);
            if (activeTab && activeTab !== 'dashboard') {
                console.log('Activating tab:', activeTab);
                showTab(activeTab);
            }
            
            // Ensure data is loaded for all tabs on initial page load
            loadInitialTabData();
            
            // Initialize upload edit form handler
            initializeUploadEditForm();
            
            // Set default date to today for states catalog report date
            const reportDateField = document.getElementById('reportDate');
            if (reportDateField) {
                const today = new Date().toISOString().split('T')[0];
                reportDateField.value = today;
            }
            
            // Initialize bulk upload form handler
            initializeBulkUploadForm();
            
            // Initialize upload form content block handling
            initializeUploadFormContentBlock();
        });
        
        function initializeUploadEditForm() {
            const editUploadForm = document.getElementById('editUploadForm');
            if (editUploadForm) {
                // Initialize form submission handler
                editUploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    
                    // Handle content block ID vs display value
                    const contentBlockInput = document.getElementById('editContentBlock');
                    if (contentBlockInput && contentBlockInput.hasAttribute('data-content-id')) {
                        formData.set('contentBlock', contentBlockInput.getAttribute('data-content-id'));
                    }
                    
                    const submitBtn = this.querySelector('button[type="submit"]');
                    
                    // Show loading state
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
                    }
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            // Close modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('editUploadModal'));
                            if (modal) modal.hide();
                            
                            // Refresh the upload records table
                            if (typeof refreshRecentUpload === 'function') {
                                refreshRecentUpload();
                            }
                            
                            // Show success notification
                            if (typeof showNotification === 'function') {
                                showNotification('Upload record updated successfully!', 'success');
                            } else {
                                alert('Upload record updated successfully!');
                            }
                        } else {
                            throw new Error('Failed to update upload record');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating upload record:', error);
                        if (typeof showNotification === 'function') {
                            showNotification('Error updating upload record', 'error');
                        } else {
                            alert('Error updating upload record');
                        }
                    })
                    .finally(() => {
                        // Restore button state
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Update Upload Record';
                        }
                    });
                });
                
                // Initialize dropdown functionality
                initializeEditModalDropdowns();
            }
        }
        
        function initializeEditModalDropdowns() {
            // Content Block dropdown functionality
            const contentBlockInput = document.getElementById('editContentBlock');
            const contentBlockDropdown = document.getElementById('editContentBlockDropdown');
            
            if (contentBlockInput && contentBlockDropdown) {
                let contentBlockTimeout;
                
                contentBlockInput.addEventListener('input', function() {
                    clearTimeout(contentBlockTimeout);
                    contentBlockTimeout = setTimeout(() => {
                        const searchTerm = this.value.trim();
                        if (searchTerm.length > 0) {
                            searchContentBlocks(searchTerm, contentBlockDropdown, contentBlockInput);
                        } else {
                            contentBlockDropdown.style.display = 'none';
                        }
                    }, 300);
                });
                
                contentBlockInput.addEventListener('focus', function() {
                    if (this.value.trim().length > 0) {
                        contentBlockDropdown.style.display = 'block';
                    }
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!contentBlockInput.contains(event.target) && !contentBlockDropdown.contains(event.target)) {
                        contentBlockDropdown.style.display = 'none';
                    }
                });
            }
            
            // Media Catalog Name dropdown functionality
            const mediaCatalogInput = document.getElementById('editMediaCatalogName');
            const mediaCatalogDropdown = document.getElementById('editMediaCatalogDropdown');
            
            if (mediaCatalogInput && mediaCatalogDropdown) {
                let mediaCatalogTimeout;
                
                mediaCatalogInput.addEventListener('input', function() {
                    clearTimeout(mediaCatalogTimeout);
                    mediaCatalogTimeout = setTimeout(() => {
                        const searchTerm = this.value.trim();
                        if (searchTerm.length > 0) {
                            searchMediaCatalog(searchTerm, mediaCatalogDropdown, mediaCatalogInput);
                        } else {
                            mediaCatalogDropdown.style.display = 'none';
                        }
                    }, 300);
                });
                
                mediaCatalogInput.addEventListener('focus', function() {
                    if (this.value.trim().length > 0) {
                        mediaCatalogDropdown.style.display = 'block';
                    }
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mediaCatalogInput.contains(event.target) && !mediaCatalogDropdown.contains(event.target)) {
                        mediaCatalogDropdown.style.display = 'none';
                    }
                });
            }
        }
        
        function searchContentBlocks(searchTerm, dropdown, input) {
            fetch(`/api/content-catalog/content-blocks?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    populateContentBlockDropdown(data, dropdown, input);
                })
                .catch(error => {
                    console.error('Error fetching content blocks:', error);
                    dropdown.style.display = 'none';
                });
        }
        
        function searchMediaCatalog(searchTerm, dropdown, input) {
            fetch(`/api/content-catalog/search?name=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    populateMediaCatalogDropdown(data, dropdown, input);
                })
                .catch(error => {
                    console.error('Error fetching media catalog:', error);
                    dropdown.style.display = 'none';
                });
        }
        
        function populateContentBlockDropdown(data, dropdown, input) {
            dropdown.innerHTML = '';
            
            if (data && data.length > 0) {
                data.slice(0, 10).forEach(item => {
                    const option = document.createElement('button');
                    option.className = 'dropdown-item';
                    option.type = 'button';
                    
                    // Show link in the display but truncate if too long
                    const displayLink = item.link ? (item.link.length > 50 ? item.link.substring(0, 50) + '...' : item.link) : 'No link';
                    
                    option.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${displayLink}</strong><br>
                                <small class="text-muted">ID: ${item.id} | ${item.mediaCatalogName || 'No name'}</small>
                            </div>
                            <small class="text-info">${item.mediaCatalogType || ''}</small>
                        </div>
                    `;
                    
                    option.addEventListener('click', function() {
                        // Display the link in the input field but store the ID as data attribute
                        input.value = item.link || item.id; // Show link, fallback to ID
                        input.setAttribute('data-content-id', item.id); // Store ID for backend
                        dropdown.style.display = 'none';
                        
                        // Auto-populate content catalog location if this is the edit form
                        if (input.id === 'editContentBlock') {
                            fetchAndPopulateContentCatalogLocation(item.id);
                        }
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item-text text-muted';
                noResults.textContent = 'No content blocks found';
                dropdown.appendChild(noResults);
                dropdown.style.display = 'block';
            }
        }
        
        function fetchAndPopulateContentCatalogLocation(contentId) {
            if (!contentId) {
                return;
            }
            
            // Show loading state in the location field
            const locationInput = document.getElementById('editContentCatalogLocation');
            if (locationInput) {
                locationInput.value = 'Loading location...';
                locationInput.disabled = true;
            }
            
            // Fetch location data from the new API endpoint
            fetch(`/api/content-catalog/${contentId}/location`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error(`HTTP ${response.status}`);
                })
                .then(data => {
                    if (locationInput) {
                        // Populate with location path if available, otherwise use location
                        const locationValue = data.locationPath || data.location || '';
                        locationInput.value = locationValue;
                        locationInput.disabled = false;
                        
                        if (locationValue) {
                            console.log('Auto-populated content catalog location:', locationValue);
                            showNotification(`Location auto-populated from Content ID ${contentId}`, 'success');
                        } else {
                            showNotification(`No location data found for Content ID ${contentId}`, 'warning');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching content catalog location:', error);
                    if (locationInput) {
                        locationInput.value = '';
                        locationInput.disabled = false;
                        locationInput.placeholder = 'Location not found for this content ID';
                    }
                    showNotification(`Could not fetch location for Content ID ${contentId}`, 'warning');
                });
        }
        
        function initializeUploadFormContentBlock() {
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    // Handle content block ID vs display value before submission
                    const contentBlockInput = document.getElementById('contentBlock');
                    if (contentBlockInput && contentBlockInput.hasAttribute('data-content-id')) {
                        contentBlockInput.value = contentBlockInput.getAttribute('data-content-id');
                    }
                    // Let the form submit normally
                });
            }
        }

        function initializeBulkUploadForm() {
            const bulkUploadForm = document.getElementById('bulkUploadForm');
            if (bulkUploadForm) {
                bulkUploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const fileInput = document.getElementById('bulkUploadFile');
                    const progressDiv = document.getElementById('uploadProgress');
                    const submitBtn = document.querySelector('button[form="bulkUploadForm"][type="submit"]');
                    
                    if (!fileInput.files.length) {
                        alert('Please select a file to upload');
                        return;
                    }
                    
                    if (!this.action) {
                        alert('Form action not set. Please close and reopen the upload dialog.');
                        return;
                    }
                    
                    // Show progress
                    progressDiv.style.display = 'block';
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                    
                    // Create FormData and submit
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.redirected) {
                            // Handle redirect (success or error messages will be shown on dashboard)
                            window.location.href = response.url;
                        } else {
                            throw new Error('Upload failed');
                        }
                    })
                    .catch(error => {
                        console.error('Bulk upload error:', error);
                        alert('Error during bulk upload. Please try again.');
                        
                        // Reset UI
                        progressDiv.style.display = 'none';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload & Process';
                    });
                });
            }
        }

        function populateMediaCatalogDropdown(data, dropdown, input) {
            dropdown.innerHTML = '';
            
            if (data && data.length > 0) {
                data.slice(0, 10).forEach(item => {
                    const option = document.createElement('button');
                    option.className = 'dropdown-item';
                    option.type = 'button';
                    option.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.mediaCatalogName}</strong><br>
                                <small class="text-muted">ID: ${item.id}</small>
                            </div>
                            <small class="text-info">${item.mediaCatalogType || ''}</small>
                        </div>
                    `;
                    
                    option.addEventListener('click', function() {
                        input.value = item.mediaCatalogName;
                        dropdown.style.display = 'none';
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item-text text-muted';
                noResults.textContent = 'No media catalog found';
                dropdown.appendChild(noResults);
                dropdown.style.display = 'block';
            }
        }

        function loadInitialTabData() {
            // Load data for all tabs that might be visible
            console.log('Loading initial tab data...');
            setTimeout(() => {
                if (typeof refreshRecentMedia === 'function') {
                    console.log('Calling refreshRecentMedia...');
                    refreshRecentMedia();
                }
                if (typeof refreshRecentContent === 'function') {
                    console.log('Calling refreshRecentContent...');
                    refreshRecentContent();
                }
                if (typeof refreshRecentUpload === 'function') {
                    console.log('Calling refreshRecentUpload...');
                    refreshRecentUpload();
                }
            }, 100);
            
            // Also try to force refresh after a longer delay if needed
            setTimeout(() => {
                // Check if tables are empty and retry if needed
                const uploadTableBody = document.getElementById('recentUploadRecords');
                const contentTableBody = document.querySelector('#content-status .recent-records-table tbody');
                
                if (uploadTableBody && !uploadTableBody.hasChildNodes()) {
                    console.log('Upload table is empty, retrying...');
                    refreshRecentUpload();
                }
                
                if (contentTableBody && !contentTableBody.hasChildNodes()) {
                    console.log('Content table is empty, retrying...');
                    refreshRecentContent();
                }
            }, 1000);
        }

        // ===== BULK UPLOAD FUNCTIONALITY =====
        
        function showBulkUploadModal(type) {
            const modal = document.getElementById('bulkUploadModal');
            const title = document.getElementById('bulkUploadModalTitle');
            const form = document.getElementById('bulkUploadForm');
            const templateButtons = document.getElementById('templateDownloadButtons');
            
            // Set modal title and form action based on type
            if (type === 'content') {
                title.textContent = 'Bulk Upload - Content Catalog';
                form.action = '/dashboard/bulk-upload/content-catalog';
                
                templateButtons.innerHTML = `
                    <a href="/dashboard/templates/content-catalog/csv" class="btn btn-outline-primary btn-sm mb-2">
                        <i class="fas fa-file-csv me-2"></i>Download CSV Template
                    </a>
                    <a href="/dashboard/templates/content-catalog/json" class="btn btn-outline-success btn-sm mb-2">
                        <i class="fas fa-file-code me-2"></i>Download JSON Template
                    </a>
                `;
            } else if (type === 'upload') {
                title.textContent = 'Bulk Upload - Upload Catalog';
                form.action = '/dashboard/bulk-upload/upload-catalog';
                
                templateButtons.innerHTML = `
                    <a href="/dashboard/templates/upload-catalog/csv" class="btn btn-outline-primary btn-sm mb-2">
                        <i class="fas fa-file-csv me-2"></i>Download CSV Template
                    </a>
                    <a href="/dashboard/templates/upload-catalog/json" class="btn btn-outline-success btn-sm mb-2">
                        <i class="fas fa-file-code me-2"></i>Download JSON Template
                    </a>
                `;
            } else if (type === 'media') {
                title.textContent = 'Bulk Upload - Media Catalog';
                form.action = '/dashboard/bulk-upload/media-catalog';
                
                templateButtons.innerHTML = `
                    <a href="/dashboard/templates/media-catalog/csv" class="btn btn-outline-primary btn-sm mb-2">
                        <i class="fas fa-file-csv me-2"></i>Download CSV Template
                    </a>
                    <a href="/dashboard/templates/media-catalog/json" class="btn btn-outline-success btn-sm mb-2">
                        <i class="fas fa-file-code me-2"></i>Download JSON Template
                    </a>
                `;
            } else if (type === 'states') {
                title.textContent = 'Bulk Upload - States Catalog';
                form.action = '/dashboard/bulk-upload/states-catalog';
                
                templateButtons.innerHTML = `
                    <a href="/dashboard/templates/states-catalog/csv" class="btn btn-outline-primary btn-sm mb-2">
                        <i class="fas fa-file-csv me-2"></i>Download CSV Template
                    </a>
                    <a href="/dashboard/templates/states-catalog/json" class="btn btn-outline-success btn-sm mb-2">
                        <i class="fas fa-file-code me-2"></i>Download JSON Template
                    </a>
                `;
            }
            
            // Reset form
            form.reset();
            document.getElementById('uploadProgress').style.display = 'none';
            
            // Show modal
            const bulkUploadModal = new bootstrap.Modal(modal);
            bulkUploadModal.show();
        }
        
        function refreshUploadTable() {
            const refreshBtn = event.target.closest('button');
            const originalHtml = refreshBtn.innerHTML;
            
            // Show loading state
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
            refreshBtn.disabled = true;
            
            // Refresh the upload records
            if (typeof refreshRecentUpload === 'function') {
                refreshRecentUpload();
                
                // Show success feedback briefly
                setTimeout(() => {
                    refreshBtn.innerHTML = '<i class="fas fa-check me-2"></i>Refreshed!';
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalHtml;
                        refreshBtn.disabled = false;
                    }, 1000);
                }, 500);
            } else {
                // Show error feedback briefly
                refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHtml;
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }
        
        function refreshMediaTable() {
            const refreshBtn = event.target.closest('button');
            const originalHtml = refreshBtn.innerHTML;
            
            // Show loading state
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
            refreshBtn.disabled = true;
            
            // Refresh the media records
            if (typeof refreshRecentMedia === 'function') {
                refreshRecentMedia();
                
                // Show success feedback briefly
                setTimeout(() => {
                    refreshBtn.innerHTML = '<i class="fas fa-check me-2"></i>Refreshed!';
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalHtml;
                        refreshBtn.disabled = false;
                    }, 1000);
                }, 500);
            } else {
                // Show error feedback briefly
                refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHtml;
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }
        
        // ===== BULK DELETE FUNCTIONALITY =====
        
        function toggleAllSelections(catalogType) {
            const selectAllCheckbox = document.getElementById(`selectAll${catalogType.charAt(0).toUpperCase() + catalogType.slice(1)}`);
            const checkboxes = document.querySelectorAll(`.${catalogType}-checkbox`);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const mediaChecked = document.querySelectorAll('.media-checkbox:checked');
            const contentChecked = document.querySelectorAll('.content-checkbox:checked');
            const uploadChecked = document.querySelectorAll('.upload-checkbox:checked');
            
            const totalSelected = mediaChecked.length + contentChecked.length + uploadChecked.length;
            
            const bulkActionsContainer = document.getElementById('bulkActionsContainer');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedCount = document.getElementById('selectedCount');
            
            if (totalSelected > 0) {
                bulkActionsContainer.style.display = 'block';
                bulkDeleteBtn.disabled = false;
                selectedCount.textContent = totalSelected;
            } else {
                bulkActionsContainer.style.display = 'none';
                bulkDeleteBtn.disabled = true;
                selectedCount.textContent = '0';
            }
            
            // Update select all checkboxes state
            updateSelectAllCheckboxes();
        }
        
        function updateSelectAllCheckboxes() {
            // Media catalog
            const mediaCheckboxes = document.querySelectorAll('.media-checkbox');
            const mediaChecked = document.querySelectorAll('.media-checkbox:checked');
            const selectAllMedia = document.getElementById('selectAllMedia');
            if (selectAllMedia) {
                selectAllMedia.checked = mediaCheckboxes.length > 0 && mediaChecked.length === mediaCheckboxes.length;
                selectAllMedia.indeterminate = mediaChecked.length > 0 && mediaChecked.length < mediaCheckboxes.length;
            }
            
            // Content catalog
            const contentCheckboxes = document.querySelectorAll('.content-checkbox');
            const contentChecked = document.querySelectorAll('.content-checkbox:checked');
            const selectAllContent = document.getElementById('selectAllContent');
            if (selectAllContent) {
                selectAllContent.checked = contentCheckboxes.length > 0 && contentChecked.length === contentCheckboxes.length;
                selectAllContent.indeterminate = contentChecked.length > 0 && contentChecked.length < contentCheckboxes.length;
            }
            
            // Upload catalog
            const uploadCheckboxes = document.querySelectorAll('.upload-checkbox');
            const uploadChecked = document.querySelectorAll('.upload-checkbox:checked');
            const selectAllUpload = document.getElementById('selectAllUpload');
            if (selectAllUpload) {
                selectAllUpload.checked = uploadCheckboxes.length > 0 && uploadChecked.length === uploadCheckboxes.length;
                selectAllUpload.indeterminate = uploadChecked.length > 0 && uploadChecked.length < uploadCheckboxes.length;
            }
        }
        
        function clearAllSelections() {
            const allCheckboxes = document.querySelectorAll('.media-checkbox, .content-checkbox, .upload-checkbox');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            const selectAllCheckboxes = document.querySelectorAll('#selectAllMedia, #selectAllContent, #selectAllUpload');
            selectAllCheckboxes.forEach(checkbox => {
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.indeterminate = false;
                }
            });
            
            updateBulkActions();
        }
        
        function showBulkDeleteConfirmation(type = null) {
            if (type === 'states') {
                // Handle states catalog bulk delete
                if (selectedStatesIds.length === 0) {
                    alert('Please select records to delete.');
                    return;
                }
                
                const confirmMessage = `Are you sure you want to delete ${selectedStatesIds.length} selected States Catalog records?\n\n` +
                    `This action cannot be undone.`;
                
                if (confirm(confirmMessage)) {
                    performStatessBulkDelete();
                }
                return;
            }
            
            // Handle existing bulk delete functionality
            const mediaChecked = document.querySelectorAll('.media-checkbox:checked');
            const contentChecked = document.querySelectorAll('.content-checkbox:checked');
            const uploadChecked = document.querySelectorAll('.upload-checkbox:checked');
            
            const selectedItems = {
                media: Array.from(mediaChecked).map(cb => cb.getAttribute('data-id')),
                content: Array.from(contentChecked).map(cb => cb.getAttribute('data-id')),
                upload: Array.from(uploadChecked).map(cb => cb.getAttribute('data-id'))
            };
            
            const totalCount = selectedItems.media.length + selectedItems.content.length + selectedItems.upload.length;
            
            const confirmMessage = `Are you sure you want to delete ${totalCount} selected records?\n\n` +
                `Media Catalog: ${selectedItems.media.length} records\n` +
                `Content Catalog: ${selectedItems.content.length} records\n` +
                `Upload Catalog: ${selectedItems.upload.length} records\n\n` +
                `This action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                performBulkDelete(selectedItems);
            }
        }
        
        function performBulkDelete(selectedItems) {
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const originalHtml = bulkDeleteBtn.innerHTML;
            bulkDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
            bulkDeleteBtn.disabled = true;
            
            const promises = [];
            
            // Delete media catalog items
            if (selectedItems.media.length > 0) {
                promises.push(
                    fetch('/api/media-catalog/bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(selectedItems.media)
                    })
                );
            }
            
            // Delete content catalog items
            if (selectedItems.content.length > 0) {
                promises.push(
                    fetch('/api/content-catalog/bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(selectedItems.content)
                    })
                );
            }
            
            // Delete upload catalog items
            if (selectedItems.upload.length > 0) {
                promises.push(
                    fetch('/api/upload-catalog/bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(selectedItems.upload)
                    })
                );
            }
            
            Promise.all(promises)
                .then(responses => {
                    const allSuccessful = responses.every(response => response.ok);
                    
                    if (allSuccessful) {
                        // Show success message
                        showAlert('Success', `Successfully deleted ${selectedItems.media.length + selectedItems.content.length + selectedItems.upload.length} records.`, 'success');
                        
                        // Refresh all tables
                        if (typeof refreshRecentMedia === 'function') refreshRecentMedia();
                        if (typeof refreshRecentContent === 'function') refreshRecentContent();
                        if (typeof refreshRecentUpload === 'function') refreshRecentUpload();
                        
                        // Clear selections
                        clearAllSelections();
                    } else {
                        showAlert('Error', 'Some records could not be deleted. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error during bulk delete:', error);
                    showAlert('Error', 'An error occurred while deleting records. Please try again.', 'error');
                })
                .finally(() => {
                    bulkDeleteBtn.innerHTML = originalHtml;
                    bulkDeleteBtn.disabled = false;
                });
        }
        
        function showAlert(title, message, type) {
            // Create and show a Bootstrap alert
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '9999';
            alertContainer.style.minWidth = '300px';
            
            alertContainer.innerHTML = `
                <strong>${title}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertContainer);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 5000);
        }
        
        // ===== DATABASE CLEANUP FUNCTIONALITY =====
        
        function showCleanupConfirmation() {
            const modal = new bootstrap.Modal(document.getElementById('cleanupConfirmationModal'));
            
            // Reset the form
            document.getElementById('confirmCleanup').checked = false;
            document.getElementById('confirmCleanupBtn').disabled = true;
            
            modal.show();
        }
        
        // Handle checkbox change for cleanup confirmation
        document.addEventListener('DOMContentLoaded', function() {
            const confirmCheckbox = document.getElementById('confirmCleanup');
            const confirmButton = document.getElementById('confirmCleanupBtn');
            
            if (confirmCheckbox && confirmButton) {
                confirmCheckbox.addEventListener('change', function() {
                    confirmButton.disabled = !this.checked;
                });
            }
            
            // Handle form submission with additional confirmation
            const cleanupForm = document.getElementById('cleanupForm');
            if (cleanupForm) {
                cleanupForm.addEventListener('submit', function(e) {
                    if (!document.getElementById('confirmCleanup').checked) {
                        e.preventDefault();
                        alert('Please confirm that you understand this action cannot be undone.');
                        return;
                    }
                    
                    // Final confirmation dialog
                    if (!confirm('Last chance! Are you absolutely sure you want to delete ALL database entries? This cannot be undone!')) {
                        e.preventDefault();
                        return;
                    }
                    
                    // Show processing state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cleaning...';
                    submitBtn.disabled = true;
                });
            }
        });

        // Safe refresh functions that don't interfere with forms
        function safeRefreshRecentContent() {
            const form = document.getElementById('contentCatalogForm');
            // Only refresh if form is not visible/active
            if (!form || form.style.display === 'none' || !form.style.display) {
                refreshRecentContent();
            }
        }

        function safeRefreshRecentMedia() {
            const form = document.getElementById('mediaCatalogForm');
            // Only refresh if form is not visible/active
            if (!form || form.style.display === 'none' || !form.style.display) {
                refreshRecentMedia();
            }
        }

        function safeRefreshRecentUpload() {
            const form = document.getElementById('uploadCatalogForm');
            // Only refresh if form is not visible/active
            if (!form || form.style.display === 'none' || !form.style.display) {
                refreshRecentUpload();
            }
        }

        // Helper function for external tab switching (used by dashboard.js)
        function showTab(tabId) {
            const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
            if (tabButton) {
                tabButton.click();
            }
        }

        // Make refresh functions globally available for dashboard.js
        window.refreshRecentMedia = refreshRecentMedia;
        window.refreshRecentContent = refreshRecentContent;
        window.refreshRecentUpload = refreshRecentUpload;
        window.showTab = showTab;
        
        // ===== DASHBOARD PERFORMANCE WIDGET FUNCTIONALITY =====
        
        function refreshDashboard() {
            const refreshBtn = document.querySelector('[onclick="refreshDashboard()"]');
            const lastUpdatedEl = document.getElementById('lastUpdated');
            
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
            }
            
            fetch('/api/dashboard/metrics')
                .then(response => response.json())
                .then(data => {
                    updateDashboardMetrics(data);
                    
                    if (lastUpdatedEl) {
                        lastUpdatedEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                    }
                })
                .catch(error => {
                    console.error('Error fetching dashboard metrics:', error);
                    
                    if (lastUpdatedEl) {
                        lastUpdatedEl.textContent = 'Error loading metrics';
                        lastUpdatedEl.className = 'text-danger ms-3';
                    }
                })
                .finally(() => {
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh';
                    }
                });
        }
        
        function updateDashboardMetrics(data) {
            if (!data) return;
            
            // Update quick stats cards
            updateElement('totalRecordsCount', data.systemStats?.totalRecords || 0);
            updateElement('completionRate', (data.quickStats?.completionRate || 0) + '%');
            updateElement('todaysActivity', '+' + (data.quickStats?.todaysActivity || 0) + ' today');
            
            // Update system statistics
            updateElement('mediaCatalogCount', data.systemStats?.totalMediaCatalog || 0);
            updateElement('contentCatalogCount', data.systemStats?.totalContentCatalog || 0);
            updateElement('uploadCatalogCount', data.systemStats?.totalUploadCatalog || 0);
            updateElement('statesCatalogCount', data.systemStats?.totalStatesCatalog || 0);
            
            // Update media type distribution
            updateChartData('movies', data.mediaTypeStats?.movies || 0, data.systemStats?.totalMediaCatalog || 1);
            updateChartData('albums', data.mediaTypeStats?.albums || 0, data.systemStats?.totalMediaCatalog || 1);
            updateChartData('webSeries', data.mediaTypeStats?.webSeries || 0, data.systemStats?.totalMediaCatalog || 1);
            updateChartData('documentaries', data.mediaTypeStats?.documentaries || 0, data.systemStats?.totalMediaCatalog || 1);
            
            // Update download status distribution  
            updateChartData('downloaded', data.contentStats?.downloaded || 0, data.systemStats?.totalContentCatalog || 1);
            updateChartData('newContent', data.contentStats?.new || 0, data.systemStats?.totalContentCatalog || 1);
            updateChartData('inProgressContent', data.contentStats?.inProgress || 0, data.systemStats?.totalContentCatalog || 1);
            updateChartData('errorContent', data.contentStats?.error || 0, data.systemStats?.totalContentCatalog || 1);
            
            // Update upload status distribution (including new READY_TO_UPLOAD)
            updateChartData('uploaded', data.uploadStats?.uploaded || 0, data.systemStats?.totalUploadCatalog || 1);
            updateChartData('readyToUpload', data.uploadStats?.readyToUpload || 0, data.systemStats?.totalUploadCatalog || 1);
            updateChartData('inProgressUpload', data.uploadStats?.inProgress || 0, data.systemStats?.totalUploadCatalog || 1);
            updateChartData('newUpload', data.uploadStats?.new || 0, data.systemStats?.totalUploadCatalog || 1);
            updateChartData('completedUpload', data.uploadStats?.completed || 0, data.systemStats?.totalUploadCatalog || 1);
            
            // Update health indicators
            updateElement('dbStatus', data.systemHealth?.databaseConnected ? 'Online' : 'Offline');
            updateElement('storageStatus', data.systemHealth?.diskSpace || 'Available');
            updateElement('apiStatus', data.performance?.avgResponseTime || '< 100ms');
            updateElement('uptimeStatus', data.systemHealth?.uptime || '99.9%');
            
            // Update quick action counts
            updateElement('qaMediaCount', (data.systemStats?.totalMediaCatalog || 0) + ' items');
            updateElement('qaContentCount', (data.systemStats?.totalContentCatalog || 0) + ' items');
            updateElement('qaUploadCount', (data.systemStats?.totalUploadCatalog || 0) + ' items');
            updateElement('qaStatesCount', (data.systemStats?.totalStatesCatalog || 0) + ' items');
            
            // Update recent activity
            loadRecentActivity();
            loadSystemAlerts();
        }
        
        function updateChartData(id, value, total) {
            // Update count
            const countElement = document.getElementById(id + 'Count');
            if (countElement) {
                countElement.textContent = value;
            }
            
            // Update progress bar
            const progressElement = document.getElementById(id + 'Progress');
            if (progressElement && total > 0) {
                const percentage = Math.min((value / total) * 100, 100);
                progressElement.style.width = percentage + '%';
            }
        }
        
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }
        
        function updateProgressBar(id, percentage) {
            const progressBar = document.getElementById(id);
            if (progressBar) {
                progressBar.style.width = Math.min(percentage, 100) + '%';
            }
        }
        
        function updateDistribution(type, value) {
            // Update count
            const countElement = document.getElementById(type + 'Count');
            if (countElement) {
                countElement.textContent = value;
            }
            
            // Update bar width (calculate relative to max value)
            const barElement = document.getElementById(type + 'Bar');
            if (barElement) {
                // Get all values to calculate percentage
                const allValues = [
                    parseInt(document.getElementById('moviesCount')?.textContent) || 0,
                    parseInt(document.getElementById('webSeriesCount')?.textContent) || 0,
                    parseInt(document.getElementById('albumsCount')?.textContent) || 0,
                    parseInt(document.getElementById('documentariesCount')?.textContent) || 0,
                    parseInt(document.getElementById('downloadedCount')?.textContent) || 0,
                    parseInt(document.getElementById('notDownloadedCount')?.textContent) || 0,
                    parseInt(document.getElementById('partiallyDownloadedCount')?.textContent) || 0
                ];
                
                const maxValue = Math.max(...allValues);
                const percentage = maxValue > 0 ? (value / maxValue * 100) : 0;
                barElement.style.width = percentage + '%';
            }
        }
        
        // Auto-refresh dashboard every 30 seconds when active
        let dashboardInterval;
        
        function startDashboardAutoRefresh() {
            dashboardInterval = setInterval(() => {
                const dashboardTab = document.getElementById('dashboard');
                if (dashboardTab && dashboardTab.classList.contains('active')) {
                    refreshDashboard();
                }
            }, 30000); // 30 seconds
        }
        
        function stopDashboardAutoRefresh() {
            if (dashboardInterval) {
                clearInterval(dashboardInterval);
                dashboardInterval = null;
            }
        }
        
        // Initialize dashboard on tab switch
        document.addEventListener('DOMContentLoaded', function() {
            // Load dashboard data when dashboard tab becomes active
            document.querySelector('[data-tab="dashboard"]')?.addEventListener('click', function() {
                setTimeout(refreshDashboard, 100);
                startDashboardAutoRefresh();
            });
            
            // Stop auto-refresh when switching away from dashboard
            document.querySelectorAll('.tab-btn:not([data-tab="dashboard"])').forEach(btn => {
                btn.addEventListener('click', stopDashboardAutoRefresh);
            });
            
            // Initial load if dashboard is default active tab
            const dashboardTab = document.getElementById('dashboard');
            if (dashboardTab && dashboardTab.classList.contains('active')) {
                setTimeout(refreshDashboard, 500);
                startDashboardAutoRefresh();
            }
        });
        
        // Export dashboard functions globally
        window.refreshDashboard = refreshDashboard;
        
        // ===== ENHANCED DASHBOARD FUNCTIONS =====
        
        function performGlobalSearch() {
            const category = document.getElementById('globalSearchCategory').value;
            const status = document.getElementById('globalSearchStatus').value;
            const searchTerm = document.getElementById('globalSearchInput').value.trim();
            
            if (!searchTerm && !category && !status) {
                showGlobalSearchMessage('Please enter a search term or select filters');
                return;
            }
            
            const resultsContainer = document.getElementById('globalSearchResults');
            resultsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Searching...</p></div>';
            
            const params = new URLSearchParams();
            if (searchTerm) params.append('q', searchTerm);
            if (category) params.append('category', category);
            if (status) params.append('status', status);
            
            fetch(`/api/dashboard/search?${params.toString()}`)
                .then(response => response.json())
                .then(data => displayGlobalSearchResults(data))
                .catch(error => {
                    console.error('Search error:', error);
                    showGlobalSearchMessage('Search failed. Please try again.');
                });
        }
        
        function displayGlobalSearchResults(data) {
            const resultsContainer = document.getElementById('globalSearchResults');
            
            if (!data || data.length === 0) {
                showGlobalSearchMessage('No results found matching your search criteria');
                return;
            }
            
            let html = '';
            data.forEach(item => {
                const iconClass = getSearchResultIcon(item.type);
                const statusBadge = getStatusBadge(item.status);
                
                html += `
                    <div class="search-result-item" onclick="openSearchResult('${item.type}', '${item.id}')">
                        <div class="search-result-icon ${iconClass}">
                            <i class="fas ${getTypeIcon(item.type)}"></i>
                        </div>
                        <div class="search-result-content">
                            <div class="search-result-title">${item.title}</div>
                            <div class="search-result-desc">${item.description}</div>
                            <div class="search-result-meta">
                                ${statusBadge} | ${item.type} | ${formatDate(item.createdAt)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }
        
        function clearGlobalSearch() {
            document.getElementById('globalSearchCategory').value = '';
            document.getElementById('globalSearchStatus').value = '';
            document.getElementById('globalSearchInput').value = '';
            showGlobalSearchMessage('Use the search controls above to find data across all catalogs', 'Search supports: Media names, content links, upload status, file paths, descriptions, and more');
        }
        
        function showGlobalSearchMessage(message, subMessage = '') {
            const resultsContainer = document.getElementById('globalSearchResults');
            resultsContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <p>${message}</p>
                    ${subMessage ? `<p class="small">${subMessage}</p>` : ''}
                </div>
            `;
        }
        
        function openSearchResult(type, id) {
            // Switch to appropriate tab and highlight the result
            const tabMap = {
                'media': 'movies',
                'content': 'content-status', 
                'upload': 'add-entry',
                'states': 'states-catalog'
            };
            
            const targetTab = tabMap[type];
            if (targetTab) {
                switchTab(targetTab);
                // Highlight the specific item after tab switch
                setTimeout(() => {
                    const targetElement = document.querySelector(`[data-id="${id}"]`);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetElement.style.backgroundColor = 'rgba(79, 128, 255, 0.2)';
                        setTimeout(() => {
                            targetElement.style.backgroundColor = '';
                        }, 3000);
                    }
                }, 500);
            }
        }
        
        function getSearchResultIcon(type) {
            switch(type) {
                case 'media': return 'bg-info';
                case 'content': return 'bg-success';
                case 'upload': return 'bg-warning'; 
                case 'states': return 'bg-secondary';
                default: return 'bg-primary';
            }
        }
        
        function getTypeIcon(type) {
            switch(type) {
                case 'media': return 'fa-film';
                case 'content': return 'fa-folder-open';
                case 'upload': return 'fa-cloud-upload-alt';
                case 'states': return 'fa-chart-line';
                default: return 'fa-file';
            }
        }
        
        function getStatusBadge(status) {
            const statusClass = getUploadStatusBadgeClass(status) || 'bg-secondary';
            return `<span class="badge ${statusClass}">${formatUploadStatus(status)}</span>`;
        }
        
        function loadRecentActivity() {
            const activityContainer = document.getElementById('recentActivityList');
            if (!activityContainer) return;
            
            fetch('/api/dashboard/recent-activity')
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data && data.length > 0) {
                        data.forEach(activity => {
                            const iconClass = getActivityIcon(activity.type);
                            html += `
                                <div class="activity-item">
                                    <div class="activity-icon ${iconClass}">
                                        <i class="fas ${getTypeIcon(activity.type)}"></i>
                                    </div>
                                    <div class="activity-content">
                                        <span class="activity-title">${activity.title}</span>
                                        <span class="activity-time">${formatRelativeTime(activity.timestamp)}</span>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html = '<div class="text-center text-muted py-3">No recent activity</div>';
                    }
                    activityContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading recent activity:', error);
                    activityContainer.innerHTML = '<div class="text-center text-muted py-3">Error loading activity</div>';
                });
        }
        
        function loadSystemAlerts() {
            const alertsContainer = document.getElementById('systemAlertsList');
            if (!alertsContainer) return;
            
            fetch('/api/dashboard/system-alerts')
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data && data.length > 0) {
                        data.forEach(alert => {
                            const iconClass = getAlertIcon(alert.level);
                            html += `
                                <div class="alert-item">
                                    <div class="alert-icon ${iconClass}">
                                        <i class="fas ${getAlertTypeIcon(alert.level)}"></i>
                                    </div>
                                    <div class="alert-content">
                                        <span class="alert-title">${alert.title}</span>
                                        <span class="alert-desc">${alert.description}</span>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html = `
                            <div class="alert-item">
                                <div class="alert-icon bg-success">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="alert-content">
                                    <span class="alert-title">All systems operational</span>
                                    <span class="alert-desc">No critical issues detected</span>
                                </div>
                            </div>
                        `;
                    }
                    alertsContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading system alerts:', error);
                });
        }
        
        function getActivityIcon(type) {
            switch(type) {
                case 'media': return 'bg-info';
                case 'content': return 'bg-success';
                case 'upload': return 'bg-warning';
                case 'states': return 'bg-secondary';
                default: return 'bg-primary';
            }
        }
        
        function getAlertIcon(level) {
            switch(level) {
                case 'error': return 'bg-danger';
                case 'warning': return 'bg-warning';
                case 'info': return 'bg-info';
                default: return 'bg-success';
            }
        }
        
        function getAlertTypeIcon(level) {
            switch(level) {
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-check';
            }
        }
        
        function formatRelativeTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }
        
        function exportDashboardData() {
            // Export dashboard data to CSV/Excel
            fetch('/api/dashboard/export')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dashboard-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('Export failed. Please try again.');
                });
        }

        // ===== STATES CATALOG FUNCTIONS =====
        
        let statesData = [];
        let selectedStatesIds = [];
        
        function refreshStatesTable() {
            const tableBody = document.getElementById('statesTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '<tr><td colspan="10" class="text-center">Loading...</td></tr>';
            
            fetch('/dashboard/api/states-catalog')
                .then(response => response.json())
                .then(data => {
                    statesData = data;
                    populateStatesTable(data);
                })
                .catch(error => {
                    console.error('Error fetching states catalog data:', error);
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading data</td></tr>';
                });
        }
        
        function populateStatesTable(data) {
            const tableBody = document.getElementById('statesTableBody');
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No analytics records found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = data.map(states => `
                <tr>
                    <td><input type="checkbox" value="${states.id}" onchange="updateStatesSelection()"></td>
                    <td>${states.id}</td>
                    <td>${formatNumber(states.views)}</td>
                    <td>${formatNumber(states.subscribers)}</td>
                    <td>${formatNumber(states.interactions)}</td>
                    <td>${formatNumber(states.reach)}</td>
                    <td>${states.avgEngagementRate}%</td>
                    <td>${formatNumber(states.followersGained)}</td>
                    <td>${formatDate(states.createdOn)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="editStatesRecord(${states.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function showAddStatesForm() {
            const container = document.getElementById('statesFormContainer');
            const form = document.getElementById('statesForm');
            const saveBtn = document.getElementById('statesSaveBtn');
            
            if (container && form && saveBtn) {
                container.style.display = 'block';
                form.action = '/dashboard/states-catalog';
                form.reset();
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save States Catalog Entry';
                
                // Scroll to form
                container.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function showUpdateStatesForm() {
            showAddStatesForm();
        }
        
        function hideStatesForm() {
            const container = document.getElementById('statesFormContainer');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function editStatesRecord(id) {
            const states = statesData.find(s => s.id === id);
            if (!states) return;
            
            // Show form container
            const container = document.getElementById('statesFormContainer');
            const form = document.getElementById('statesForm');
            const saveBtn = document.getElementById('statesSaveBtn');
            
            if (container && form && saveBtn) {
                container.style.display = 'block';
                
                // Populate form fields
                document.getElementById('views').value = states.views || 0;
                document.getElementById('subscribers').value = states.subscribers || 0;
                document.getElementById('interactions').value = states.interactions || 0;
                document.getElementById('totalContent').value = states.totalContent || 0;
                document.getElementById('reach').value = states.reach || 0;
                document.getElementById('impressions').value = states.impressions || 0;
                document.getElementById('profileVisits').value = states.profileVisits || 0;
                document.getElementById('websiteClicks').value = states.websiteClicks || 0;
                document.getElementById('emailClicks').value = states.emailClicks || 0;
                document.getElementById('callClicks').value = states.callClicks || 0;
                document.getElementById('followersGained').value = states.followersGained || 0;
                document.getElementById('followersLost').value = states.followersLost || 0;
                document.getElementById('reelsCount').value = states.reelsCount || 0;
                document.getElementById('storiesCount').value = states.storiesCount || 0;
                document.getElementById('avgEngagementRate').value = states.avgEngagementRate || 0;
                
                // Update form action and button text
                form.action = `/dashboard/states-catalog/${id}/edit`;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update States Catalog Entry';
                
                // Scroll to form
                container.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function updateStatesSelection() {
            const checkboxes = document.querySelectorAll('#statesTable tbody input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('statesSelectAll');
            const selectedCountEl = document.getElementById('statesSelectedCount');
            const bulkDeleteBtn = document.getElementById('statesBulkDeleteBtn');
            
            selectedStatesIds = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));
            
            if (selectedCountEl) selectedCountEl.textContent = selectedStatesIds.length;
            if (bulkDeleteBtn) bulkDeleteBtn.disabled = selectedStatesIds.length === 0;
            
            // Update "select all" checkbox state
            if (selectAllCheckbox) {
                const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
                const someChecked = Array.from(checkboxes).some(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
            }
        }
        
        function toggleAllStatesSelection() {
            const selectAllCheckbox = document.getElementById('statesSelectAll');
            const checkboxes = document.querySelectorAll('#statesTable tbody input[type="checkbox"]');
            
            checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateStatesSelection();
        }
        
        function formatNumber(num) {
            return num ? num.toLocaleString() : '0';
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }
        
        // Initialize states table when states catalog tab becomes active
        document.addEventListener('DOMContentLoaded', function() {
            const statesTabBtn = document.querySelector('[data-tab="states-catalog"]');
            if (statesTabBtn) {
                statesTabBtn.addEventListener('click', function() {
                    setTimeout(refreshStatesTable, 100);
                });
            }
        });
        
        function performStatessBulkDelete() {
            if (selectedStatesIds.length === 0) return;
            
            fetch('/dashboard/api/states-catalog/bulk-delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(selectedStatesIds)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    selectedStatesIds = [];
                    refreshStatesTable();
                    updateStatesSelection();
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting records:', error);
                alert('Error occurred while deleting records. Please try again.');
            });
        }
        
        // Export states functions globally
        window.refreshStatesTable = refreshStatesTable;
        window.showAddStatesForm = showAddStatesForm;
        window.showUpdateStatesForm = showUpdateStatesForm;
        window.hideStatesForm = hideStatesForm;
    </script>
</body>
</html>