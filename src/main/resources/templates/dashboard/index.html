<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie & Instagram Dashboard - Cine Mitr</title>
    
    <!-- Bootstrap CSS -->
    <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/webjars/font-awesome/6.4.0/css/all.min.css}" rel="stylesheet">
    <link th:href="@{/css/dark-theme.css}" rel="stylesheet">
    <link th:href="@{/css/form-fixes.css}" rel="stylesheet">
</head>
<body class="dark-theme">
    <!-- Main Dashboard Container -->
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="container-fluid">
                <div class="d-flex align-items-center justify-content-between py-3">
                    <div class="header-title">
                        <i class="fas fa-bars me-3"></i>
                        <h1 class="mb-0">Movie & Instagram Dashboard</h1>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="bulk-actions" style="display: none;" id="bulkActionsContainer">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="showBulkDeleteConfirmation()" id="bulkDeleteBtn" disabled>
                                <i class="fas fa-trash-alt me-2"></i>Delete Selected (<span id="selectedCount">0</span>)
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSelections()">
                                <i class="fas fa-times me-2"></i>Clear Selection
                            </button>
                        </div>
                        <div class="header-stats">
                            <span class="total-count" th:text="${totalLinksCount ?: 0}">0</span>
                            <small>Total Links</small>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Tab Navigation -->
                <div class="tab-navigation mb-4">
                    <button class="tab-btn active" data-tab="movies">
                        <i class="fas fa-database me-2"></i>Media Catalog
                    </button>
                    <button class="tab-btn" data-tab="content-status">
                        <i class="fas fa-list-alt me-2"></i>Content Catalog
                    </button>
                    <button class="tab-btn" data-tab="add-entry">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Upload Catalog
                    </button>
                    <button class="tab-btn" data-tab="states-catalog">
                        <i class="fas fa-chart-line me-2"></i>States Catalog
                    </button>
                    <button class="tab-btn" data-tab="dashboard">
                        <i class="fas fa-chart-bar me-2"></i>Dashboard
                    </button>
                </div>

                <!-- Flash Messages -->
                <div th:if="${success}" class="alert alert-success mb-4">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${success}"></span>
                </div>
                <div th:if="${error}" class="alert alert-danger mb-4">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}"></span>
                </div>

                <!-- Media Catalog Tab -->
                <div class="tab-content active" id="movies">
                    <div class="form-container">
                        <!-- Action Bar -->
                        <div class="action-bar mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="section-title mb-0">Media Catalog Management</h2>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary me-2" onclick="showAddMediaForm()">
                                        <i class="fas fa-plus me-2"></i>Add New Media
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="showUpdateMediaForm()">
                                        <i class="fas fa-edit me-2"></i>Update Existing
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="showBulkUploadModal('media')">
                                        <i class="fas fa-file-upload me-2"></i>Bulk Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleMediaSearch()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="refreshMediaTable()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar (Initially Hidden) -->
                        <div id="mediaSearchBar" class="search-bar mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="mediaSearchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="mediaSearchType">
                                        <option value="">All Types</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="mediaSearchStatus">
                                        <option value="">All Status</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="not-downloaded">Not Downloaded</option>
                                        <option value="partially-downloaded">Partially Downloaded</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchMedia()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add/Edit Form (Initially Hidden) -->
                        <div id="mediaFormContainer" style="display: none;">
                            <form th:action="@{/dashboard/media-catalog}" method="post" class="entry-form" id="mediaForm">
                            <div class="form-group">
                                <label for="mediaName" class="form-label">Name</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="mediaName" 
                                       name="name"
                                       placeholder="Enter media name" 
                                       required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mediaType" class="form-label">Type</label>
                                    <select class="form-control" 
                                            id="mediaType" 
                                            name="type"
                                            required>
                                        <option value="">Select Type</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="platform" class="form-label">Platform</label>
                                    <select class="form-control" 
                                            id="platform"
                                            name="platform">
                                        <option value="">Select Platform</option>
                                        <option value="netflix">Netflix</option>
                                        <option value="amazon">Amazon Prime</option>
                                        <option value="zee5">ZEE5</option>
                                        <option value="youtube">YouTube</option>
                                        <option value="hotstar">Disney+ Hotstar</option>
                                        <option value="sony-liv">Sony LIV</option>
                                        <option value="voot">Voot</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="isDownloaded" class="form-label">Downloaded Status</label>
                                    <select class="form-control" 
                                            id="isDownloaded"
                                            name="downloadStatus">
                                        <option value="not-downloaded">Not Downloaded</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="partially-downloaded">Partially Downloaded</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="location" 
                                           name="location"
                                           placeholder="Storage location or file path">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="mediaDescription" class="form-label">Description</label>
                                <textarea class="form-control" 
                                          id="mediaDescription" 
                                          name="description"
                                          placeholder="Brief description of the media..."
                                          rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="funFacts" class="form-label">Fun Facts</label>
                                <textarea class="form-control" 
                                          id="funFacts" 
                                          name="funFacts"
                                          placeholder="Interesting facts or trivia about this media..."
                                          rows="3"></textarea>
                            </div>

                            <div class="form-actions mt-3">
                                <button type="submit" class="btn-save me-2">
                                    <i class="fas fa-save me-2"></i>Save Media Entry
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="cancelMediaForm()">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </form>
                        </div>

                        <!-- Recent Records Section (Default View) -->
                        <div id="mediaRecordsContainer" class="recent-records-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="section-subtitle">Media Catalog Records</h4>
                                <a href="#" class="btn btn-sm btn-outline-primary" onclick="refreshRecentMedia()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </a>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm recent-records-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllMedia" class="form-check-input" onchange="toggleAllSelections('media')">
                                            </th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Platform</th>
                                            <th>Status</th>
                                            <th>Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentMediaRecords">
                                        <tr th:each="media : ${recentMediaRecords}" th:if="${mediaStat.index < 10}">
                                            <td>
                                                <input type="checkbox" class="form-check-input media-checkbox" th:data-id="${media.id}" onchange="updateBulkActions()">
                                            </td>
                                            <td th:text="${media.name}">Sample Movie</td>
                                            <td><span class="badge bg-secondary" th:text="${media.type}">MOVIE</span></td>
                                            <td th:text="${media.platform}">Netflix</td>
                                            <td>
                                                <span class="badge" th:classappend="${media.downloadStatus == 'DOWNLOADED'} ? 'bg-success' : (${media.downloadStatus == 'NOT_DOWNLOADED'} ? 'bg-warning' : 'bg-info')"
                                                      th:text="${media.downloadStatus}">DOWNLOADED</span>
                                            </td>
                                            <td th:text="${#temporals.format(media.updatedOn, 'dd-MM HH:mm')}">24-08 14:30</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editMediaRecord(this)" 
                                                        th:data-id="${media.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMediaRecord(${media.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Content Catalog Tab -->
                <div class="tab-content" id="content-status">
                    <div class="form-container">
                        <!-- Action Bar -->
                        <div class="action-bar mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="section-title mb-0">Content Catalog Management</h2>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary me-2" onclick="showAddContentForm()">
                                        <i class="fas fa-plus me-2"></i>Add New Content
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="showUpdateContentForm()">
                                        <i class="fas fa-edit me-2"></i>Update Existing
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="showBulkUploadModal('content')">
                                        <i class="fas fa-file-upload me-2"></i>Bulk Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleContentSearch()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar (Initially Hidden) -->
                        <div id="contentSearchBar" class="search-bar mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="contentSearchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="contentSearchType">
                                        <option value="">All Types</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="contentSearchStatus">
                                        <option value="">All Status</option>
                                        <option value="new">New</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="error">Error</option>
                                        <option value="in-progress">In Progress</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="contentSearchPriority">
                                        <option value="">All Priority</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchContent()">
                                        <i class="fas fa-search me-2"></i>Search Content
                                    </button>
                                </div>
                            </div>
                        </div>
                        <form class="entry-form" action="/dashboard/content-catalog" method="post" id="contentCatalogForm" style="display: none;">
                            <div class="form-group">
                                <label for="contentLink" class="form-label">Link</label>
                                <input type="url" 
                                       class="form-control" 
                                       id="contentLink" 
                                       name="link"
                                       placeholder="Enter content URL or link" 
                                       required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mediaCatalogType" class="form-label">Media Catalog Type</label>
                                    <select class="form-control" 
                                            id="mediaCatalogType" 
                                            name="mediaCatalogType"
                                            required>
                                        <option value="">Select Type</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="mediaCatalogName" class="form-label">Media Catalog Name</label>
                                    <div class="position-relative">
                                        <input type="text" 
                                               class="form-control" 
                                               id="mediaCatalogName" 
                                               name="mediaCatalogName"
                                               placeholder="Type to search or enter new name" 
                                               autocomplete="off"
                                               required>
                                        <div id="mediaCatalogNameDropdown" class="dropdown-menu" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                                    </div>
                                    <small class="form-text text-muted">Start typing to see existing names or enter a new one</small>
                                    <div id="mediaCatalogNameStatus" class="mt-1" style="display: none;">
                                        <small class="text-info">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <span id="statusMessage"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contentStatus" class="form-label">Status</label>
                                    <select class="form-control" 
                                            id="contentStatus" 
                                            name="status"
                                            required>
                                        <option value="">Select Status</option>
                                        <option value="new">New</option>
                                        <option value="downloaded">Downloaded</option>
                                        <option value="error">Error</option>
                                        <option value="in-progress">In Progress</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="contentPriority" class="form-label">Priority</label>
                                    <select class="form-control" 
                                            id="contentPriority"
                                            name="priority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="contentLocation" class="form-label">Location</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="contentLocation" 
                                       name="location"
                                       placeholder="Storage location or file path">
                            </div>

                            <div class="form-group">
                                <label for="metadata" class="form-label">Metadata</label>
                                <textarea class="form-control" 
                                          id="metadata" 
                                          name="metadata"
                                          placeholder="Additional metadata information..."
                                          rows="3"></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="likeStates" class="form-label">Like States</label>
                                    <select class="form-control" 
                                            id="likeStates"
                                            name="likeStates">
                                        <option value="">Select Like State</option>
                                        <option value="liked">Liked</option>
                                        <option value="disliked">Disliked</option>
                                        <option value="neutral">Neutral</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="uploadContentStatus" class="form-label">Upload Content Status</label>
                                    <select class="form-control" 
                                            id="uploadContentStatus"
                                            name="uploadContentStatus">
                                        <option value="" selected>Default (null)</option>
                                        <option value="pending">Pending Upload</option>
                                        <option value="uploading">Uploading</option>
                                        <option value="uploaded">Uploaded</option>
                                        <option value="upload-failed">Upload Failed</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="commentStates" class="form-label">Comment States</label>
                                <textarea class="form-control" 
                                          id="commentStates" 
                                          name="commentStates"
                                          placeholder="Default (null) - Enter comments if needed..."
                                          rows="3"></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary me-2" onclick="hideContentForm()">Cancel</button>
                                <button type="submit" class="btn-save">Save Content Catalog Entry</button>
                            </div>
                        </form>

                        <!-- Recent Records Section -->
                        <div class="recent-records-section mt-5">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="section-subtitle">Recent Content Records</h4>
                                <a href="#" class="btn btn-sm btn-outline-primary" onclick="refreshRecentContent()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </a>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm recent-records-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllContent" class="form-check-input" onchange="toggleAllSelections('content')">
                                            </th>
                                            <th>Media Name</th>
                                            <th>Link/Description</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Priority</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentContentRecords">
                                        <tr th:each="content : ${recentContentRecords}" th:if="${contentStat.index < 10}">
                                            <td>
                                                <input type="checkbox" class="form-check-input content-checkbox" th:data-id="${content.id}" onchange="updateBulkActions()">
                                            </td>
                                            <td th:text="${content.mediaCatalogName}">Sample Content</td>
                                            <td>
                                                <div class="content-link-cell">
                                                    <a th:if="${content.link != null and !#strings.isEmpty(content.link)}" 
                                                       th:href="${content.link}" 
                                                       th:text="${#strings.abbreviate(content.link, 40)}"
                                                       target="_blank"
                                                       class="text-decoration-none content-link"
                                                       th:title="${content.link}">
                                                        Sample Link
                                                    </a>
                                                    <span th:if="${content.link == null or #strings.isEmpty(content.link)}" 
                                                          class="text-muted">No link provided</span>
                                                </div>
                                            </td>
                                            <td><span class="badge bg-secondary" th:text="${content.mediaCatalogType}">MOVIE</span></td>
                                            <td>
                                                <span class="badge" 
                                                      th:class="${'badge ' + (content.status == 'DOWNLOADED' ? 'bg-success' : content.status == 'NEW' ? 'bg-info' : content.status == 'ERROR' ? 'bg-danger' : 'bg-warning')}"
                                                      th:text="${content.status}">NEW</span>
                                            </td>
                                            <td>
                                                <span class="badge" 
                                                      th:class="${'badge ' + (content.priority == 'HIGH' ? 'bg-danger' : content.priority == 'MEDIUM' ? 'bg-warning' : 'bg-secondary')}"
                                                      th:text="${content.priority}">MEDIUM</span>
                                            </td>
                                            <td th:text="${#temporals.format(content.createdOn, 'dd-MM HH:mm')}">24-08 14:30</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editContentRecord(this)" 
                                                        th:data-id="${content.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteContentRecord(${content.id})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Catalog Tab -->
                <div class="tab-content" id="add-entry">
                    <div class="form-container">
                        <!-- Action Bar -->
                        <div class="action-bar mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="section-title mb-0">Upload Catalog Management</h2>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary me-2" onclick="showAddUploadForm()">
                                        <i class="fas fa-plus me-2"></i>Add New Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="showUpdateUploadForm()">
                                        <i class="fas fa-edit me-2"></i>Update Existing
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="showBulkUploadModal('upload')">
                                        <i class="fas fa-file-upload me-2"></i>Bulk Upload
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="toggleUploadSearch()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="refreshUploadTable()">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Bar (Initially Hidden) -->
                        <div id="uploadSearchBar" class="search-bar mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="uploadSearchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="uploadSearchType">
                                        <option value="">All Types</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-control" id="uploadSearchStatus">
                                        <option value="">All Status</option>
                                        <option value="completed">Completed</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="uploaded">Uploaded</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="uploadSearchLink" placeholder="Search by link...">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-primary w-100" onclick="searchUpload()">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add/Edit Form (Initially Hidden) -->
                        <div id="uploadFormContainer" style="display: none;">
                        <form th:action="@{/dashboard/upload-catalog}" method="post" class="entry-form" id="uploadForm">
                            <div class="form-group">
                                <label for="contentCatalogLink" class="form-label">Content Catalog Link / Description</label>
                                <textarea class="form-control" 
                                          id="contentCatalogLink" 
                                          name="contentCatalogLink"
                                          placeholder="Enter content catalog link or text description..." 
                                          rows="3"
                                          required></textarea>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        You can enter a URL link or any text description for the content catalog
                                    </small>
                                </div>
                            </div>

                            <!-- Media Catalog Fields (Moved Above Content ID) -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="uploadMediaCatalogType" class="form-label">Media Catalog Type</label>
                                    <select class="form-control" 
                                            id="uploadMediaCatalogType" 
                                            name="mediaCatalogType"
                                            required>
                                        <option value="">Select Type</option>
                                        <option value="movie">Movie</option>
                                        <option value="album">Album</option>
                                        <option value="web-series">Web Series</option>
                                        <option value="documentary">Documentary</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="uploadMediaCatalogName" class="form-label">Media Catalog Name</label>
                                    <div class="position-relative">
                                        <input type="text" 
                                               class="form-control" 
                                               id="uploadMediaCatalogName" 
                                               name="mediaCatalogName"
                                               placeholder="Type name or initials to search..." 
                                               autocomplete="off"
                                               required>
                                        <div id="uploadMediaCatalogNameDropdown" class="dropdown-menu"></div>
                                    </div>
                                    <div id="uploadMediaCatalogNameStatus" class="mt-1" style="display: none;">
                                        <small class="text-info"><span id="uploadStatusMessage"></span></small>
                                    </div>
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Search by full name or initials (e.g., "AB" for "Avengers Endgame")
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Linked Content Display (New Feature) -->
                            <div id="linkedContentSection" class="form-group" style="display: none;">
                                <label class="form-label">
                                    <i class="fas fa-link me-2"></i>Linked Content for Selected Media
                                </label>
                                <div id="linkedContentList" class="linked-content-container">
                                    <!-- Linked content will be populated here -->
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Content records linked to the selected media catalog will appear above
                                    </small>
                                </div>
                            </div>

                            <!-- Content ID Field (Moved Below Media Catalog) -->
                            <div class="form-group">
                                <label for="contentBlock" class="form-label">
                                    Content ID / Content Block 
                                    <span class="text-muted">(Optional)</span>
                                </label>
                                <div class="position-relative">
                                    <input type="text" 
                                           class="form-control" 
                                           id="contentBlock" 
                                           name="contentBlock"
                                           placeholder="Type to search from Content Catalog or leave empty..." 
                                           autocomplete="off">
                                    <div id="contentBlockDropdown" class="dropdown-menu"></div>
                                </div>
                                <div id="contentBlockStatus" class="mt-1" style="display: none;">
                                    <small class="text-info"><span id="contentBlockMessage"></span></small>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        You can leave this empty to upload without linking to specific content
                                    </small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contentCatalogLocation" class="form-label">Content Catalog Location</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="contentCatalogLocation" 
                                           name="contentCatalogLocation"
                                           placeholder="Content storage location">
                                </div>

                                <div class="form-group">
                                    <label for="uploadCatalogLocation" class="form-label">Upload Catalog Location</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="uploadCatalogLocation" 
                                           name="uploadCatalogLocation"
                                           placeholder="Upload destination location">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="uploadStatus" class="form-label">Upload Status</label>
                                <select class="form-control" 
                                        id="uploadStatus" 
                                        name="uploadStatus"
                                        required>
                                    <option value="">Select Status</option>
                                    <option value="new">New</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="uploaded">Uploaded</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="uploadCatalogCaption" class="form-label">Upload Catalog Caption</label>
                                <textarea class="form-control" 
                                          id="uploadCatalogCaption" 
                                          name="uploadCatalogCaption"
                                          placeholder="Enter caption for the upload catalog..."
                                          rows="4"></textarea>
                            </div>

                            <button type="submit" class="btn-save">
                                Save Upload Catalog Entry
                            </button>
                        </form>
                        </div>

                        <!-- Recent Records -->
                        <div id="uploadRecordsContainer" class="records-container">
                            <h3 class="records-title">Recent Upload Records</h3>
                            <div class="table-container">
                                <table class="records-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllUpload" class="form-check-input" onchange="toggleAllSelections('upload')">
                                            </th>
                                            <th>Content Block ID</th>
                                            <th>Content Link/Description</th>
                                            <th>Media Type</th>
                                            <th>Media Name</th>
                                            <th>Content Location</th>
                                            <th>Upload Location</th>
                                            <th>Upload Status</th>
                                            <th>Caption</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentUploadRecords">
                                        <!-- Upload records will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- States Catalog Tab -->
                <div class="tab-content" id="states-catalog">
                    <div class="form-container">
                        <h2 class="section-title">States Catalog - User Analytics</h2>
                        <form class="entry-form">
                            <!-- Basic Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="views" class="form-label">Views</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="views" 
                                           placeholder="Total views count" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="subscribers" class="form-label">Subscribers</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="subscribers" 
                                           placeholder="Total subscribers" 
                                           min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="interactions" class="form-label">Interactions</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="interactions" 
                                           placeholder="Total interactions" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="totalContent" class="form-label">Total Content</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="totalContent" 
                                           placeholder="Total content pieces" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Reach & Engagement Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reach" class="form-label">Reach</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="reach" 
                                           placeholder="Unique accounts reached" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="impressions" class="form-label">Impressions</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="impressions" 
                                           placeholder="Total views (including repeats)" 
                                           min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="profileVisits" class="form-label">Profile Visits</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="profileVisits" 
                                           placeholder="Profile visits count" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="websiteClicks" class="form-label">Website Clicks</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="websiteClicks" 
                                           placeholder="Website clicks count" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Contact Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emailClicks" class="form-label">Email Clicks</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="emailClicks" 
                                           placeholder="Email clicks count" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="callClicks" class="form-label">Call Clicks</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="callClicks" 
                                           placeholder="Call clicks count" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Growth Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="followersGained" class="form-label">Followers Gained</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="followersGained" 
                                           placeholder="New followers gained" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="followersLost" class="form-label">Followers Lost</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="followersLost" 
                                           placeholder="Followers lost" 
                                           min="0">
                                </div>
                            </div>

                            <!-- Content-Specific Metrics -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reelsCount" class="form-label">Reels Count</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="reelsCount" 
                                           placeholder="Number of reels posted till date" 
                                           min="0">
                                </div>

                                <div class="form-group">
                                    <label for="storiesCount" class="form-label">Stories Count</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="storiesCount" 
                                           placeholder="Number of stories till date" 
                                           min="0">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="avgEngagementRate" class="form-label">Average Engagement Rate (%)</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="avgEngagementRate" 
                                       placeholder="Average engagement rate (e.g., 5.25)" 
                                       step="0.01" 
                                       min="0" 
                                       max="100">
                            </div>

                            <button type="submit" class="btn-save">
                                Save States Catalog Entry
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Dashboard Tab -->
                <div class="tab-content" id="dashboard">
                    <div class="dashboard-section">
                        <h2 class="section-title">Dashboard</h2>
                        
                        <div class="table-container">
                            <table class="dashboard-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Instagram Link</th>
                                        <th>Movie Name</th>
                                        <th>Category</th>
                                        <th>Created On</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="link, linkStat : ${activeLinks}" th:if="${linkStat.index < 10}">
                                        <td th:text="${linkStat.index + 1}">1</td>
                                        <td>
                                            <a th:href="${link.instagramLink}" 
                                               target="_blank" 
                                               class="instagram-link"
                                               th:onclick="'trackClick(' + ${link.id} + ')'">
                                                <span th:text="${#strings.abbreviate(link.instagramLink, 30)}">https://instagram.com</span>
                                            </a>
                                        </td>
                                        <td th:text="${link.movieName}">Inception</td>
                                        <td>
                                            <span class="category-badge" th:text="${link.category}">Action</span>
                                        </td>
                                        <td th:text="${#temporals.format(link.createdAt, 'dd-MM-yyyy')}">24-08-2025</td>
                                        <td class="actions-cell">
                                            <button class="btn-edit" onclick="editLink(this)" 
                                                    th:data-id="${link.id}"
                                                    th:data-movie="${link.movieName}"
                                                    th:data-category="${link.category}"
                                                    th:data-link="${link.instagramLink}"
                                                    th:data-description="${link.description}">
                                                Edit
                                            </button>
                                            <form th:action="@{/dashboard/link/{id}/delete(id=${link.id})}" 
                                                  method="post" 
                                                  class="d-inline">
                                                <button type="submit" 
                                                        class="btn-delete"
                                                        onclick="return confirm('Are you sure you want to delete this link?')">
                                                    Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Empty State -->
                            <div th:unless="${activeLinks}" class="empty-state">
                                <i class="fab fa-instagram"></i>
                                <h3>No Instagram links added yet</h3>
                                <p>Start by adding your first movie Instagram link!</p>
                                <button class="btn-add-first" onclick="showAddEntry()">
                                    <i class="fas fa-plus me-2"></i>Add Your First Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Instagram Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm" method="post">
                        <div class="form-group">
                            <label for="editInstagramLink" class="form-label">Instagram Link</label>
                            <input type="url" class="form-control" id="editInstagramLink" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMovieName" class="form-label">Movie Name</label>
                                <input type="text" class="form-control" id="editMovieName" required>
                            </div>
                            <div class="form-group">
                                <label for="editCategory" class="form-label">Category</label>
                                <select class="form-control" id="editCategory" required>
                                    <option th:each="cat : ${predefinedCategories}" 
                                            th:value="${cat}" 
                                            th:text="${cat}">Category</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="editForm" class="btn-save">Update Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Upload Modal -->
    <div class="modal fade" id="editUploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Upload Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUploadForm" method="post">
                        <div class="form-group">
                            <label for="editContentCatalogLink" class="form-label">Content Catalog Link / Description</label>
                            <textarea class="form-control" 
                                      id="editContentCatalogLink" 
                                      name="contentCatalogLink"
                                      placeholder="Enter content catalog link or text description..." 
                                      rows="3"
                                      required></textarea>
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    You can enter a URL link or any text description for the content catalog
                                </small>
                            </div>
                        </div>

                        <!-- Media Catalog Fields -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMediaCatalogType" class="form-label">Media Catalog Type</label>
                                <select class="form-control" 
                                        id="editMediaCatalogType" 
                                        name="mediaCatalogType"
                                        required>
                                    <option value="">Select Type</option>
                                    <option value="movie">Movie</option>
                                    <option value="album">Album</option>
                                    <option value="web-series">Web Series</option>
                                    <option value="documentary">Documentary</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="editMediaCatalogName" class="form-label">Media Catalog Name</label>
                                <div class="position-relative">
                                    <input type="text" 
                                           class="form-control" 
                                           id="editMediaCatalogName" 
                                           name="mediaCatalogName"
                                           placeholder="Type name or initials to search..." 
                                           autocomplete="off"
                                           required>
                                    <div id="editMediaCatalogDropdown" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Search by full name or initials (e.g., "AB" for "Avengers Endgame")
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Content ID Field -->
                        <div class="form-group">
                            <label for="editContentBlock" class="form-label">
                                Content ID / Content Block 
                                <span class="text-muted">(Optional)</span>
                            </label>
                            <div class="position-relative">
                                <input type="text" 
                                       class="form-control" 
                                       id="editContentBlock" 
                                       name="contentBlock"
                                       placeholder="Type to search from Content Catalog or leave empty..." 
                                       autocomplete="off">
                                <div id="editContentBlockDropdown" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    You can leave this empty to upload without linking to specific content
                                </small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editContentCatalogLocation" class="form-label">Content Catalog Location</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="editContentCatalogLocation" 
                                       name="contentCatalogLocation"
                                       placeholder="Content storage location">
                            </div>

                            <div class="form-group">
                                <label for="editUploadCatalogLocation" class="form-label">Upload Catalog Location</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="editUploadCatalogLocation" 
                                       name="uploadCatalogLocation"
                                       placeholder="Upload destination location">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editUploadStatus" class="form-label">Upload Status</label>
                            <select class="form-control" 
                                    id="editUploadStatus" 
                                    name="uploadStatus"
                                    required>
                                <option value="">Select Status</option>
                                <option value="new">New</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="uploaded">Uploaded</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editUploadCatalogCaption" class="form-label">Upload Catalog Caption</label>
                            <textarea class="form-control" 
                                      id="editUploadCatalogCaption" 
                                      name="uploadCatalogCaption"
                                      placeholder="Enter caption for the upload catalog..."
                                      rows="4"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="editUploadForm" class="btn-save">Update Upload Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div class="modal fade" id="bulkUploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkUploadModalTitle">Bulk Upload</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-file-download me-2 text-primary"></i>Download Templates
                            </h6>
                            <div class="template-downloads mb-4">
                                <p class="text-muted mb-3">Download template files to see the required format:</p>
                                <div class="btn-group-vertical w-100" id="templateDownloadButtons">
                                    <!-- Template download buttons will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-file-upload me-2 text-success"></i>Upload File
                            </h6>
                            <form id="bulkUploadForm" method="post" enctype="multipart/form-data">
                                <div class="form-group mb-3">
                                    <label for="bulkUploadFile" class="form-label">Select File</label>
                                    <input type="file" 
                                           class="form-control" 
                                           id="bulkUploadFile" 
                                           name="file" 
                                           accept=".csv,.xlsx,.xls,.json" 
                                           required>
                                    <div class="form-text">
                                        Supported formats: CSV, Excel (.xlsx/.xls), JSON
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Important:</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Make sure your file follows the template format exactly</li>
                                            <li>For Content Catalog uploads, linked Upload records will be created automatically</li>
                                            <li>Invalid rows will be skipped and reported in the results</li>
                                            <li>Large files may take a few moments to process</li>
                                        </ul>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%">
                                Processing...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="bulkUploadForm" class="btn-save">
                        <i class="fas fa-upload me-2"></i>Upload & Process
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Cleanup Confirmation Modal -->
    <div class="modal fade" id="cleanupConfirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirm Database Cleanup
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-warning me-2"></i>
                        <strong>Warning:</strong> This action is irreversible!
                    </div>
                    <p><strong>This will permanently delete ALL data from:</strong></p>
                    <ul>
                        <li> All Content Catalog entries</li>
                        <li> All Upload Catalog entries</li>
                        <li> All Media Catalog entries</li>
                        <li> All linked relationships between records</li>
                    </ul>
                    <p class="mt-3"><strong>Are you sure you want to proceed?</strong></p>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="confirmCleanup">
                        <label class="form-check-label" for="confirmCleanup">
                            I understand this will delete all data and cannot be undone
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <form id="cleanupForm" method="post" action="/dashboard/cleanup-database" style="display: inline;">
                        <button type="submit" class="btn btn-danger" id="confirmCleanupBtn" disabled>
                            <i class="fas fa-trash-alt me-2"></i>Yes, Clean Database
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/dashboard.js}"></script>

    <script>
        // Tab switching functionality
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Update active button
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Track click function
        function trackClick(linkId) {
            fetch('/dashboard/link/' + linkId + '/click', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
            }).then(response => response.text())
              .then(data => console.log('Click tracked:', data))
              .catch(error => console.error('Error tracking click:', error));
        }

        // Show add entry tab
        function showAddEntry() {
            document.querySelector('[data-tab="add-entry"]').click();
        }

        // Edit link functionality
        function editLink(button) {
            const id = button.getAttribute('data-id');
            const movie = button.getAttribute('data-movie');
            const category = button.getAttribute('data-category');
            const link = button.getAttribute('data-link');
            const description = button.getAttribute('data-description');

            document.getElementById('editMovieName').value = movie;
            document.getElementById('editCategory').value = category;
            document.getElementById('editInstagramLink').value = link;
            document.getElementById('editDescription').value = description || '';
            
            document.getElementById('editForm').action = '/dashboard/link/' + id + '/edit';
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        // Media Catalog Functions
        function showAddMediaForm() {
            // Hide records container and show form
            document.getElementById('mediaRecordsContainer').style.display = 'none';
            document.getElementById('mediaFormContainer').style.display = 'block';
            
            // Clear form for new entry
            document.getElementById('mediaForm').reset();
            
            // Update form title and button
            document.querySelector('#mediaFormContainer h3')?.remove();
            const title = document.createElement('h3');
            title.className = 'section-subtitle mb-3';
            title.innerHTML = '<i class="fas fa-plus me-2"></i>Add New Media';
            document.getElementById('mediaFormContainer').insertBefore(title, document.getElementById('mediaForm'));
            
            // Scroll to form
            document.getElementById('mediaFormContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function showUpdateMediaForm() {
            alert('Click the edit button () next to any record in the table below to update it.');
        }

        function cancelMediaForm() {
            // Hide form and show records
            document.getElementById('mediaFormContainer').style.display = 'none';
            document.getElementById('mediaRecordsContainer').style.display = 'block';
        }

        function toggleMediaSearch() {
            const searchBar = document.getElementById('mediaSearchBar');
            if (searchBar.style.display === 'none') {
                searchBar.style.display = 'block';
            } else {
                searchBar.style.display = 'none';
            }
        }

        function searchMedia() {
            const name = document.getElementById('mediaSearchName').value;
            const type = document.getElementById('mediaSearchType').value;
            const status = document.getElementById('mediaSearchStatus').value;
            
            // Call API or refresh page with search parameters
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (type) params.append('type', type);
            if (status) params.append('status', status);
            
            fetch(`/api/media-catalog/search?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    // Update the recent records table with search results
                    updateMediaRecordsTable(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function refreshRecentMedia() {
            fetch('/api/media-catalog?limit=10&sort=updatedOn:desc')
                .then(response => response.json())
                .then(data => updateMediaRecordsTable(data))
                .catch(error => console.error('Error:', error));
        }

        function editMediaRecord(button) {
            const id = button.getAttribute('data-id');
            
            // Hide records container and show form
            document.getElementById('mediaRecordsContainer').style.display = 'none';
            document.getElementById('mediaFormContainer').style.display = 'block';
            
            // Update form title for editing
            document.querySelector('#mediaFormContainer h3')?.remove();
            const title = document.createElement('h3');
            title.className = 'section-subtitle mb-3';
            title.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Media Record';
            document.getElementById('mediaFormContainer').insertBefore(title, document.getElementById('mediaForm'));
            
            // Add hidden field for ID (for update)
            let idField = document.getElementById('mediaId');
            if (!idField) {
                idField = document.createElement('input');
                idField.type = 'hidden';
                idField.id = 'mediaId';
                idField.name = 'id';
                document.getElementById('mediaForm').appendChild(idField);
            }
            idField.value = id;
            
            // Fetch media details and populate form
            fetch(`/api/media-catalog/${id}`)
                .then(response => response.json())
                .then(data => {
                    // Populate form fields with data
                    document.getElementById('mediaName').value = data.name || '';
                    document.getElementById('mediaType').value = data.type ? data.type.toLowerCase().replace('_', '-') : '';
                    document.getElementById('platform').value = data.platform || '';
                    document.getElementById('isDownloaded').value = data.downloadStatus ? data.downloadStatus.toLowerCase().replace('_', '-') : '';
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('mediaDescription').value = data.description || '';
                    document.getElementById('funFacts').value = data.funFacts || '';
                    
                    // Update form action for update
                    document.getElementById('mediaForm').action = `/dashboard/media-catalog/${id}/edit`;
                    
                    // Scroll to form
                    document.getElementById('mediaFormContainer').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error loading media record', 'error');
                });
        }

        function deleteMediaRecord(id) {
            if (confirm('Are you sure you want to delete this media record?')) {
                fetch(`/api/media-catalog/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            refreshRecentMedia();
                            showNotification('Media record deleted successfully', 'success');
                        } else {
                            showNotification('Error deleting media record', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error deleting media record', 'error');
                    });
            }
        }

        // Content Catalog Functions
        function showAddContentForm() {
            hideRecentRecordsSections();
            const form = document.getElementById('contentCatalogForm');
            form.style.display = 'block';
            form.reset();
            form.scrollIntoView({ behavior: 'smooth' });
            initializeMediaCatalogNameAutocomplete();
        }

        function hideContentForm() {
            const form = document.getElementById('contentCatalogForm');
            form.style.display = 'none';
            
            // Reset form to add mode
            form.action = '/dashboard/content-catalog';
            form.reset();
            
            // Reset button text
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Save Content Catalog Entry';
            }
            
            // Clear status message
            clearStatusMessage();
            
            showRecentRecordsSections();
        }

        function showUpdateContentForm() {
            alert('Select a content record from Recent Records below to update');
        }

        function toggleContentSearch() {
            const searchBar = document.getElementById('contentSearchBar');
            searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
        }

        function searchContent() {
            const name = document.getElementById('contentSearchName').value;
            const type = document.getElementById('contentSearchType').value;
            const status = document.getElementById('contentSearchStatus').value;
            const priority = document.getElementById('contentSearchPriority').value;
            
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (type) params.append('type', type);
            if (status) params.append('status', status);
            if (priority) params.append('priority', priority);
            
            fetch(`/api/content-catalog/search?${params.toString()}`)
                .then(response => response.json())
                .then(data => updateContentRecordsTable(data))
                .catch(error => console.error('Error:', error));
        }

        function refreshRecentContent() {
            fetch('/api/content-catalog')
                .then(response => response.json())
                .then(data => {
                    // Sort by createdOn descending and take first 10
                    const sortedData = data.sort((a, b) => new Date(b.createdOn) - new Date(a.createdOn)).slice(0, 10);
                    updateContentRecordsTable(sortedData);
                })
                .catch(error => console.error('Error loading content records:', error));
        }

        function editContentRecord(button) {
            const id = button.getAttribute('data-id');
            
            // Fetch the content record data
            fetch(`/api/content-catalog/${id}`)
                .then(response => response.json())
                .then(content => {
                    // Show the form
                    showAddContentForm();
                    
                    // Populate form fields with existing data
                    document.getElementById('contentLink').value = content.link || '';
                    document.getElementById('mediaCatalogType').value = content.mediaCatalogType?.toLowerCase().replace('_', '-') || '';
                    document.getElementById('mediaCatalogName').value = content.mediaCatalogName || '';
                    document.getElementById('contentStatus').value = content.status?.toLowerCase().replace('_', '-') || '';
                    document.getElementById('contentPriority').value = content.priority?.toLowerCase() || 'medium';
                    document.getElementById('contentLocation').value = content.location || '';
                    document.getElementById('metadata').value = content.metadata || '';
                    document.getElementById('likeStates').value = content.likeStates?.toLowerCase() || '';
                    document.getElementById('commentStates').value = content.commentStates || '';
                    document.getElementById('uploadContentStatus').value = content.uploadContentStatus?.toLowerCase().replace('_', '-') || '';
                    
                    // Update form to edit mode
                    const form = document.getElementById('contentCatalogForm');
                    form.action = `/dashboard/content-catalog/${id}/edit`;
                    
                    // Update button text
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.textContent = 'Update Content Catalog Entry';
                    }
                    
                    // Update status message
                    updateStatusMessage(`Editing: "${content.mediaCatalogName}"`, 'info');
                    
                    showNotification(`Loaded content record for editing: ${content.mediaCatalogName}`, 'info');
                })
                .catch(error => {
                    console.error('Error loading content record:', error);
                    showNotification('Error loading content record for editing', 'danger');
                });
        }

        function deleteContentRecord(id) {
            if (confirm('Are you sure you want to delete this content record?')) {
                fetch(`/api/content-catalog/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            refreshRecentContent();
                            showNotification('Content record deleted successfully', 'success');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // Upload Catalog Functions
        function showAddUploadForm() {
            // Hide records container and show form
            document.getElementById('uploadRecordsContainer').style.display = 'none';
            document.getElementById('uploadFormContainer').style.display = 'block';
            
            // Reset form
            const form = document.getElementById('uploadForm');
            if (form) {
                form.reset();
                form.action = '/dashboard/upload-catalog'; // Reset to create mode
                
                // Update button text
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = 'Save Upload Catalog Entry';
                }
                
                // Clear status message
                const statusDiv = document.getElementById('uploadMediaCatalogNameStatus');
                if (statusDiv) statusDiv.style.display = 'none';
                
                form.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Initialize media catalog name autocomplete for upload form
            setupUploadMediaCatalogAutocomplete();
            
            // Initialize content block autocomplete
            setupContentBlockAutocomplete();
            
            // Setup auto-resize for content catalog link textarea
            setupTextareaAutoResize();
        }

        function hideUploadForm() {
            document.getElementById('uploadFormContainer').style.display = 'none';
            document.getElementById('uploadRecordsContainer').style.display = 'block';
        }

        function showUpdateUploadForm() {
            alert('Select an upload record from Recent Records below to update');
        }

        function toggleUploadSearch() {
            const searchBar = document.getElementById('uploadSearchBar');
            if (searchBar) {
                searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
            }
        }

        function searchUpload() {
            const name = document.getElementById('uploadSearchName')?.value || '';
            const type = document.getElementById('uploadSearchType')?.value || '';
            const status = document.getElementById('uploadSearchStatus')?.value || '';
            
            const params = new URLSearchParams();
            if (name) params.append('name', name);
            if (type) params.append('type', type);
            if (status) params.append('status', status);
            
            fetch(`/api/upload-catalog/search?${params.toString()}`)
                .then(response => response.json())
                .then(data => updateUploadRecordsTable(data))
                .catch(error => console.error('Error:', error));
        }

        function refreshRecentUpload() {
            showUploadRecordsLoading();
            fetch('/api/upload-catalog')
                .then(response => response.json())
                .then(data => {
                    // Sort by createdOn descending and take first 10
                    const sortedData = data.sort((a, b) => new Date(b.createdOn) - new Date(a.createdOn)).slice(0, 10);
                    updateUploadRecordsTable(sortedData);
                })
                .catch(error => {
                    console.error('Error loading upload records:', error);
                    const tbody = document.getElementById('recentUploadRecords');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr class="empty-state">
                                <td colspan="7">
                                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                    Error loading upload records. Please try again.
                                </td>
                            </tr>
                        `;
                    }
                });
        }

        function editUploadRecord(button) {
            const id = button.getAttribute('data-id');
            
            // Get upload record data from API
            fetch(`/api/upload-catalog/${id}`)
                .then(response => response.json())
                .then(upload => {
                    // Populate modal form with current data
                    const fields = {
                        'editContentCatalogLink': upload.contentCatalogLink || '',
                        'editContentBlock': upload.contentBlock || '',
                        'editMediaCatalogName': upload.mediaCatalogName || '',
                        'editMediaCatalogType': upload.mediaCatalogType ? upload.mediaCatalogType.toLowerCase().replace('_', '-') : '',
                        'editContentCatalogLocation': upload.contentCatalogLocation || '',
                        'editUploadCatalogLocation': upload.uploadCatalogLocation || '',
                        'editUploadStatus': upload.uploadStatus ? upload.uploadStatus.toLowerCase().replace('_', '-') : '',
                        'editUploadCatalogCaption': upload.uploadCatalogCaption || ''
                    };
                    
                    // Set values and apply styling fixes
                    Object.keys(fields).forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = fields[fieldId];
                            // Force visibility and styling
                            field.style.color = '#ffffff';
                            field.style.backgroundColor = '#2d3139';
                            field.style.borderColor = '#3a3f4b';
                            field.style.opacity = '1';
                            field.style.visibility = 'visible';
                            field.style.pointerEvents = 'auto';
                        }
                    });
                    
                    // Set form action for the specific record
                    document.getElementById('editUploadForm').action = `/dashboard/upload-catalog/${id}/edit`;
                    
                    // Show modal
                    const editUploadModal = new bootstrap.Modal(document.getElementById('editUploadModal'));
                    editUploadModal.show();
                    
                    // Apply additional styling fixes after modal is shown
                    setTimeout(() => {
                        document.querySelectorAll('#editUploadModal input, #editUploadModal select, #editUploadModal textarea').forEach(field => {
                            field.style.color = '#ffffff';
                            field.style.backgroundColor = '#2d3139';
                            field.style.borderColor = '#3a3f4b';
                            field.style.opacity = '1';
                            field.style.visibility = 'visible';
                            field.style.pointerEvents = 'auto';
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error fetching upload record:', error);
                    alert('Error loading upload record data');
                });
        }

        function deleteUploadRecord(id) {
            if (confirm('Are you sure you want to delete this upload record?')) {
                fetch(`/api/upload-catalog/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            refreshRecentUpload();
                            showNotification('Upload record deleted successfully', 'success');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        function updateUploadRecordsTable(data) {
            const tbody = document.getElementById('recentUploadRecords');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'empty-state';
                emptyRow.innerHTML = `
                    <td colspan="11">
                        <i class="fas fa-inbox me-2"></i>
                        No upload records found. Create your first upload entry above.
                    </td>
                `;
                tbody.appendChild(emptyRow);
                return;
            }
            
            data.slice(0, 10).forEach(upload => {
                const row = document.createElement('tr');
                
                // Format content link cell with icon
                let linkCell = '';
                if (upload.contentCatalogLink && upload.contentCatalogLink.trim() !== '') {
                    const truncatedLink = upload.contentCatalogLink.length > 50 ? upload.contentCatalogLink.substring(0, 50) + '...' : upload.contentCatalogLink;
                    linkCell = `<div class="content-link-cell">
                        <a href="${upload.contentCatalogLink}" target="_blank" class="content-link" title="${upload.contentCatalogLink}">
                            <i class="fas fa-external-link-alt me-1"></i>${truncatedLink}
                        </a>
                    </div>`;
                } else {
                    linkCell = '<div class="content-link-cell"><span class="text-muted"><i class="fas fa-file-text me-1"></i>No link provided</span></div>';
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input upload-checkbox" data-id="${upload.id}" onchange="updateBulkActions()"></td>
                    <td title="Content Block ID">${formatContentBlock(upload.contentBlock)}</td>
                    <td title="${upload.contentCatalogLink || 'No description available'}">${linkCell}</td>
                    <td><span class="badge bg-info" title="Media Type">${formatMediaType(upload.mediaCatalogType)}</span></td>
                    <td title="${upload.mediaCatalogName}" class="media-name-cell">${truncateText(upload.mediaCatalogName, 20)}</td>
                    <td title="Content Location" class="location-cell">${formatLocation(upload.contentCatalogLocation)}</td>
                    <td title="Upload Location" class="location-cell">${formatLocation(upload.uploadCatalogLocation)}</td>
                    <td><span class="badge ${getUploadStatusBadgeClass(upload.uploadStatus)}" title="Upload Status">${formatUploadStatus(upload.uploadStatus)}</span></td>
                    <td title="${upload.uploadCatalogCaption || 'No caption'}" class="caption-cell">${formatCaption(upload.uploadCatalogCaption)}</td>
                    <td title="Created Date" class="date-cell">${formatDate(upload.createdOn)}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editUploadRecord(this)" 
                                    data-id="${upload.id}" title="Edit Record">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUploadRecord(${upload.id})" 
                                    title="Delete Record">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatContentBlock(contentBlock) {
            if (!contentBlock) return '<span class="text-muted"></span>';
            return `<code class="text-primary">${contentBlock}</code>`;
        }

        function formatContentLink(contentLink) {
            if (!contentLink) return '<span class="text-muted">No content specified</span>';
            
            if (isValidUrl(contentLink)) {
                return `<a href="${contentLink}" target="_blank" class="text-decoration-none">
                    <i class="fas fa-external-link-alt me-1"></i>View Link
                </a>`;
            } else {
                return `<span class="text-muted">${truncateText(contentLink, 40)}</span>`;
            }
        }

        function formatMediaType(mediaType) {
            if (!mediaType) return 'Unknown';
            return mediaType.replace('_', ' ').toLowerCase()
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatUploadStatus(status) {
            if (!status) return 'Unknown';
            return status.replace('_', ' ').toLowerCase()
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatLocation(location) {
            if (!location || location.trim() === '') {
                return '<span class="text-muted"><i class="fas fa-folder-open me-1"></i>Not specified</span>';
            }
            return `<span class="location-text" title="${location}">
                <i class="fas fa-folder me-1"></i>${truncateText(location, 25)}
            </span>`;
        }

        function formatCaption(caption) {
            if (!caption || caption.trim() === '') {
                return '<span class="text-muted">No caption</span>';
            }
            return `<span class="caption-text" title="${caption}">
                <i class="fas fa-quote-left me-1"></i>${truncateText(caption, 30)}
            </span>`;
        }

        function showUploadRecordsLoading() {
            const tbody = document.getElementById('recentUploadRecords');
            if (!tbody) return;
            
            tbody.innerHTML = `
                <tr class="loading-state">
                    <td colspan="7">
                        <div class="loading-spinner"></div>
                        Loading upload records...
                    </td>
                </tr>
            `;
        }

        function getUploadStatusBadgeClass(status) {
            switch(status) {
                case 'NEW': return 'bg-info';
                case 'UPLOADED': return 'bg-success';
                case 'COMPLETED': return 'bg-success';
                case 'IN_PROGRESS': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        // Utility Functions
        function updateMediaRecordsTable(data) {
            const tbody = document.getElementById('recentMediaRecords');
            tbody.innerHTML = '';
            
            data.slice(0, 10).forEach(media => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="form-check-input media-checkbox" data-id="${media.id}" onchange="updateBulkActions()">
                    </td>
                    <td>${media.name}</td>
                    <td><span class="badge bg-secondary">${media.type}</span></td>
                    <td>${media.platform || 'N/A'}</td>
                    <td><span class="badge ${getStatusBadgeClass(media.downloadStatus)}">${media.downloadStatus}</span></td>
                    <td>${formatDate(media.updatedOn)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editMediaRecord(this)" data-id="${media.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMediaRecord(${media.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateContentRecordsTable(data) {
            const tbody = document.getElementById('recentContentRecords');
            tbody.innerHTML = '';
            
            data.slice(0, 10).forEach(content => {
                const row = document.createElement('tr');
                
                // Format link cell
                let linkCell = '';
                if (content.link && content.link.trim() !== '') {
                    const truncatedLink = content.link.length > 40 ? content.link.substring(0, 40) + '...' : content.link;
                    linkCell = `<a href="${content.link}" target="_blank" class="content-link" title="${content.link}">
                        <i class="fas fa-external-link-alt me-1"></i>${truncatedLink}
                    </a>`;
                } else {
                    linkCell = '<span class="text-muted"><i class="fas fa-file-text me-1"></i>No link provided</span>';
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="form-check-input content-checkbox" data-id="${content.id}" onchange="updateBulkActions()"></td>
                    <td>${content.mediaCatalogName}</td>
                    <td><div class="content-link-cell">${linkCell}</div></td>
                    <td><span class="badge bg-secondary">${content.mediaCatalogType}</span></td>
                    <td><span class="badge ${getContentStatusBadgeClass(content.status)}">${content.status}</span></td>
                    <td><span class="badge ${getPriorityBadgeClass(content.priority)}">${content.priority}</span></td>
                    <td>${formatDate(content.createdOn)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editContentRecord(this)" data-id="${content.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteContentRecord(${content.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'DOWNLOADED': return 'bg-success';
                case 'NOT_DOWNLOADED': return 'bg-warning';
                case 'PARTIALLY_DOWNLOADED': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        function getContentStatusBadgeClass(status) {
            switch(status) {
                case 'DOWNLOADED': return 'bg-success';
                case 'NEW': return 'bg-info';
                case 'ERROR': return 'bg-danger';
                case 'IN_PROGRESS': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'HIGH': return 'bg-danger';
                case 'MEDIUM': return 'bg-warning';
                case 'LOW': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '<span class="text-muted"></span>';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // If today, show time only
            if (date.toDateString() === now.toDateString()) {
                return `<span class="text-success" title="${date.toLocaleString()}">Today ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}</span>`;
            }
            
            // If yesterday, show "Yesterday"
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return `<span class="text-info" title="${date.toLocaleString()}">Yesterday</span>`;
            }
            
            // If within a week, show day name
            if (diffDays <= 7) {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return `<span class="text-muted" title="${date.toLocaleString()}">${dayNames[date.getDay()]}</span>`;
            }
            
            // Otherwise show date
            return `<span class="text-muted" title="${date.toLocaleString()}">${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}</span>`;
        }

        function showNotification(message, type = 'info') {
            // Create a toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }
        
        // Media Catalog Name Autocomplete Functionality
        let mediaCatalogNames = [];
        let isNewMediaCatalog = false;

        function initializeMediaCatalogNameAutocomplete() {
            // Fetch existing media catalog names
            fetch('/api/media-catalog/names')
                .then(response => response.json())
                .then(names => {
                    mediaCatalogNames = names;
                    setupAutocomplete();
                })
                .catch(error => console.error('Error fetching media catalog names:', error));
        }

        function setupAutocomplete() {
            const input = document.getElementById('mediaCatalogName');
            const dropdown = document.getElementById('mediaCatalogNameDropdown');
            
            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();
                dropdown.innerHTML = '';
                
                if (value.length < 1) {
                    dropdown.classList.remove('show');
                    clearStatusMessage();
                    return;
                }

                const filteredNames = mediaCatalogNames.filter(name => 
                    name.toLowerCase().includes(value)
                );

                if (filteredNames.length > 0) {
                    filteredNames.forEach(name => {
                        const item = document.createElement('button');
                        item.className = 'dropdown-item';
                        item.type = 'button';
                        item.textContent = name;
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            input.value = name;
                            dropdown.classList.remove('show');
                            isNewMediaCatalog = false;
                            updateStatusMessage(`Using existing: "${name}"`, 'success');
                            updateMediaTypeFromExisting(name);
                        });
                        dropdown.appendChild(item);
                    });
                    
                    // Check if current value exactly matches any existing name
                    const exactMatch = mediaCatalogNames.find(name => 
                        name.toLowerCase() === value
                    );
                    isNewMediaCatalog = !exactMatch;
                    
                    if (exactMatch) {
                        updateStatusMessage(`Using existing: "${exactMatch}"`, 'success');
                    } else {
                        updateStatusMessage(`Will create new: "${input.value}"`, 'warning');
                    }
                    
                    dropdown.classList.add('show');
                } else {
                    // No matches found - this will be a new entry
                    isNewMediaCatalog = true;
                    const newItem = document.createElement('button');
                    newItem.className = 'dropdown-item text-success';
                    newItem.type = 'button';
                    newItem.innerHTML = `<small><i class="fas fa-plus me-2"></i>Create new: "${input.value}"</small>`;
                    newItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        // Keep the current value in the input (it's already there)
                        dropdown.classList.remove('show');
                        isNewMediaCatalog = true;
                        updateStatusMessage(`Will create new: "${input.value}"`, 'warning');
                    });
                    dropdown.appendChild(newItem);
                    dropdown.classList.add('show');
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Hide dropdown on escape key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        function updateMediaTypeFromExisting(mediaName) {
            // Fetch media catalog details to auto-fill media type
            fetch(`/api/media-catalog/search?name=${encodeURIComponent(mediaName)}`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        const media = results[0];
                        const typeSelect = document.getElementById('mediaCatalogType');
                        if (typeSelect && media.type) {
                            typeSelect.value = media.type.toLowerCase().replace('_', '-');
                        }
                    }
                })
                .catch(error => console.error('Error fetching media details:', error));
        }

        // Upload Catalog Media Name Autocomplete
        let uploadMediaCatalogNames = [];
        let isNewUploadMediaCatalog = false;

        function setupUploadMediaCatalogAutocomplete() {
            // Fetch existing media catalog names
            fetch('/api/media-catalog/names')
                .then(response => response.json())
                .then(names => {
                    uploadMediaCatalogNames = names;
                    setupUploadAutocomplete();
                })
                .catch(error => console.error('Error fetching media catalog names:', error));
        }

        function setupUploadAutocomplete() {
            const input = document.getElementById('uploadMediaCatalogName');
            const dropdown = document.getElementById('uploadMediaCatalogNameDropdown');
            
            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();
                dropdown.innerHTML = '';
                
                if (value.length < 1) {
                    dropdown.classList.remove('show');
                    clearUploadStatusMessage();
                    return;
                }

                // Enhanced search: support both full name and initials matching
                const filteredNames = uploadMediaCatalogNames.filter(name => {
                    const lowerName = name.toLowerCase();
                    const lowerValue = value.toLowerCase();
                    
                    // Direct substring match
                    if (lowerName.includes(lowerValue)) {
                        return true;
                    }
                    
                    // Initials matching: extract first letters of each word
                    const initials = name.split(' ')
                        .map(word => word.charAt(0).toLowerCase())
                        .join('');
                    
                    return initials.includes(lowerValue);
                });

                if (filteredNames.length > 0) {
                    filteredNames.forEach(name => {
                        const item = document.createElement('button');
                        item.className = 'dropdown-item';
                        item.type = 'button';
                        item.textContent = name;
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            input.value = name;
                            dropdown.classList.remove('show');
                            isNewUploadMediaCatalog = false;
                            updateUploadStatusMessage(`Using existing: "${name}"`, 'success');
                            updateUploadMediaTypeFromExisting(name);
                            // Load linked content when media is selected
                            loadLinkedContentForMedia(name);
                        });
                        dropdown.appendChild(item);
                    });
                    
                    // Check if current value exactly matches any existing name
                    const exactMatch = uploadMediaCatalogNames.find(name => 
                        name.toLowerCase() === value
                    );
                    isNewUploadMediaCatalog = !exactMatch;
                    
                    if (exactMatch) {
                        updateUploadStatusMessage(`Using existing: "${exactMatch}"`, 'success');
                        // Load linked content for exact match
                        loadLinkedContentForMedia(exactMatch);
                    } else {
                        updateUploadStatusMessage(`Will create new: "${input.value}"`, 'warning');
                        // Hide linked content for new entries
                        hideLinkedContent();
                    }
                    
                    dropdown.classList.add('show');
                } else {
                    // No matches found - this will be a new entry
                    isNewUploadMediaCatalog = true;
                    const newItem = document.createElement('button');
                    newItem.className = 'dropdown-item text-success';
                    newItem.type = 'button';
                    newItem.innerHTML = `<small><i class="fas fa-plus me-2"></i>Create new: "${input.value}"</small>`;
                    newItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        // Keep the current value in the input (it's already there)
                        dropdown.classList.remove('show');
                        isNewUploadMediaCatalog = true;
                        updateUploadStatusMessage(`Will create new: "${input.value}"`, 'warning');
                    });
                    dropdown.appendChild(newItem);
                    dropdown.classList.add('show');
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Hide dropdown on escape key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        function updateUploadMediaTypeFromExisting(mediaName) {
            // Fetch media catalog details to auto-fill media type
            fetch(`/api/media-catalog/search?name=${encodeURIComponent(mediaName)}`)
                .then(response => response.json())
                .then(results => {
                    if (results.length > 0) {
                        const media = results[0];
                        const typeSelect = document.getElementById('uploadMediaCatalogType');
                        if (typeSelect && media.type) {
                            typeSelect.value = media.type.toLowerCase().replace('_', '-');
                        }
                        // Load linked content for this media
                        loadLinkedContentForMedia(mediaName);
                    }
                })
                .catch(error => console.error('Error fetching media details:', error));
        }

        // New function to load linked content when media catalog is selected
        function loadLinkedContentForMedia(mediaName) {
            if (!mediaName || mediaName.trim() === '') {
                hideLinkedContent();
                return;
            }

            // Show loading state
            showLinkedContentLoading();

            // Fetch linked content from Content Catalog
            fetch(`/api/content-catalog/search?mediaCatalogName=${encodeURIComponent(mediaName)}`)
                .then(response => response.json())
                .then(contentList => {
                    displayLinkedContent(contentList, mediaName);
                })
                .catch(error => {
                    console.error('Error fetching linked content:', error);
                    showLinkedContentError();
                });
        }

        function showLinkedContentLoading() {
            const section = document.getElementById('linkedContentSection');
            const container = document.getElementById('linkedContentList');
            
            if (section && container) {
                section.style.display = 'block';
                container.innerHTML = `
                    <div class="linked-content-loading">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading linked content...
                    </div>
                `;
            }
        }

        function displayLinkedContent(contentList, mediaName) {
            const section = document.getElementById('linkedContentSection');
            const container = document.getElementById('linkedContentList');
            
            if (!section || !container) return;

            section.style.display = 'block';

            if (!contentList || contentList.length === 0) {
                container.innerHTML = `
                    <div class="linked-content-empty">
                        <i class="fas fa-info-circle me-2"></i>
                        No content records found for "${mediaName}"
                    </div>
                `;
                return;
            }

            let contentHtml = '';
            contentList.forEach(content => {
                const statusClass = getContentStatusClass(content.status);
                const truncatedLink = content.link ? 
                    (content.link.length > 50 ? content.link.substring(0, 50) + '...' : content.link) : 
                    'No link provided';

                contentHtml += `
                    <div class="linked-content-item" onclick="selectLinkedContent(${content.id}, '${content.link || ''}')">
                        <div class="linked-content-info">
                            <div class="linked-content-id">ID: ${content.id}</div>
                            <div class="linked-content-link" title="${content.link || 'No link provided'}">
                                ${content.link ? 
                                    `<i class="fas fa-link me-1"></i>${truncatedLink}` : 
                                    `<i class="fas fa-file-text me-1"></i>Text content`
                                }
                            </div>
                        </div>
                        <div class="linked-content-status">
                            <span class="badge ${statusClass}">${content.status || 'Unknown'}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = contentHtml;
        }

        function selectLinkedContent(contentId, contentLink) {
            // Update the Content ID field
            const contentBlockInput = document.getElementById('contentBlock');
            if (contentBlockInput) {
                contentBlockInput.value = contentId;
                updateContentBlockStatusMessage(`Selected: Content ID ${contentId}`, 'success');
            }

            // Auto-fill the content catalog link if it's empty
            const linkTextarea = document.getElementById('contentCatalogLink');
            if (linkTextarea && contentLink && !linkTextarea.value.trim()) {
                linkTextarea.value = contentLink;
            }

            // Update visual selection
            document.querySelectorAll('.linked-content-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.linked-content-item').classList.add('selected');

            // Show feedback
            showNotification(`Content ID ${contentId} selected and auto-filled`, 'success');
        }

        function hideLinkedContent() {
            const section = document.getElementById('linkedContentSection');
            if (section) {
                section.style.display = 'none';
            }
        }

        function showLinkedContentError() {
            const container = document.getElementById('linkedContentList');
            if (container) {
                container.innerHTML = `
                    <div class="linked-content-empty text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading linked content. Please try again.
                    </div>
                `;
            }
        }

        function getContentStatusClass(status) {
            switch(status?.toUpperCase()) {
                case 'DOWNLOADED': return 'bg-success';
                case 'NEW': return 'bg-info';
                case 'IN_PROGRESS': return 'bg-warning';
                case 'ERROR': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function updateUploadStatusMessage(message, type) {
            const statusDiv = document.getElementById('uploadMediaCatalogNameStatus');
            const messageSpan = document.getElementById('uploadStatusMessage');
            
            if (statusDiv && messageSpan) {
                messageSpan.textContent = message;
                statusDiv.className = `mt-1 text-${type}`;
                statusDiv.style.display = 'block';
            }
        }

        function clearUploadStatusMessage() {
            const statusDiv = document.getElementById('uploadMediaCatalogNameStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Content Block Autocomplete
        let contentBlocks = [];

        function setupContentBlockAutocomplete() {
            const input = document.getElementById('contentBlock');
            const dropdown = document.getElementById('contentBlockDropdown');
            
            if (!input || !dropdown) return;

            input.addEventListener('input', function() {
                const value = this.value.trim();
                dropdown.innerHTML = '';
                
                if (value.length < 2) {
                    dropdown.classList.remove('show');
                    clearContentBlockStatusMessage();
                    return;
                }

                // Fetch content blocks with search
                fetch(`/api/content-catalog/content-blocks?search=${encodeURIComponent(value)}`)
                    .then(response => response.json())
                    .then(data => {
                        contentBlocks = data;
                        displayContentBlockOptions(data, value, dropdown);
                    })
                    .catch(error => {
                        console.error('Error fetching content blocks:', error);
                        updateContentBlockStatusMessage('Error loading content data', 'danger');
                    });
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Hide dropdown on escape key
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        function displayContentBlockOptions(data, searchValue, dropdown) {
            if (data.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item text-muted">No content found</div>';
                dropdown.classList.add('show');
                return;
            }

            data.slice(0, 10).forEach(content => {
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.type = 'button';
                
                // Create display text with ID and name
                const displayText = `${content.id} - ${content.mediaCatalogName}`;
                const statusBadge = getContentStatusBadge(content.status);
                
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>ID: ${content.id}</strong><br>
                            <small class="text-muted">${content.mediaCatalogName}</small>
                        </div>
                        <span class="badge ${statusBadge}">${content.status}</span>
                    </div>
                `;
                
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const input = document.getElementById('contentBlock');
                    input.value = `${content.id}`;
                    dropdown.classList.remove('show');
                    updateContentBlockStatusMessage(`Selected: "${content.mediaCatalogName}" (ID: ${content.id})`, 'success');
                    
                    // Auto-fill content catalog link/description if available
                    if (content.link) {
                        const linkTextarea = document.getElementById('contentCatalogLink');
                        if (linkTextarea && !linkTextarea.value.trim()) {
                            linkTextarea.value = content.link;
                        }
                    }
                });
                
                dropdown.appendChild(item);
            });
            
            dropdown.classList.add('show');
        }

        function getContentStatusBadge(status) {
            switch(status?.toUpperCase()) {
                case 'COMPLETED': return 'bg-success';
                case 'IN_PROGRESS': return 'bg-warning';
                case 'PENDING': return 'bg-info';
                case 'ON_HOLD': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }

        function updateContentBlockStatusMessage(message, type) {
            const statusDiv = document.getElementById('contentBlockStatus');
            const messageSpan = document.getElementById('contentBlockMessage');
            
            if (statusDiv && messageSpan) {
                messageSpan.textContent = message;
                statusDiv.className = `mt-1 text-${type}`;
                statusDiv.style.display = 'block';
            }
        }

        function clearContentBlockStatusMessage() {
            const statusDiv = document.getElementById('contentBlockStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Utility functions for Content Catalog Link/Description handling
        function isValidUrl(string) {
            if (!string) return false;
            try {
                new URL(string);
                return true;
            } catch (_) {
                // Check if it starts with http/https but might not be perfectly formatted
                return string.trim().toLowerCase().startsWith('http');
            }
        }

        function truncateText(text, maxLength) {
            if (!text) return 'N/A';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function setupTextareaAutoResize() {
            const textarea = document.getElementById('contentCatalogLink');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px'; // Max height 150px
                });
                
                // Initial resize
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            }
        }

        function updateStatusMessage(message, type) {
            const statusDiv = document.getElementById('mediaCatalogNameStatus');
            const messageSpan = document.getElementById('statusMessage');
            
            if (statusDiv && messageSpan) {
                messageSpan.textContent = message;
                statusDiv.style.display = 'block';
                
                // Update color based on type
                const smallElement = statusDiv.querySelector('small');
                smallElement.className = type === 'success' ? 'text-success' : 
                                       type === 'warning' ? 'text-warning' : 
                                       'text-info';
            }
        }

        function clearStatusMessage() {
            const statusDiv = document.getElementById('mediaCatalogNameStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        // Global utility functions
        function hideRecentRecordsSections() {
            const sections = document.querySelectorAll('.recent-records-section');
            sections.forEach(section => section.style.display = 'none');
        }

        function showRecentRecordsSections() {
            const sections = document.querySelectorAll('.recent-records-section');
            sections.forEach(section => section.style.display = 'block');
        }

        // Auto-activate tab based on server-side activeTab parameter
        document.addEventListener('DOMContentLoaded', function() {
            const activeTab = /*[[${activeTab}]]*/ 'dashboard';
            if (activeTab && activeTab !== 'dashboard') {
                showTab(activeTab);
            }
            
            // Ensure data is loaded for all tabs on initial page load
            loadInitialTabData();
            
            // Initialize upload edit form handler
            initializeUploadEditForm();
            
            // Initialize bulk upload form handler
            initializeBulkUploadForm();
            
            // Initialize upload form content block handling
            initializeUploadFormContentBlock();
        });
        
        function initializeUploadEditForm() {
            const editUploadForm = document.getElementById('editUploadForm');
            if (editUploadForm) {
                // Initialize form submission handler
                editUploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    
                    // Handle content block ID vs display value
                    const contentBlockInput = document.getElementById('editContentBlock');
                    if (contentBlockInput && contentBlockInput.hasAttribute('data-content-id')) {
                        formData.set('contentBlock', contentBlockInput.getAttribute('data-content-id'));
                    }
                    
                    const submitBtn = this.querySelector('button[type="submit"]');
                    
                    // Show loading state
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
                    }
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            // Close modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('editUploadModal'));
                            if (modal) modal.hide();
                            
                            // Refresh the upload records table
                            if (typeof refreshRecentUpload === 'function') {
                                refreshRecentUpload();
                            }
                            
                            // Show success notification
                            if (typeof showNotification === 'function') {
                                showNotification('Upload record updated successfully!', 'success');
                            } else {
                                alert('Upload record updated successfully!');
                            }
                        } else {
                            throw new Error('Failed to update upload record');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating upload record:', error);
                        if (typeof showNotification === 'function') {
                            showNotification('Error updating upload record', 'error');
                        } else {
                            alert('Error updating upload record');
                        }
                    })
                    .finally(() => {
                        // Restore button state
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Update Upload Record';
                        }
                    });
                });
                
                // Initialize dropdown functionality
                initializeEditModalDropdowns();
            }
        }
        
        function initializeEditModalDropdowns() {
            // Content Block dropdown functionality
            const contentBlockInput = document.getElementById('editContentBlock');
            const contentBlockDropdown = document.getElementById('editContentBlockDropdown');
            
            if (contentBlockInput && contentBlockDropdown) {
                let contentBlockTimeout;
                
                contentBlockInput.addEventListener('input', function() {
                    clearTimeout(contentBlockTimeout);
                    contentBlockTimeout = setTimeout(() => {
                        const searchTerm = this.value.trim();
                        if (searchTerm.length > 0) {
                            searchContentBlocks(searchTerm, contentBlockDropdown, contentBlockInput);
                        } else {
                            contentBlockDropdown.style.display = 'none';
                        }
                    }, 300);
                });
                
                contentBlockInput.addEventListener('focus', function() {
                    if (this.value.trim().length > 0) {
                        contentBlockDropdown.style.display = 'block';
                    }
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!contentBlockInput.contains(event.target) && !contentBlockDropdown.contains(event.target)) {
                        contentBlockDropdown.style.display = 'none';
                    }
                });
            }
            
            // Media Catalog Name dropdown functionality
            const mediaCatalogInput = document.getElementById('editMediaCatalogName');
            const mediaCatalogDropdown = document.getElementById('editMediaCatalogDropdown');
            
            if (mediaCatalogInput && mediaCatalogDropdown) {
                let mediaCatalogTimeout;
                
                mediaCatalogInput.addEventListener('input', function() {
                    clearTimeout(mediaCatalogTimeout);
                    mediaCatalogTimeout = setTimeout(() => {
                        const searchTerm = this.value.trim();
                        if (searchTerm.length > 0) {
                            searchMediaCatalog(searchTerm, mediaCatalogDropdown, mediaCatalogInput);
                        } else {
                            mediaCatalogDropdown.style.display = 'none';
                        }
                    }, 300);
                });
                
                mediaCatalogInput.addEventListener('focus', function() {
                    if (this.value.trim().length > 0) {
                        mediaCatalogDropdown.style.display = 'block';
                    }
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mediaCatalogInput.contains(event.target) && !mediaCatalogDropdown.contains(event.target)) {
                        mediaCatalogDropdown.style.display = 'none';
                    }
                });
            }
        }
        
        function searchContentBlocks(searchTerm, dropdown, input) {
            fetch(`/api/content-catalog/content-blocks?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    populateContentBlockDropdown(data, dropdown, input);
                })
                .catch(error => {
                    console.error('Error fetching content blocks:', error);
                    dropdown.style.display = 'none';
                });
        }
        
        function searchMediaCatalog(searchTerm, dropdown, input) {
            fetch(`/api/content-catalog/search?name=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    populateMediaCatalogDropdown(data, dropdown, input);
                })
                .catch(error => {
                    console.error('Error fetching media catalog:', error);
                    dropdown.style.display = 'none';
                });
        }
        
        function populateContentBlockDropdown(data, dropdown, input) {
            dropdown.innerHTML = '';
            
            if (data && data.length > 0) {
                data.slice(0, 10).forEach(item => {
                    const option = document.createElement('button');
                    option.className = 'dropdown-item';
                    option.type = 'button';
                    
                    // Show link in the display but truncate if too long
                    const displayLink = item.link ? (item.link.length > 50 ? item.link.substring(0, 50) + '...' : item.link) : 'No link';
                    
                    option.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${displayLink}</strong><br>
                                <small class="text-muted">ID: ${item.id} | ${item.mediaCatalogName || 'No name'}</small>
                            </div>
                            <small class="text-info">${item.mediaCatalogType || ''}</small>
                        </div>
                    `;
                    
                    option.addEventListener('click', function() {
                        // Display the link in the input field but store the ID as data attribute
                        input.value = item.link || item.id; // Show link, fallback to ID
                        input.setAttribute('data-content-id', item.id); // Store ID for backend
                        dropdown.style.display = 'none';
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item-text text-muted';
                noResults.textContent = 'No content blocks found';
                dropdown.appendChild(noResults);
                dropdown.style.display = 'block';
            }
        }
        
        function initializeUploadFormContentBlock() {
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    // Handle content block ID vs display value before submission
                    const contentBlockInput = document.getElementById('contentBlock');
                    if (contentBlockInput && contentBlockInput.hasAttribute('data-content-id')) {
                        contentBlockInput.value = contentBlockInput.getAttribute('data-content-id');
                    }
                    // Let the form submit normally
                });
            }
        }

        function initializeBulkUploadForm() {
            const bulkUploadForm = document.getElementById('bulkUploadForm');
            if (bulkUploadForm) {
                bulkUploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const fileInput = document.getElementById('bulkUploadFile');
                    const progressDiv = document.getElementById('uploadProgress');
                    const submitBtn = this.querySelector('button[type="submit"]');
                    
                    if (!fileInput.files.length) {
                        alert('Please select a file to upload');
                        return;
                    }
                    
                    // Show progress
                    progressDiv.style.display = 'block';
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                    
                    // Create FormData and submit
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.redirected) {
                            // Handle redirect (success or error messages will be shown on dashboard)
                            window.location.href = response.url;
                        } else {
                            throw new Error('Upload failed');
                        }
                    })
                    .catch(error => {
                        console.error('Bulk upload error:', error);
                        alert('Error during bulk upload. Please try again.');
                        
                        // Reset UI
                        progressDiv.style.display = 'none';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload & Process';
                    });
                });
            }
        }

        function populateMediaCatalogDropdown(data, dropdown, input) {
            dropdown.innerHTML = '';
            
            if (data && data.length > 0) {
                data.slice(0, 10).forEach(item => {
                    const option = document.createElement('button');
                    option.className = 'dropdown-item';
                    option.type = 'button';
                    option.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.mediaCatalogName}</strong><br>
                                <small class="text-muted">ID: ${item.id}</small>
                            </div>
                            <small class="text-info">${item.mediaCatalogType || ''}</small>
                        </div>
                    `;
                    
                    option.addEventListener('click', function() {
                        input.value = item.mediaCatalogName;
                        dropdown.style.display = 'none';
                    });
                    
                    dropdown.appendChild(option);
                });
                
                dropdown.style.display = 'block';
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'dropdown-item-text text-muted';
                noResults.textContent = 'No media catalog found';
                dropdown.appendChild(noResults);
                dropdown.style.display = 'block';
            }
        }

        function loadInitialTabData() {
            // Load data for all tabs that might be visible
            console.log('Loading initial tab data...');
            setTimeout(() => {
                if (typeof refreshRecentMedia === 'function') {
                    console.log('Calling refreshRecentMedia...');
                    refreshRecentMedia();
                }
                if (typeof refreshRecentContent === 'function') {
                    console.log('Calling refreshRecentContent...');
                    refreshRecentContent();
                }
                if (typeof refreshRecentUpload === 'function') {
                    console.log('Calling refreshRecentUpload...');
                    refreshRecentUpload();
                }
            }, 100);
            
            // Also try to force refresh after a longer delay if needed
            setTimeout(() => {
                // Check if tables are empty and retry if needed
                const uploadTableBody = document.getElementById('recentUploadRecords');
                const contentTableBody = document.querySelector('#content-status .recent-records-table tbody');
                
                if (uploadTableBody && !uploadTableBody.hasChildNodes()) {
                    console.log('Upload table is empty, retrying...');
                    refreshRecentUpload();
                }
                
                if (contentTableBody && !contentTableBody.hasChildNodes()) {
                    console.log('Content table is empty, retrying...');
                    refreshRecentContent();
                }
            }, 1000);
        }

        // ===== BULK UPLOAD FUNCTIONALITY =====
        
        function showBulkUploadModal(type) {
            const modal = document.getElementById('bulkUploadModal');
            const title = document.getElementById('bulkUploadModalTitle');
            const form = document.getElementById('bulkUploadForm');
            const templateButtons = document.getElementById('templateDownloadButtons');
            
            // Set modal title and form action based on type
            if (type === 'content') {
                title.textContent = 'Bulk Upload - Content Catalog';
                form.action = '/dashboard/bulk-upload/content-catalog';
                
                templateButtons.innerHTML = `
                    <a href="/dashboard/templates/content-catalog/csv" class="btn btn-outline-primary btn-sm mb-2">
                        <i class="fas fa-file-csv me-2"></i>Download CSV Template
                    </a>
                    <a href="/dashboard/templates/content-catalog/json" class="btn btn-outline-success btn-sm mb-2">
                        <i class="fas fa-file-code me-2"></i>Download JSON Template
                    </a>
                `;
            } else if (type === 'upload') {
                title.textContent = 'Bulk Upload - Upload Catalog';
                form.action = '/dashboard/bulk-upload/upload-catalog';
                
                templateButtons.innerHTML = `
                    <a href="/dashboard/templates/upload-catalog/csv" class="btn btn-outline-primary btn-sm mb-2">
                        <i class="fas fa-file-csv me-2"></i>Download CSV Template
                    </a>
                    <a href="/dashboard/templates/upload-catalog/json" class="btn btn-outline-success btn-sm mb-2">
                        <i class="fas fa-file-code me-2"></i>Download JSON Template
                    </a>
                `;
            } else if (type === 'media') {
                title.textContent = 'Bulk Upload - Media Catalog';
                form.action = '/dashboard/bulk-upload/media-catalog';
                
                templateButtons.innerHTML = `
                    <a href="/dashboard/templates/media-catalog/csv" class="btn btn-outline-primary btn-sm mb-2">
                        <i class="fas fa-file-csv me-2"></i>Download CSV Template
                    </a>
                    <a href="/dashboard/templates/media-catalog/json" class="btn btn-outline-success btn-sm mb-2">
                        <i class="fas fa-file-code me-2"></i>Download JSON Template
                    </a>
                `;
            }
            
            // Reset form
            form.reset();
            document.getElementById('uploadProgress').style.display = 'none';
            
            // Show modal
            const bulkUploadModal = new bootstrap.Modal(modal);
            bulkUploadModal.show();
        }
        
        function refreshUploadTable() {
            const refreshBtn = event.target.closest('button');
            const originalHtml = refreshBtn.innerHTML;
            
            // Show loading state
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
            refreshBtn.disabled = true;
            
            // Refresh the upload records
            if (typeof refreshRecentUpload === 'function') {
                refreshRecentUpload();
                
                // Show success feedback briefly
                setTimeout(() => {
                    refreshBtn.innerHTML = '<i class="fas fa-check me-2"></i>Refreshed!';
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalHtml;
                        refreshBtn.disabled = false;
                    }, 1000);
                }, 500);
            } else {
                // Show error feedback briefly
                refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHtml;
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }
        
        function refreshMediaTable() {
            const refreshBtn = event.target.closest('button');
            const originalHtml = refreshBtn.innerHTML;
            
            // Show loading state
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
            refreshBtn.disabled = true;
            
            // Refresh the media records
            if (typeof refreshRecentMedia === 'function') {
                refreshRecentMedia();
                
                // Show success feedback briefly
                setTimeout(() => {
                    refreshBtn.innerHTML = '<i class="fas fa-check me-2"></i>Refreshed!';
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalHtml;
                        refreshBtn.disabled = false;
                    }, 1000);
                }, 500);
            } else {
                // Show error feedback briefly
                refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHtml;
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }
        
        // ===== BULK DELETE FUNCTIONALITY =====
        
        function toggleAllSelections(catalogType) {
            const selectAllCheckbox = document.getElementById(`selectAll${catalogType.charAt(0).toUpperCase() + catalogType.slice(1)}`);
            const checkboxes = document.querySelectorAll(`.${catalogType}-checkbox`);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const mediaChecked = document.querySelectorAll('.media-checkbox:checked');
            const contentChecked = document.querySelectorAll('.content-checkbox:checked');
            const uploadChecked = document.querySelectorAll('.upload-checkbox:checked');
            
            const totalSelected = mediaChecked.length + contentChecked.length + uploadChecked.length;
            
            const bulkActionsContainer = document.getElementById('bulkActionsContainer');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedCount = document.getElementById('selectedCount');
            
            if (totalSelected > 0) {
                bulkActionsContainer.style.display = 'block';
                bulkDeleteBtn.disabled = false;
                selectedCount.textContent = totalSelected;
            } else {
                bulkActionsContainer.style.display = 'none';
                bulkDeleteBtn.disabled = true;
                selectedCount.textContent = '0';
            }
            
            // Update select all checkboxes state
            updateSelectAllCheckboxes();
        }
        
        function updateSelectAllCheckboxes() {
            // Media catalog
            const mediaCheckboxes = document.querySelectorAll('.media-checkbox');
            const mediaChecked = document.querySelectorAll('.media-checkbox:checked');
            const selectAllMedia = document.getElementById('selectAllMedia');
            if (selectAllMedia) {
                selectAllMedia.checked = mediaCheckboxes.length > 0 && mediaChecked.length === mediaCheckboxes.length;
                selectAllMedia.indeterminate = mediaChecked.length > 0 && mediaChecked.length < mediaCheckboxes.length;
            }
            
            // Content catalog
            const contentCheckboxes = document.querySelectorAll('.content-checkbox');
            const contentChecked = document.querySelectorAll('.content-checkbox:checked');
            const selectAllContent = document.getElementById('selectAllContent');
            if (selectAllContent) {
                selectAllContent.checked = contentCheckboxes.length > 0 && contentChecked.length === contentCheckboxes.length;
                selectAllContent.indeterminate = contentChecked.length > 0 && contentChecked.length < contentCheckboxes.length;
            }
            
            // Upload catalog
            const uploadCheckboxes = document.querySelectorAll('.upload-checkbox');
            const uploadChecked = document.querySelectorAll('.upload-checkbox:checked');
            const selectAllUpload = document.getElementById('selectAllUpload');
            if (selectAllUpload) {
                selectAllUpload.checked = uploadCheckboxes.length > 0 && uploadChecked.length === uploadCheckboxes.length;
                selectAllUpload.indeterminate = uploadChecked.length > 0 && uploadChecked.length < uploadCheckboxes.length;
            }
        }
        
        function clearAllSelections() {
            const allCheckboxes = document.querySelectorAll('.media-checkbox, .content-checkbox, .upload-checkbox');
            allCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            const selectAllCheckboxes = document.querySelectorAll('#selectAllMedia, #selectAllContent, #selectAllUpload');
            selectAllCheckboxes.forEach(checkbox => {
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.indeterminate = false;
                }
            });
            
            updateBulkActions();
        }
        
        function showBulkDeleteConfirmation() {
            const mediaChecked = document.querySelectorAll('.media-checkbox:checked');
            const contentChecked = document.querySelectorAll('.content-checkbox:checked');
            const uploadChecked = document.querySelectorAll('.upload-checkbox:checked');
            
            const selectedItems = {
                media: Array.from(mediaChecked).map(cb => cb.getAttribute('data-id')),
                content: Array.from(contentChecked).map(cb => cb.getAttribute('data-id')),
                upload: Array.from(uploadChecked).map(cb => cb.getAttribute('data-id'))
            };
            
            const totalCount = selectedItems.media.length + selectedItems.content.length + selectedItems.upload.length;
            
            const confirmMessage = `Are you sure you want to delete ${totalCount} selected records?\n\n` +
                `Media Catalog: ${selectedItems.media.length} records\n` +
                `Content Catalog: ${selectedItems.content.length} records\n` +
                `Upload Catalog: ${selectedItems.upload.length} records\n\n` +
                `This action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                performBulkDelete(selectedItems);
            }
        }
        
        function performBulkDelete(selectedItems) {
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const originalHtml = bulkDeleteBtn.innerHTML;
            bulkDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
            bulkDeleteBtn.disabled = true;
            
            const promises = [];
            
            // Delete media catalog items
            if (selectedItems.media.length > 0) {
                promises.push(
                    fetch('/api/media-catalog/bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(selectedItems.media)
                    })
                );
            }
            
            // Delete content catalog items
            if (selectedItems.content.length > 0) {
                promises.push(
                    fetch('/api/content-catalog/bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(selectedItems.content)
                    })
                );
            }
            
            // Delete upload catalog items
            if (selectedItems.upload.length > 0) {
                promises.push(
                    fetch('/api/upload-catalog/bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(selectedItems.upload)
                    })
                );
            }
            
            Promise.all(promises)
                .then(responses => {
                    const allSuccessful = responses.every(response => response.ok);
                    
                    if (allSuccessful) {
                        // Show success message
                        showAlert('Success', `Successfully deleted ${selectedItems.media.length + selectedItems.content.length + selectedItems.upload.length} records.`, 'success');
                        
                        // Refresh all tables
                        if (typeof refreshRecentMedia === 'function') refreshRecentMedia();
                        if (typeof refreshRecentContent === 'function') refreshRecentContent();
                        if (typeof refreshRecentUpload === 'function') refreshRecentUpload();
                        
                        // Clear selections
                        clearAllSelections();
                    } else {
                        showAlert('Error', 'Some records could not be deleted. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error during bulk delete:', error);
                    showAlert('Error', 'An error occurred while deleting records. Please try again.', 'error');
                })
                .finally(() => {
                    bulkDeleteBtn.innerHTML = originalHtml;
                    bulkDeleteBtn.disabled = false;
                });
        }
        
        function showAlert(title, message, type) {
            // Create and show a Bootstrap alert
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '9999';
            alertContainer.style.minWidth = '300px';
            
            alertContainer.innerHTML = `
                <strong>${title}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertContainer);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 5000);
        }
        
        // ===== DATABASE CLEANUP FUNCTIONALITY =====
        
        function showCleanupConfirmation() {
            const modal = new bootstrap.Modal(document.getElementById('cleanupConfirmationModal'));
            
            // Reset the form
            document.getElementById('confirmCleanup').checked = false;
            document.getElementById('confirmCleanupBtn').disabled = true;
            
            modal.show();
        }
        
        // Handle checkbox change for cleanup confirmation
        document.addEventListener('DOMContentLoaded', function() {
            const confirmCheckbox = document.getElementById('confirmCleanup');
            const confirmButton = document.getElementById('confirmCleanupBtn');
            
            if (confirmCheckbox && confirmButton) {
                confirmCheckbox.addEventListener('change', function() {
                    confirmButton.disabled = !this.checked;
                });
            }
            
            // Handle form submission with additional confirmation
            const cleanupForm = document.getElementById('cleanupForm');
            if (cleanupForm) {
                cleanupForm.addEventListener('submit', function(e) {
                    if (!document.getElementById('confirmCleanup').checked) {
                        e.preventDefault();
                        alert('Please confirm that you understand this action cannot be undone.');
                        return;
                    }
                    
                    // Final confirmation dialog
                    if (!confirm('Last chance! Are you absolutely sure you want to delete ALL database entries? This cannot be undone!')) {
                        e.preventDefault();
                        return;
                    }
                    
                    // Show processing state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cleaning...';
                    submitBtn.disabled = true;
                });
            }
        });

        // Safe refresh functions that don't interfere with forms
        function safeRefreshRecentContent() {
            const form = document.getElementById('contentCatalogForm');
            // Only refresh if form is not visible/active
            if (!form || form.style.display === 'none' || !form.style.display) {
                refreshRecentContent();
            }
        }

        function safeRefreshRecentMedia() {
            const form = document.getElementById('mediaCatalogForm');
            // Only refresh if form is not visible/active
            if (!form || form.style.display === 'none' || !form.style.display) {
                refreshRecentMedia();
            }
        }

        function safeRefreshRecentUpload() {
            const form = document.getElementById('uploadCatalogForm');
            // Only refresh if form is not visible/active
            if (!form || form.style.display === 'none' || !form.style.display) {
                refreshRecentUpload();
            }
        }

        // Helper function for external tab switching (used by dashboard.js)
        function showTab(tabId) {
            const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
            if (tabButton) {
                tabButton.click();
            }
        }

        // Make refresh functions globally available for dashboard.js
        window.refreshRecentMedia = refreshRecentMedia;
        window.refreshRecentContent = refreshRecentContent;
        window.refreshRecentUpload = refreshRecentUpload;
        window.showTab = showTab;
    </script>
</body>
</html>